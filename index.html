<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leuven Hide & Seek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #f3f4f6; }
        .card-jetlag { background: #2d2d2d; border-left: 4px solid #fbbf24; }
        .btn-primary { background-color: #fbbf24; color: #1a1a1a; font-weight: bold; }
        .btn-danger { background-color: #ef4444; color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="w-full max-w-md space-y-6 mt-10">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-yellow-400">LEUVEN<br>HIDE & SEEK</h1>
            <p class="text-gray-400">Multiplayer Lobby</p>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Jouw Naam</label>
                <input type="text" id="username" class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-yellow-400 outline-none" placeholder="Bijv. Sam">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Lobby Code</label>
                <input type="text" id="lobbycode" class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-yellow-400 outline-none uppercase" placeholder="Bijv. LEUVEN1">
            </div>
            <button onclick="joinLobby()" class="w-full btn-primary p-3 rounded-lg hover:bg-yellow-500 transition">
                JOIN GAME
            </button>
        </div>
    </div>

    <!-- ROLE SELECTION -->
    <div id="role-screen" class="hidden w-full max-w-md space-y-6 mt-10 text-center">
        <h2 class="text-2xl font-bold">Kies je Team</h2>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="selectRole('hider')" class="bg-gray-800 p-6 rounded-lg border-2 border-transparent hover:border-yellow-400 transition">
                <i class="fa-solid fa-user-secret text-4xl text-yellow-400 mb-2"></i>
                <div class="font-bold">HIDER</div>
            </button>
            <button onclick="selectRole('seeker')" class="bg-gray-800 p-6 rounded-lg border-2 border-transparent hover:border-blue-400 transition">
                <i class="fa-solid fa-binoculars text-4xl text-blue-400 mb-2"></i>
                <div class="font-bold">ZOEKER</div>
            </button>
        </div>
    </div>

    <!-- GAME DASHBOARD -->
    <div id="game-screen" class="hidden w-full max-w-lg space-y-4 pb-20">
        <!-- Header -->
        <div class="flex justify-between items-center bg-gray-800 p-3 rounded-lg sticky top-0 z-50 shadow-md">
            <div>
                <div class="text-xs text-gray-400">Lobby: <span id="display-lobby" class="font-mono text-white"></span></div>
                <div class="text-xs text-gray-400">Speler: <span id="display-user" class="font-bold text-yellow-400"></span></div>
            </div>
            <div id="role-badge" class="px-3 py-1 rounded font-bold text-xs"></div>
        </div>

        <!-- Notification Area -->
        <div id="notification-area" class="hidden bg-blue-600 text-white p-3 rounded text-center text-sm font-bold animate-pulse">
            Nieuwe update!
        </div>

        <!-- HIDER VIEW -->
        <div id="hider-view" class="hidden space-y-4">
            <!-- Hand -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-bold mb-2 flex justify-between">
                    Jouw Hand 
                    <span class="text-xs bg-gray-700 px-2 py-1 rounded"><span id="hand-count">0</span>/5</span>
                </h3>
                <div id="hider-hand" class="space-y-2">
                    <p class="text-gray-500 text-sm italic">Je hebt nog geen kaarten.</p>
                </div>
            </div>

            <!-- Draw Section -->
            <div id="draw-section" class="bg-gray-800 p-4 rounded-lg text-center">
                <h3 class="font-bold mb-2 text-yellow-400">Kaart Trekken</h3>
                <p class="text-xs text-gray-400 mb-3">Trek kaarten als je een vraag hebt beantwoord.</p>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="drawCards(1)" class="bg-gray-700 p-2 rounded hover:bg-gray-600 border border-gray-500">Trek 1</button>
                    <button onclick="drawCards(2)" class="bg-gray-700 p-2 rounded hover:bg-gray-600 border border-gray-500">Trek 2</button>
                    <button onclick="drawCards(3)" class="bg-gray-700 p-2 rounded hover:bg-gray-600 border border-gray-500">Trek 3</button>
                </div>
            </div>
        </div>

        <!-- SEEKER VIEW -->
        <div id="seeker-view" class="hidden space-y-4">
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-bold mb-4 text-blue-400">Beschikbare Vragen</h3>
                
                <!-- Filter Tabs -->
                <div class="flex space-x-2 mb-4">
                    <button onclick="filterQuestions(1)" class="flex-1 py-1 rounded bg-green-900 text-green-200 text-xs">Niveau 1</button>
                    <button onclick="filterQuestions(2)" class="flex-1 py-1 rounded bg-yellow-900 text-yellow-200 text-xs">Niveau 2</button>
                    <button onclick="filterQuestions(3)" class="flex-1 py-1 rounded bg-red-900 text-red-200 text-xs">Niveau 3</button>
                </div>

                <div id="questions-list" class="space-y-2 h-96 overflow-y-auto pr-1">
                    <!-- Vragen worden hier geladen -->
                </div>
            </div>
        </div>

        <!-- SHARED LOG -->
        <div class="bg-gray-800 p-4 rounded-lg">
            <h3 class="font-bold mb-2 text-gray-400 text-xs uppercase">Spel Logboek</h3>
            <div id="game-log" class="text-xs space-y-1 h-32 overflow-y-auto text-gray-300 font-mono">
                <!-- Logs -->
            </div>
        </div>
    </div>

    <!-- Modal for Card Selection -->
    <div id="card-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 w-full max-w-md rounded-lg p-4 space-y-4">
            <h3 class="text-xl font-bold text-center">Kies 1 Kaart</h3>
            <div id="modal-cards" class="space-y-2"></div>
            <button onclick="closeModal()" class="w-full py-2 text-gray-400">Annuleren</button>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        // We gebruiken de web-versies (URL imports) zodat dit werkt zonder build-step in de browser/Vercel
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- FIREBASE CONFIGURATIE (Jetlag Leuven) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCP1yVG3ssEyOub_F6P__90G1bM13kDaz0",
            authDomain: "jetlagleuven.firebaseapp.com",
            databaseURL: "https://jetlagleuven-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "jetlagleuven",
            storageBucket: "jetlagleuven.firebasestorage.app",
            messagingSenderId: "461047598360",
            appId: "1:461047598360:web:34dfbfa265e3004ceb626d"
        };
        // ----------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentLobby = null;
        let myRole = null;
        let allQuestions = [];
        let allCards = [];

        // --- CSV LOADING ---
        async function loadCSVData() {
            try {
                const qRes = await fetch('vragen.csv');
                const qText = await qRes.text();
                const qData = Papa.parse(qText, {header: true}).data;
                
                const cRes = await fetch('kaarten.csv');
                const cText = await cRes.text();
                const cData = Papa.parse(cText, {header: true}).data;

                return { questions: qData, cards: cData };
            } catch (e) {
                alert("Kan CSV niet laden. Zorg dat vragen.csv en kaarten.csv in de map staan.");
                return null;
            }
        }

        // --- AUTH & LOBBY ---
        window.joinLobby = async () => {
            const name = document.getElementById('username').value;
            const lobby = document.getElementById('lobbycode').value.toUpperCase();
            if(!name || !lobby) return alert("Vul naam en lobby in");

            await signInAnonymously(auth);
            currentUser = { uid: auth.currentUser.uid, name: name };
            currentLobby = lobby;

            document.getElementById('display-lobby').innerText = lobby;
            document.getElementById('display-user').innerText = name;

            // Check if lobby exists, if not, init with CSV data
            const lobbyRef = ref(db, `lobbies/${lobby}`);
            const snapshot = await get(lobbyRef);

            if (!snapshot.exists()) {
                const data = await loadCSVData();
                if(data) {
                    // Initialize clean game state
                    await set(lobbyRef, {
                        created: serverTimestamp(),
                        questions: data.questions.filter(q => q.id), // Clean empty rows
                        deck: data.cards.filter(c => c.id),
                        logs: { "init": { msg: "Lobby aangemaakt", time: Date.now() } }
                    });
                }
            }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('role-screen').classList.remove('hidden');
            
            // Start listening to data
            listenToGame();
        };

        window.selectRole = (role) => {
            myRole = role;
            document.getElementById('role-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            const badge = document.getElementById('role-badge');
            badge.innerText = role.toUpperCase();
            badge.className = `px-3 py-1 rounded font-bold text-xs ${role === 'hider' ? 'bg-yellow-500 text-black' : 'bg-blue-500 text-white'}`;

            if(role === 'hider') document.getElementById('hider-view').classList.remove('hidden');
            if(role === 'seeker') {
                document.getElementById('seeker-view').classList.remove('hidden');
                filterQuestions(1); // Default view
            }
        };

        // --- GAME SYNC ---
        function listenToGame() {
            const lobbyRef = ref(db, `lobbies/${currentLobby}`);
            onValue(lobbyRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) return;

                allQuestions = data.questions || [];
                allCards = data.deck || [];
                const logs = data.logs || {};

                updateUI(data);
                updateLogs(logs);
            });
        }

        function updateUI(data) {
            // Update Questions (Seeker View)
            if(myRole === 'seeker') {
                // Re-render current filter is handled by user click, but we refresh list if needed
                // For simplicity, we just keep current state or refresh active filter
                // We'll stick to manual refresh or just dynamic
                const activeBtn = document.querySelector('#seeker-view button:focus') || {innerText: "Niveau 1"}; 
                // Simple logic: If list is empty or updated, refresh based on last click? 
                // Let's just update the list based on current active filter logic
            }

            // Update Hand (Hider View)
            if(myRole === 'hider') {
                const myHand = allCards.filter(c => c.status === 'hand');
                document.getElementById('hand-count').innerText = myHand.length;
                
                const handContainer = document.getElementById('hider-hand');
                handContainer.innerHTML = "";
                
                if(myHand.length === 0) {
                    handContainer.innerHTML = '<p class="text-gray-500 text-sm italic">Je hebt nog geen kaarten.</p>';
                } else {
                    myHand.forEach(card => {
                        const div = document.createElement('div');
                        div.className = "card-jetlag p-3 rounded flex justify-between items-center";
                        div.innerHTML = `
                            <div>
                                <div class="font-bold text-sm text-yellow-400">${card.naam}</div>
                                <div class="text-xs text-gray-400">${card.effect}</div>
                                <div class="text-xs text-red-400 mt-1 italic">Taak: ${card.taak}</div>
                            </div>
                            <div class="flex flex-col space-y-1">
                                <button onclick="playCard('${card.id}')" class="bg-green-600 text-white text-xs px-2 py-1 rounded">Speel</button>
                                <button onclick="discardCard('${card.id}')" class="bg-red-600 text-white text-xs px-2 py-1 rounded">Weg</button>
                            </div>
                        `;
                        handContainer.appendChild(div);
                    });
                }
            }
        }

        // --- ACTIONS ---

        // Seeker Actions
        window.filterQuestions = (level) => {
            const list = document.getElementById('questions-list');
            list.innerHTML = "";
            
            // Only show unused questions
            const filtered = allQuestions.filter(q => q.niveau == level && !q.used);
            
            filtered.forEach(q => {
                const div = document.createElement('div');
                div.className = "bg-gray-700 p-3 rounded border border-gray-600 cursor-pointer hover:border-blue-400";
                div.onclick = () => askQuestion(q.id);
                div.innerHTML = `
                    <div class="text-sm font-bold text-gray-200">${q.vraag}</div>
                    <div class="flex justify-between mt-2 text-xs text-gray-400">
                        <span>${q.categorie}</span>
                        <span class="text-blue-300">Stel Vraag ></span>
                    </div>
                `;
                list.appendChild(div);
            });
        };

        window.askQuestion = (qid) => {
            if(!confirm("Wil je deze vraag stellen? Dit kan niet ongedaan gemaakt worden.")) return;
            
            // Find index
            const index = allQuestions.findIndex(q => q.id == qid);
            if(index === -1) return;

            // Update Firebase
            update(ref(db, `lobbies/${currentLobby}/questions/${index}`), { used: true });
            
            // Add Log
            push(ref(db, `lobbies/${currentLobby}/logs`), {
                msg: `${currentUser.name} stelde vraag: ${allQuestions[index].vraag}`,
                time: Date.now()
            });
        };

        // Hider Actions
        window.drawCards = (amount) => {
            // Check hand limit locally first
            const handCount = allCards.filter(c => c.status === 'hand').length;
            if(handCount >= 5) return alert("Je hand zit vol (Max 5)! Speel of gooi eerst kaarten weg.");

            // Get available deck
            const deck = allCards.filter(c => !c.status || c.status === 'deck'); // items without status are deck
            if(deck.length < amount) return alert("Kaarten zijn op!");

            // Random selection logic
            const selection = [];
            for(let i=0; i<amount; i++) {
                const r = Math.floor(Math.random() * deck.length);
                selection.push(deck[r]);
                deck.splice(r, 1); // prevent picking same
            }

            if(amount === 1) {
                // Auto add to hand
                addToHand(selection[0].id);
            } else {
                // Show modal to choose
                showSelectionModal(selection);
            }
        };

        function showSelectionModal(cards) {
            const modal = document.getElementById('card-modal');
            const container = document.getElementById('modal-cards');
            container.innerHTML = "";
            
            cards.forEach(c => {
                const div = document.createElement('div');
                div.className = "bg-gray-700 p-3 rounded border border-yellow-500 cursor-pointer hover:bg-gray-600";
                div.onclick = () => { addToHand(c.id); closeModal(); };
                div.innerHTML = `
                    <div class="font-bold text-yellow-400">${c.naam}</div>
                    <div class="text-xs text-white">${c.effect}</div>
                    <div class="text-xs text-gray-400 italic mt-1">${c.taak}</div>
                `;
                container.appendChild(div);
            });
            
            modal.classList.remove('hidden');
        }

        window.closeModal = () => document.getElementById('card-modal').classList.add('hidden');

        function addToHand(cid) {
            const index = allCards.findIndex(c => c.id == cid);
            update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'hand' });
            
            push(ref(db, `lobbies/${currentLobby}/logs`), {
                msg: `Hiders hebben een kaart getrokken.`,
                time: Date.now()
            });
        }

        window.playCard = (cid) => {
            if(!confirm("Wil je deze kaart spelen? Heb je de taak gedaan?")) return;
            const index = allCards.findIndex(c => c.id == cid);
            update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'played' });
            
            push(ref(db, `lobbies/${currentLobby}/logs`), {
                msg: `VLOEK GEACTIVEERD: ${allCards[index].naam}!`,
                time: Date.now()
            });
        };

        window.discardCard = (cid) => {
            if(!confirm("Wil je deze kaart weggooien?")) return;
            const index = allCards.findIndex(c => c.id == cid);
            update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'discarded' });
        };

        // Utilities
        function updateLogs(logsObj) {
            const logDiv = document.getElementById('game-log');
            logDiv.innerHTML = "";
            const entries = Object.values(logsObj).sort((a,b) => b.time - a.time);
            
            entries.forEach(l => {
                const date = new Date(l.time);
                const timeStr = `${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                logDiv.innerHTML += `<div class="border-b border-gray-700 pb-1 mb-1"><span class="text-gray-500">[${timeStr}]</span> ${l.msg}</div>`;
            });
        }

        // Attach to window for HTML onClick
        window.joinLobby = joinLobby;
        window.selectRole = selectRole;
        window.drawCards = drawCards;
        window.playCard = playCard;
        window.discardCard = discardCard;
        window.filterQuestions = filterQuestions;
        window.askQuestion = askQuestion;
        window.closeModal = closeModal;
    </script>
</body>
</html>