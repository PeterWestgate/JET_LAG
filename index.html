<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leuven Hunt - Risk & Reward</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #111827; color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* UI Components */
        .card-base { background: #1f2937; border: 1px solid #374151; border-radius: 12px; overflow: hidden; }
        .btn-primary { background-color: #eab308; color: #000; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; box-shadow: 0 4px 6px -1px rgba(234, 179, 8, 0.2); }
        .btn-primary:active { transform: scale(0.98); }
        
        /* Categorie Header */
        .cat-header { 
            background: #374151; color: #fbbf24; 
            font-size: 0.7rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;
            padding: 8px 12px; border-radius: 6px; margin-top: 16px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 8px; border-left: 4px solid #fbbf24;
        }

        /* Animaties */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .curse-mode { animation: pulse-red 2s infinite; border: 2px solid #ef4444; }
        
        /* Disabled state */
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="view-login" class="flex-1 flex flex-col items-center justify-center p-6 space-y-6 z-50 bg-gray-900 absolute inset-0">
        <div class="text-center animate-bounce">
            <i class="fa-solid fa-map-location-dot text-6xl text-yellow-400"></i>
        </div>
        <div class="text-center mb-4">
            <h1 class="text-5xl font-black text-white tracking-tighter leading-none">LEUVEN<br><span class="text-yellow-400">HUNT</span></h1>
        </div>
        <div class="w-full max-w-sm space-y-4">
            <input type="text" id="inp-name" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 text-white font-bold outline-none" placeholder="Jouw Naam">
            <input type="text" id="inp-lobby" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 text-white font-bold uppercase tracking-widest outline-none" placeholder="LOBBY CODE">
            <div class="bg-gray-800 p-2 rounded-xl border border-gray-700">
                <label class="text-[10px] uppercase text-gray-500 font-bold ml-2">Spelduur</label>
                <select id="inp-duration" class="w-full bg-transparent text-white font-bold p-2 outline-none">
                    <option value="60">1 Uur</option>
                    <option value="90" selected>1.5 Uur</option>
                    <option value="120">2 Uur</option>
                </select>
            </div>
            <button onclick="app.join()" id="btn-join" class="w-full btn-primary p-4 rounded-xl text-lg hover:bg-yellow-300">START SPEL</button>
        </div>
    </div>

    <div id="view-role" class="hidden flex-1 flex flex-col items-center justify-center p-6 space-y-6 z-40 bg-gray-900 absolute inset-0">
        <h2 class="text-2xl font-bold text-white uppercase">Kies je Team</h2>
        <div class="grid grid-cols-2 gap-4 w-full max-w-md">
            <button onclick="app.setRole('hider')" class="bg-gray-800 p-6 rounded-2xl border-2 border-gray-700 hover:border-yellow-400 flex flex-col items-center gap-3">
                <i class="fa-solid fa-user-secret text-5xl text-gray-400"></i>
                <div class="font-black text-xl text-white">HIDERS</div>
            </button>
            <button onclick="app.setRole('seeker')" class="bg-gray-800 p-6 rounded-2xl border-2 border-gray-700 hover:border-blue-400 flex flex-col items-center gap-3">
                <i class="fa-solid fa-binoculars text-5xl text-gray-400"></i>
                <div class="font-black text-xl text-white">ZOEKERS</div>
            </button>
        </div>
    </div>

    <div id="view-game" class="hidden flex-1 flex flex-col w-full max-w-lg mx-auto relative bg-gray-900 h-full">
        <div class="bg-gray-800 p-2 shadow-lg z-30 flex flex-col gap-2 border-b border-gray-700">
            <div class="flex justify-between items-center px-1">
                <div>
                    <div class="text-[10px] font-bold text-gray-500 uppercase">Lobby: <span id="lbl-lobby" class="text-white">...</span></div>
                    <div class="text-sm font-bold text-white" id="lbl-user">...</div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="text-[9px] text-gray-400 uppercase tracking-widest" id="lbl-timer-title">TIJD</div>
                    <div id="main-timer" class="font-mono text-2xl font-black text-white leading-none">--:--</div>
                </div>
                <div class="flex flex-col items-end">
                    <div class="text-[9px] text-red-400 uppercase font-bold tracking-widest">SCORE</div>
                    <div class="text-xl font-black text-red-500 leading-none" id="score-display">-0</div>
                </div>
            </div>
            
            <div id="status-bar" class="hidden w-full bg-blue-900/50 border border-blue-500/30 rounded px-2 py-1 flex justify-between items-center">
                <span id="status-text" class="text-[10px] font-bold text-blue-200 uppercase animate-pulse">Wachten...</span>
                <span id="answer-timer" class="font-mono text-xs font-bold text-white">03:00</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 hide-scrollbar pb-24 relative" id="main-content">
            <div id="hiding-phase-panel" class="hidden text-center p-6 border-2 border-dashed border-gray-600 rounded-2xl bg-gray-800/50">
                <i class="fa-solid fa-person-running text-4xl text-gray-400 mb-2"></i>
                <h3 class="text-xl font-bold text-white">VERSTOPTIJD</h3>
                <div id="hider-start-btn-container" class="mt-4">
                    <button onclick="app.startHiding()" class="bg-yellow-500 text-black font-black py-3 px-6 rounded-xl shadow-lg">START VERSTOPTIJD (15m)</button>
                </div>
                <div id="hiding-timer-container" class="hidden mt-4">
                    <div class="text-4xl font-mono font-black text-yellow-400 mb-4" id="hiding-timer">15:00</div>
                    <button onclick="app.stopHidingEarly()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg w-full mb-2">
                        WIJ ZIJN KLAAR (START SPEL)
                    </button>
                    <p class="text-xs text-gray-500">Klik hierop om de zoektijd direct te starten.</p>
                </div>
            </div>

            <div id="seeker-panel" class="hidden space-y-4">
                <div id="seeker-wait-msg" class="hidden bg-blue-900/20 border border-blue-500/50 p-3 rounded-lg text-center mb-2">
                    <i class="fa-solid fa-spinner fa-spin text-blue-400 text-xl mb-1"></i>
                    <p class="text-xs text-blue-200">Wacht tot Hiders geantwoord hebben.</p>
                </div>
                <div class="grid grid-cols-3 gap-1 bg-gray-800 p-1 rounded-xl sticky top-0 z-10 shadow-lg border border-gray-700">
                    <button onclick="app.renderQuestions(1)" id="btn-lvl-1" class="py-3 rounded-lg text-xs font-bold uppercase">Niveau 1</button>
                    <button onclick="app.renderQuestions(2)" id="btn-lvl-2" class="py-3 rounded-lg text-xs font-bold uppercase">Niveau 2</button>
                    <button onclick="app.renderQuestions(3)" id="btn-lvl-3" class="py-3 rounded-lg text-xs font-bold uppercase">Niveau 3</button>
                </div>
                <div id="question-list-container" class="space-y-2 pb-10"></div>
            </div>

            <div id="hider-panel" class="hidden card-base p-6 border-blue-500 border-2 bg-gradient-to-br from-blue-900/50 to-gray-800 text-center space-y-4 animate-pulse">
                <h3 id="hp-question" class="text-xl font-bold text-white leading-tight">...</h3>
                <div class="text-xs text-blue-300 font-mono">Trek <span id="hp-reward">...</span> kaarten en bewaar 1 in je hand</div>
                <button onclick="app.hiderConfirmAnswer()" class="w-full bg-white text-blue-900 font-black p-4 rounded-xl shadow-lg">BEVESTIG & TREK KAARTEN</button>
            </div>

            <div id="hider-hand-wrapper" class="hidden">
                <div class="flex justify-between items-end mb-2 px-1 border-b border-gray-700 pb-2">
                    <h3 class="text-sm font-bold text-gray-400 uppercase">Jouw Hand</h3>
                    <span class="text-xs font-mono bg-gray-800 text-gray-300 px-2 py-1 rounded border border-gray-600"><span id="lbl-hand-count">0</span>/6</span>
                </div>
                <div class="text-[10px] text-gray-500 italic mb-2 px-1">Tijdskaarten: Bewaar om "betalende" vloeken op te lossen.</div>
                <div id="hand-list" class="space-y-3"></div>
            </div>

            <div class="card-base p-4 mt-8">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest border-b border-gray-700 pb-1">Tijdlijn</h3>
                <div id="log-list" class="text-xs space-y-2 text-gray-400 font-mono h-32 overflow-y-auto flex flex-col-reverse"></div>
            </div>
        </div>

        <div id="overlay-curse" class="hidden absolute inset-0 bg-red-950/98 z-50 flex flex-col items-center justify-center p-6 text-center backdrop-blur overflow-y-auto">
            <i class="fa-solid fa-triangle-exclamation text-6xl text-red-500 mb-6 animate-pulse"></i>
            <h2 class="text-4xl font-black text-white mb-2 uppercase tracking-tighter">VLOEK ACTIEF!</h2>
            <div id="active-curses-container" class="w-full space-y-4 max-w-sm mt-4"></div>
        </div>

        <div id="overlay-bonus" class="hidden absolute inset-0 bg-yellow-900/95 z-[55] flex flex-col items-center justify-center p-6 text-center backdrop-blur">
            <i class="fa-solid fa-star text-6xl text-yellow-400 mb-6 animate-bounce"></i>
            <h2 class="text-3xl font-black text-white mb-2 uppercase tracking-tighter">BONUS GESPEELD!</h2>
            <div id="bonus-content" class="bg-gray-800 p-4 rounded-xl border border-yellow-500 w-full max-w-sm mb-6">
                <h3 id="bonus-title" class="font-bold text-yellow-400 text-xl">...</h3>
                <p id="bonus-desc" class="text-gray-300 text-sm">...</p>
            </div>
            <button onclick="app.clearBonus()" class="bg-white text-yellow-900 font-black py-4 px-8 rounded-xl shadow-lg w-full max-w-xs">
                OK, BEGREPEN
            </button>
        </div>
    </div>

    <div id="modal-pick" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl p-6 border border-yellow-500 flex flex-col shadow-2xl">
            <h3 class="text-center font-bold text-yellow-400 text-xl mb-1">KIES 1 KAART</h3>
            <p class="text-center text-gray-400 text-xs mb-4">De andere kaarten worden weggegooid.</p>
            <div id="pick-list" class="space-y-3 overflow-y-auto flex-1 pr-1 mt-2"></div>
        </div>
    </div>

    <div id="modal-discard" class="hidden fixed inset-0 bg-black/95 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-md rounded-2xl p-6 border-2 border-red-500 flex flex-col">
            <h3 class="text-xl font-black text-white text-center mb-4">HAND VOL! (6/6)</h3>
            <div class="text-[10px] uppercase font-bold text-green-400 mb-2">Nieuw:</div>
            <div id="discard-new-list" class="space-y-2 mb-4"></div>
            <div class="text-[10px] uppercase font-bold text-blue-400 mb-2">Of gooi weg uit hand:</div>
            <div id="discard-hand-list" class="space-y-2 overflow-y-auto flex-1 pr-1"></div>
            <button onclick="app.discardNewCard()" class="mt-4 w-full py-3 bg-gray-700 rounded-lg text-gray-300 text-xs font-bold">Annuleren (Nieuwe kaart weggooien)</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCP1yVG3ssEyOub_F6P__90G1bM13kDaz0",
            authDomain: "jetlagleuven.firebaseapp.com",
            databaseURL: "https://jetlagleuven-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "jetlagleuven",
            storageBucket: "jetlagleuven.firebasestorage.app",
            messagingSenderId: "461047598360",
            appId: "1:461047598360:web:34dfbfa265e3004ceb626d"
        };

        const appInit = initializeApp(firebaseConfig);
        const db = getDatabase(appInit);
        const auth = getAuth(appInit);

        const DATA = {
            questions: [
                // --- NIVEAU 1: LOCATIE (BREED) ---
                {id: 1, niveau: 1, categorie: "Locatie", vraag: "Bevindt je verstopplek zich op een verharde ondergrond? (Ja/Nee)"},
                {id: 2, niveau: 1, categorie: "Locatie", vraag: "Ben je bij (max 20m verwijderd van) een van de 4 hoofdstraten (Naamse, Tienste, Diestse, Mechelse straat)? (Ja/Nee)"},
                {id: 3, niveau: 1, categorie: "Locatie", vraag: "Ben je links van de Dijle? (Ja/Nee)"},
                {id: 4, niveau: 1, categorie: "Locatie", vraag: "Ben je momenteel in een park of groene zone? (Ja/Nee)"},
                {id: 5, niveau: 1, categorie: "Locatie", vraag: "Ben je momenteel in de westelijke helft (Verticale lijn door de Sint Pieterskerk) van het spelgebied? (Ja/Nee)"},
                {id: 6, niveau: 1, categorie: "Locatie", vraag: "Is je verstopplek binnen 150m van de een kerk? (Ja/Nee)"},
                {id: 7, niveau: 1, categorie: "Locatie", vraag: "Is je verstopplek dichter bij het Klein Begijnhof dan het Groot Begijnhof? (Ja/Nee)"},
                {id: 8, niveau: 1, categorie: "Locatie", vraag: "Is je verstopplek MEER dan 500m verwijderd van het startpunt (Grote Markt)? (Ja/Nee)"},
                {id: 9, niveau: 1, categorie: "Locatie", vraag: "Bevindt je verstopplek zich binnen een voetgangersgebied? (Ja/Nee)"},
                {id: 10, niveau: 1, categorie: "Locatie", vraag: "Kun je vanaf je huidige positie (zonder te verplaatsen) een torenklok zien? (Ja/Nee)"},
                {id: 11, niveau: 1, categorie: "Locatie", vraag: "Sta je in een straat waar bussen van De Lijn mogen rijden? (Ja/Nee)"},
                {id: 12, niveau: 1, categorie: "Locatie", vraag: "Bevindt je verstopplek zich op een locatie die 's nachts wordt afgesloten (bv. park, begijnhof)? (Ja/Nee)"},
                {id: 13, niveau: 1, categorie: "Locatie", vraag: "Is de straat waar je bent een eenrichtingsweg voor auto's? (Ja/Nee, of NVT)"},

                // --- NIVEAU 2: OMGEVING (SPECIFIEK) ---
                {id: 14, niveau: 2, categorie: "Omgeving", vraag: "Bevindt je verstopplek zich in het gebied gekend als de Vaartkom? (Ja/Nee)"},
                {id: 15, niveau: 2, categorie: "Omgeving", vraag: "Bevindt je verstopplek zich op een campus/schoolomgeving van de universiteit? (Ja/Nee)"},
                {id: 16, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek binnen 100m van de Dijle? (Ja/Nee)"},
                {id: 17, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek binnen 100m van een bakker? (Ja/Nee)"},
                {id: 18, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek binnen 250m van de Grote Markt? (Ja/Nee)"},
                {id: 19, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek binnen 250m van de Hoorn? (Ja/Nee)"},
                {id: 20, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek binnen 250m van Station Leuven? (Ja/Nee)"},
                {id: 21, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek binnen 250m van de Universiteitsbibliotheek KU Leuven? (Ja/Nee)"},
                {id: 22, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek binnen 250m van het Groot Begijnhof? (Ja/Nee)"},
                {id: 23, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek dichter bij de Kruidtuin dan bij de Oude Markt? (Ja/Nee)"},
                {id: 24, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek binnen 200m van het Ladeuzeplein (De Kever/Totem)? (Ja/Nee)"},
                {id: 25, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek binnen 50m van een supermarkt? (Ja/Nee)"},
                {id: 26, niveau: 2, categorie: "Omgeving", vraag: "Is je verstopplek dichter bij standbeeld 'Fonske' dan bij standbeeld 'De Kotmadam'? (Ja/Nee)"},
                {id: 27, niveau: 2, categorie: "Omgeving", vraag: "Bevindt je verstopplek zich binnen 200m van een historische stadspoort? (Ja/Nee)"},
                {id: 28, niveau: 2, categorie: "Omgeving", vraag: "Is er binnen 50m van je verstopplek een plek waar je frietjes kunt kopen? (Ja/Nee)"},

                // --- NIVEAU 3: VISUEEL (RISICO/CONFIRMATIE) ---
                {id: 29, niveau: 3, categorie: "Visueel", vraag: "Bevindt je verstopplek zich op een locatie met kasseien in de directe omgeving (binnen 10m)? (Ja/Nee)"},
                {id: 30, niveau: 3, categorie: "Visueel", vraag: "Kan je vanuit jouw verstopplek een café zien? (Ja/Nee)"},
                {id: 31, niveau: 3, categorie: "Visueel", vraag: "Kun je vanaf je verstopplek een bus zien langskomen? (Ja/Nee)"},
                {id: 32, niveau: 3, categorie: "Visueel", vraag: "Is de dichtstbijzijnde publiek toegankelijke gebouw bij je verstopplek een kerk? (Ja/Nee)"},
                {id: 33, niveau: 3, categorie: "Visueel", vraag: "Is de dichtstbijzijnde publiek toegankelijke gebouw bij je verstopplek een winkel? (Ja/Nee)"},
                {id: 34, niveau: 3, categorie: "Visueel", vraag: "Is je verstopplek in het zicht van bomen? (Ja/Nee)"},
                {id: 35, niveau: 3, categorie: "Visueel", vraag: "Is je verstopplek in het zicht van water? (Ja/Nee)"},
                {id: 36, niveau: 3, categorie: "Visueel", vraag: "Zijn er mensen die jouw verstopplek passeren (minimaal 1 per minuut)? (Ja/Nee)"},
                {id: 37, niveau: 3, categorie: "Visueel", vraag: "Sta je op of binnen 5 meter van een riooldeksel of putdeksel? (Ja/Nee)"},
                {id: 38, niveau: 3, categorie: "Visueel", vraag: "Is er een bewakingscamera zichtbaar vanaf je verstopplek? (Ja/Nee)"},
                {id: 39, niveau: 3, categorie: "Visueel", vraag: "Staan er geparkeerde fietsen (in een rek of los) binnen 10 meter van je? (Ja/Nee)"},
                {id: 40, niveau: 3, categorie: "Visueel", vraag: "Zitten jullie vooral op jullie verstopplek (op een bankje, muurtje of de grond)? (Ja/Nee)"},
                {id: 41, niveau: 3, categorie: "Visueel", vraag: "Zie je op dit moment een nummerbord (auto of brommer)? (Ja/Nee)"},

                // --- NIVEAU 2: FOTO (BEWIJS) ---
                {id: 42, niveau: 2, categorie: "Foto", vraag: "Neem een audio opname van 10 seconden op van de omgevingsgeluiden op je verstopplek."},
                {id: 43, niveau: 2, categorie: "Foto", vraag: "Stuur een foto van een object (groter dan 1x1x1m) in de directe omgeving van je verstopplek (zonder herkenbare achtergrond)."},
                {id: 44, niveau: 2, categorie: "Foto", vraag: "Stuur een foto van een straatnaambord met de muur waarop het zich bevindt (TEKST MAG NIET ZICHTBAAR ZIJN , edit de tekst weg)."},
                {id: 45, niveau: 2, categorie: "Foto", vraag: "Stuur een foto van je voeten (of fietswielen) op de grond van je verstopplek."},
                {id: 46, niveau: 2, categorie: "Foto", vraag: "Stuur een foto van jullie verstopplek met iets roods op de voorgrond dat geen deel uitmaakt van jullie kleding."},
                {id: 47, niveau: 2, categorie: "Foto", vraag: "Stuur een foto van het dichtstbijzijnde verkeersbord vanaf jullie verstopplek (tekst onleesbaar maken)."},
                {id: 48, niveau: 2, categorie: "Foto", vraag: "Stuur een foto van een object dat hoger is dan jullie en zichtbaar is vanaf jullie verstopplek (bv. lantaarnpaal)."},
                {id: 49, niveau: 2, categorie: "Foto", vraag: "Maak een close up foto van de textuur van de grond waar je op staat."},
                {id: 50, niveau: 2, categorie: "Foto", vraag: "Maak een foto recht omhoog naar de lucht (daklijnen/bomen/lucht)."},
                {id: 51, niveau: 2, categorie: "Foto", vraag: "Stuur een foto van een huisnummer in je buurt, maar zoom zo ver in dat de gevel niet herkenbaar is."},
                {id: 52, niveau: 2, categorie: "Foto", vraag: "Maak een selfie waarbij de achtergrond volledig wazig is of jullie silhouetten zijn (tegenlicht)."},
                {id: 53, niveau: 2, categorie: "Foto", vraag: "Vind een stukje zwerfval (blikje, papiertje) en stuur er een foto van op je huidige locatie."}
            ],
            deck: [
                // --- TIJD KAARTEN (BETAALMIDDEL) ---
                {id: 100, type: "Tijd", val: 5, naam: "Bonus 5 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},
                {id: 101, type: "Tijd", val: 10, naam: "Bonus 10 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},
                {id: 102, type: "Tijd", val: 15, naam: "Bonus 15 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},
                {id: 103, type: "Tijd", val: 5, naam: "Bonus 5 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},
                {id: 104, type: "Tijd", val: 5, naam: "Bonus 5 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},
                {id: 105, type: "Tijd", val: 5, naam: "Bonus 5 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},
                {id: 106, type: "Tijd", val: 10, naam: "Bonus 10 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},
                {id: 107, type: "Tijd", val: 10, naam: "Bonus 10 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},
                {id: 108, type: "Tijd", val: 15, naam: "Bonus 15 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},
                {id: 109, type: "Tijd", val: 30, naam: "Bonus 30 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},
                {id: 110, type: "Tijd", val: 15, naam: "Bonus 15 min", effect: "Bewaar in je hand als krediet voor vloeken.", taak: "Geen taak"},

                // --- VLOEKEN (ACTIE VEREIST) ---
                {id: 111, type: "Vloek", naam: "Alleen Fietsen (15 min)", effect: "Gedurende de komende 15 minuten moeten de zoekers fietsen.", taak: "Sta 3 minuten rug aan rug met ogen dicht."},
                {id: 112, type: "Vloek", naam: "Alleen Lopen (15 min)", effect: "Gedurende de komende 15 minuten mogen de zoekers alleen lopen.", taak: "Zing 1 minuut lang hardop een liedje."},
                {id: 113, type: "Vloek", naam: "Brug Tol", effect: "Zoekers moeten binnen 5 min een andere brug oversteken dan hun laatste.", taak: "Houd 30 seconden een 'brug' positie aan (plank)."},
                {id: 114, type: "Vloek", naam: "Eenwieler", effect: "Elke zoeker moet 30 sec eenwieler rijden nadoen op straat (filmen).", taak: "Sta 1 minuut op één been."},
                {id: 115, type: "Vloek", naam: "Geen Kaart! (10 min)", effect: "Zoekers mogen geen kaart bekijken. Navigatie uit het hoofd.", taak: "Houd gezamenlijk 100 seconden de adem in."},
                {id: 116, type: "Vloek", naam: "Omweg Oude Markt", effect: "Zoekers moeten direct naar de Oude Markt reizen.", taak: "Stuur een foto van een object dat begint met 'O'."},
                {id: 117, type: "Vloek", naam: "Oriëntatie (10 min)", effect: "Zoekers moeten navigeren zonder telefoon te gebruiken.", taak: "Draai 1 minuut langzaam rondjes op je plek."},
                {id: 118, type: "Vloek", naam: "Selfie met Onbekende", effect: "Zoekers moeten binnen 10 min een selfie maken met een onbekende.", taak: "Trek 1 minuut een gek gezicht en film het."},
                {id: 119, type: "Vloek", naam: "Tijdelijke Afleiding", effect: "Hiders bellen zoekers 1 minuut, zoekers moeten stilstaan.", taak: "Verkoop telefonisch een product zonder 'uhm' te zeggen."},
                {id: 120, type: "Vloek", naam: "Veter Foltering", effect: "Eén zoeker moet veters losmaken en opnieuw strikken.", taak: "Wees 2 minuten volledig stil."},
                {id: 121, type: "Vloek", naam: "Vind Straatkunst", effect: "Zoekers moeten binnen 10 min straatkunst vinden en foto sturen.", taak: "Bedenk een raadsel over je verstopplek."},
                {id: 122, type: "Vloek", naam: "Verkeerde Afslag!", effect: "Zoekers moeten direct 200m teruglopen.", taak: "Loop 3 minuten achteruit in een cirkel."},
                {id: 123, type: "Vloek", naam: "Zing een Lied", effect: "Zoekers moeten een lied over Leuven zingen.", taak: "Maak 1 minuut lang dierengeluiden."},
                {id: 124, type: "Vloek", naam: "Zoeker Afleiden", effect: "Zoekers moeten de Macarena dansen.", taak: "Maak 1 minuut overdreven dansbewegingen."},
                {id: 125, type: "Vloek", naam: "Zoeker Vertraging", effect: "Zoekers moeten 2 minuten stilstaan.", taak: "Doe 1 minuut de maanlanding in slow motion na."},
                {id: 126, type: "Vloek", naam: "De Toerist", effect: "Zoekers moeten bij elk kruispunt 5 sec naar gebouwen wijzen.", taak: "Doe 1 minuut lang alsof je een standbeeld bent."},
                {id: 127, type: "Vloek", naam: "De Drieling", effect: "Zoekers moeten elkaars hand vasthouden (10 min).", taak: "Knuffel elkaar 1 minuut lang."},
                {id: 128, type: "Vloek", naam: "De Kotmadam", effect: "Zoekers mogen 5 min niet praten, enkel zuchten.", taak: "Stuur audio waarin je 30 sec klaagt over de jeugd."},
                {id: 129, type: "Vloek", naam: "Achteruitkijkspiegel", effect: "Zoekers moeten 50m achteruit lopen.", taak: "Zeg het alfabet achterstevoren op (film)."},
                {id: 130, type: "Vloek", naam: "De VIP", effect: "Eén zoeker is VIP, anderen moeten continu 'Aan de kant!' roepen.", taak: "Buig 10 keer diep voor een onzichtbare koning."},
                {id: 131, type: "Vloek", naam: "Rood Licht", effect: "Bij elke rode auto moeten zoekers 10 sec stilstaan.", taak: "Stuur foto van benen in de lucht."},
                {id: 132, type: "Vloek", naam: "De Piraat", effect: "Eén zoeker moet 10 min één oog dichthouden.", taak: "Maak een piraten 'Arrr!' audiobericht."},
                {id: 133, type: "Vloek", naam: "Vloer is Lava", effect: "Zoekers mogen 5 min niet op lijnen/voegen stappen.", taak: "Sta 2 minuten op één been."},
                {id: 134, type: "Vloek", naam: "De Paparazzi", effect: "Zoekers moeten selfie maken met standbeeld.", taak: "Doe een fotoshoot (3 modelposes)."},
                {id: 135, type: "Vloek", naam: "Linke Boel", effect: "Zoekers mogen 5 min alleen linksaf slaan.", taak: "Schud 1 minuut nee met je hoofd."},
                {id: 136, type: "Vloek", naam: "De Verteller", effect: "Zoekers moeten 3 min alles hardop beschrijven wat ze zien.", taak: "Verzin een gedicht van 4 regels over Leuven."},
                {id: 137, type: "Vloek", naam: "High Five", effect: "Zoekers moeten een vreemde high-fiven.", taak: "Applaudisseer 1 minuut voor jezelf."},

                // --- VLOEK-TIJD (KOST TIJD KAARTEN) ---
                {id: 138, type: "Vloek-Tijd", req: 15, naam: "Pad Blokkeren", effect: "Blokkeer een straat voor 20 min.", taak: "Gooi 15 min aan tijdkaarten weg."},
                {id: 139, type: "Vloek-Tijd", req: 15, naam: "Stille Zone", effect: "Zoekers mogen 15 min niet praten.", taak: "Gooi 15 min aan tijdkaarten weg."},
                {id: 140, type: "Vloek-Tijd", req: 10, naam: "Vast bij Rood", effect: "Zoekers mogen alleen voetgangersstraten gebruiken (15 min).", taak: "Gooi 10 min aan tijdkaarten weg."},
                {id: 141, type: "Vloek-Tijd", req: 10, naam: "Vraag Omleiding", effect: "Hiders negeren de huidige vraag.", taak: "Gooi 10 min aan tijdkaarten weg."},
                {id: 142, type: "Vloek-Tijd", req: 10, naam: "Zoeker Verwarring", effect: "Stuur zoekers 5 min in willekeurige richting.", taak: "Gooi 10 min aan tijdkaarten weg."},
                {id: 143, type: "Vloek-Tijd", req: 15, naam: "De Friet Stop", effect: "Zoekers moeten stoppen en iets kopen/eten.", taak: "Gooi 15 min aan tijdkaarten weg."},
                {id: 144, type: "Vloek-Tijd", req: 10, naam: "Batterij Leeg", effect: "Zoekers telefoon op vliegtuigstand (5 min).", taak: "Gooi 10 min aan tijdkaarten weg."},
                {id: 145, type: "Vloek-Tijd", req: 20, naam: "De Busrit", effect: "Zoekers moeten bus nemen voor 1 halte.", taak: "Gooi 20 min aan tijdkaarten weg."},
                {id: 146, type: "Vloek-Tijd", req: 10, naam: "Schoenveter Sabotage", effect: "Zoekers: schoenen uit, 10m lopen, schoenen aan.", taak: "Gooi 10 min aan tijdkaarten weg."},
                {id: 147, type: "Vloek-Tijd", req: 15, naam: "Grote Markt Reset", effect: "Zoekers moeten terug naar Grote Markt.", taak: "Gooi 15 min aan tijdkaarten weg."},
                {id: 148, type: "Vloek-Tijd", req: 5, naam: "Stiltecoupé", effect: "Zoekers: 15 min niet praten.", taak: "Gooi 5 min aan tijdkaarten weg."},
                {id: 149, type: "Vloek-Tijd", req: 10, naam: "De Paranoia", effect: "Hiders eisen locatie foto van zoekers.", taak: "Gooi 10 min aan tijdkaarten weg."},
                {id: 150, type: "Vloek-Tijd", req: 5, naam: "Trappenloper", effect: "Zoekers moeten 5x trap op en af.", taak: "Gooi 5 min aan tijdkaarten weg."},

                // --- BONUSSEN (VOORDEEL HIDERS) ---
                {id: 151, type: "Bonus", naam: "Herpositioneren", effect: "Verplaats max 2 minuten.", taak: "Meld start/stop in chat."},
                {id: 152, type: "Bonus", naam: "Noodontsnapping", effect: "Direct verplaatsen (50m). Alleen als zoekers dichtbij zijn.", taak: "Meld gebruik in chat."},
                {id: 153, type: "Bonus", naam: "Omgevingscamouflage", effect: "Stuur foto van hoofd zoeker ipv object.", taak: "Geen taak."},
                {id: 154, type: "Bonus", naam: "Onzichtbaar", effect: "2 minuten pauze (geen vragen/actie).", taak: "Geen taak."},
                {id: 155, type: "Bonus", naam: "Souvenir", effect: "Zoekers moeten souvenir kopen voor hiders.", taak: "Geen taak."},
                {id: 156, type: "Bonus", naam: "Snelle Ontsnapping", effect: "Direct verplaatsen (200m).", taak: "Meld gebruik in chat."},
                {id: 157, type: "Bonus", naam: "Stealth Modus", effect: "10 min geen vragen van zoekers.", taak: "Geen taak."},
                {id: 158, type: "Bonus", naam: "Tijd Rekken", effect: "Zoekers wachten 5 min extra op antwoord.", taak: "Geen taak."},
                {id: 159, type: "Bonus", naam: "Vraag Blok", effect: "Huidige vraag telt niet.", taak: "Geen taak."},
                {id: 160, type: "Bonus", naam: "Weggooien & Trekken", effect: "Gooi 3 kaarten weg, trek nieuwe.", taak: "Geen taak."},
                {id: 161, type: "Bonus", naam: "De Mol", effect: "Je mag liegen op de volgende Ja/Nee vraag.", taak: "Eet een lepel kaneel (film)."},
                {id: 162, type: "Bonus", naam: "Schaduwloop", effect: "Verplaatsen TIJDENS antwoorden (2 min).", taak: "Doe 20 squats (film)."},
                {id: 163, type: "Bonus", naam: "Wisseltruc", effect: "Hand weggooien (behalve deze), 3 nieuwe trekken.", taak: "Draai 10 rondjes en loop recht (film)."},
                {id: 164, type: "Bonus", naam: "Camouflage", effect: "Stuur foto van schoen ipv gevraagd object.", taak: "Maak gezicht onherkenbaar en stuur selfie."},
                {id: 165, type: "Bonus", naam: "De Spion", effect: "Zoekers moeten hun locatie screenshotten.", taak: "Zing Vlaamse klassieker luidkeels."},
                {id: 166, type: "Bonus", naam: "Ping Pong", effect: "Zoekers moeten hun eigen vraag beantwoorden.", taak: "Steen-papier-schaar tegen lucht (film)."},
                {id: 167, type: "Bonus", naam: "Safe House", effect: "Ga winkel/café binnen (10 min veilig).", taak: "Vraag vreemde hoe laat het is (film)."},
                {id: 168, type: "Bonus", naam: "Vogelvlucht", effect: "Vrij bewegen zonder limiet (5 min).", taak: "Doe de vogeltjesdans (30 sec film)."},
                {id: 169, type: "Bonus", naam: "Ruis op de Lijn", effect: "Antwoord in andere taal (Frans/Duits/Engels).", taak: "Spreek 1 minuut met zwaar accent."},
                {id: 170, type: "Bonus", naam: "Kortsluiting", effect: "Zoekers: 5 min geen scherm (alleen audio).", taak: "Schoenen aan verkeerde voeten (5 min)."}
            ]
        };
        
        let state = {
            user: null,
            lobby: null,
            role: null,
            questions: [],
            deck: [],
            status: 'idle', 
            activeQ: null,
            timerStart: 0,
            gameStartTime: 0,
            hidingStartTime: 0,
            gameDuration: 90,
            penalty: 0,
            activeCurses: [],
            activeBonus: null, // NEW: For showing popup to seekers
            logs: [],
            tempDrawnCard: null 
        };

        let timerInt = null;
        let mainTimerInt = null;

        window.app = {
            async join() {
                const name = document.getElementById('inp-name').value;
                const lobby = document.getElementById('inp-lobby').value.toUpperCase();
                const duration = parseInt(document.getElementById('inp-duration').value);

                if (!name || !lobby) return alert("Vul naam en lobby code in.");
                document.getElementById('btn-join').innerText = "LADEN...";
                
                try {
                    await signInAnonymously(auth);
                    state.user = { uid: auth.currentUser.uid, name };
                    state.lobby = lobby;

                    const lobbyRef = ref(db, `lobbies/${lobby}`);
                    const snap = await get(lobbyRef);
                    if (!snap.exists()) {
                        await set(lobbyRef, {
                            created: Date.now(),
                            gameDuration: duration,
                            questions: DATA.questions,
                            deck: DATA.deck,
                            status: 'idle',
                            penalty: 0,
                            gameStartTime: 0,
                            hidingStartTime: 0,
                            activeBonus: null,
                            logs: [{msg: `Lobby ${lobby} gestart door ${name} (${duration} min)`, time: Date.now()}]
                        });
                    } else {
                        const logs = snap.val().logs || [];
                        logs.push({msg: `${name} joined`, time: Date.now()});
                        update(lobbyRef, { logs });
                    }

                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-role').classList.remove('hidden');
                    app.listen();

                } catch (e) {
                    alert("Fout bij verbinden: " + e.message);
                    document.getElementById('btn-join').innerText = "START SPEL";
                }
            },

            setRole(role) {
                state.role = role;
                document.getElementById('view-role').classList.add('hidden');
                document.getElementById('view-game').classList.remove('hidden');
                document.getElementById('lbl-lobby').innerText = state.lobby;
                document.getElementById('lbl-user').innerText = state.user.name;
                
                if(role === 'hider') {
                    document.getElementById('hider-hand-wrapper').classList.remove('hidden');
                } else {
                    document.getElementById('seeker-panel').classList.remove('hidden');
                    app.renderQuestions(1); 
                }
                app.renderUI();
            },

            listen() {
                onValue(ref(db, `lobbies/${state.lobby}`), (snap) => {
                    const data = snap.val();
                    if (!data) return;

                    // Update de state, maar forceer reset van optionele velden als ze missen
                    Object.assign(state, data);
                    
                    state.questions = data.questions || [];
                    state.deck = data.deck || [];
                    state.activeCurses = data.activeCurses || [];
                    state.logs = data.logs || [];
                    
                    // ESSENTIEEL: Als activeBonus niet in de data zit (dus null/verwijderd is), zet hem dan expliciet op null in de state
                    state.activeBonus = data.activeBonus || null;

                    app.renderUI();
                });
            },

            renderUI() {
                // Logs
                document.getElementById('log-list').innerHTML = state.logs.slice().reverse().map(l => {
                    const time = new Date(l.time).toTimeString().substr(0,5);
                    return `<div class="border-b border-gray-700 pb-1 mb-1"><span class="text-gray-500 mr-2">[${time}]</span>${l.msg}</div>`;
                }).join('');

                // Score Display
                document.getElementById('score-display').innerText = `-${state.penalty}`;

                const isAnswering = state.status === 'answering';
                const isHiding = state.status === 'hiding';
                const hasCurses = state.activeCurses.length > 0;
                
                // Status Bar
                const statusBar = document.getElementById('status-bar');
                const answerTimer = document.getElementById('answer-timer');
                
                if (timerInt) clearInterval(timerInt);

                if (isAnswering) {
                    statusBar.classList.remove('hidden');
                    document.getElementById('status-text').innerText = "WACHTEN OP ANTWOORD...";
                    timerInt = setInterval(() => {
                        const elapsed = Date.now() - state.timerStart;
                        const remain = 180000 - elapsed;
                        if (remain <= 0) {
                            answerTimer.innerText = "TE LAAT!";
                            statusBar.classList.remove('bg-blue-900/50', 'border-blue-500/30');
                            statusBar.classList.add('bg-red-900/50', 'border-red-500/30');
                        } else {
                            const m = Math.floor(remain / 60000);
                            const s = Math.floor((remain % 60000) / 1000);
                            answerTimer.innerText = `${m}:${s.toString().padStart(2,'0')}`;
                        }
                    }, 1000);
                } else if (isHiding) {
                     statusBar.classList.remove('hidden');
                     document.getElementById('status-text').innerText = "VERSTOPTIJD...";
                     const elapsed = Date.now() - state.hidingStartTime;
                     const remain = (15 * 60000) - elapsed;
                     const m = Math.max(0, Math.floor(remain / 60000));
                     const s = Math.max(0, Math.floor((remain % 60000) / 1000));
                     answerTimer.innerText = `${m}:${s.toString().padStart(2,'0')}`;
                } else {
                    statusBar.classList.add('hidden');
                }

                // Main Timer (No Bonus added)
                if (mainTimerInt) clearInterval(mainTimerInt);
                const mainTimerEl = document.getElementById('main-timer');
                
                if (state.gameStartTime > 0) {
                    mainTimerInt = setInterval(() => {
                        const endTime = state.gameStartTime + (state.gameDuration * 60000);
                        const remain = endTime - Date.now();

                        if (remain <= 0) {
                            mainTimerEl.innerText = "00:00";
                            mainTimerEl.classList.add('text-red-500');
                        } else {
                            const h = Math.floor(remain / 3600000);
                            const m = Math.floor((remain % 3600000) / 60000);
                            const s = Math.floor((remain % 60000) / 1000);
                            mainTimerEl.innerText = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                        }
                    }, 1000);
                    document.getElementById('lbl-timer-title').innerText = "RESTEREND";
                } else {
                     document.getElementById('lbl-timer-title').innerText = "TIJD";
                     if(state.gameDuration) mainTimerEl.innerText = `${Math.floor(state.gameDuration/60)}:${(state.gameDuration%60).toString().padStart(2,'0')}:00`;
                }

                // Visibility Logic
                document.getElementById('hiding-phase-panel').classList.toggle('hidden', state.status !== 'hiding' && state.status !== 'idle');
                if (isHiding) {
                    document.getElementById('hider-start-btn-container').classList.add('hidden');
                    document.getElementById('hiding-timer-container').classList.remove('hidden');
                    const remain = (15 * 60000) - (Date.now() - state.hidingStartTime);
                    const m = Math.max(0, Math.floor(remain / 60000));
                    const s = Math.max(0, Math.floor((remain % 60000) / 1000));
                    document.getElementById('hiding-timer').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                }

                // Seeker UI
                document.getElementById('seeker-panel').classList.toggle('hidden', state.role !== 'seeker');
                if(state.role === 'seeker') {
                     const btns = document.querySelectorAll('#question-list-container button');
                     const disabled = isAnswering || isHiding;
                     btns.forEach(b => {
                        b.disabled = disabled;
                        b.classList.toggle('btn-disabled', disabled);
                     });
                     document.getElementById('seeker-wait-msg').classList.toggle('hidden', !disabled);
                }

                // Hider Hand
                document.getElementById('hider-hand-wrapper').classList.toggle('hidden', state.role !== 'hider');
                if(state.role === 'hider') {
                    const hand = state.deck.filter(c => c.status === 'hand');
                    document.getElementById('lbl-hand-count').innerText = hand.length;
                    document.getElementById('hand-list').innerHTML = hand.length === 0 
                        ? `<div class="text-center text-gray-600 italic py-4 text-xs">Je hand is leeg.</div>`
                        : hand.map(c => `
                            <div class="card-base p-3 flex justify-between items-center ${c.type === 'Vloek' ? 'border-red-500/50 bg-red-900/10' : (c.type === 'Tijd' ? 'border-green-500/50 bg-green-900/10' : 'border-yellow-500/50 bg-yellow-900/10')}">
                                <div class="w-2/3 pr-2">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[9px] font-black uppercase px-1.5 py-0.5 rounded ${c.type==='Vloek'?'bg-red-500 text-black':(c.type==='Tijd'?'bg-green-500 text-black':'bg-yellow-500 text-black')}">${c.type}</span>
                                        <span class="font-bold text-white text-xs truncate">${c.naam} ${c.val ? `(${c.val}m)` : ''}</span>
                                    </div>
                                    <div class="text-[10px] text-gray-300 leading-tight mb-1">${c.effect}</div>
                                    ${c.taak !== 'Geen taak.' ? `<div class="text-[9px] text-yellow-500 italic border-l-2 border-yellow-500 pl-1">${c.taak}</div>` : ''}
                                </div>
                                <div class="flex flex-col gap-1 w-16 shrink-0">
                                    ${c.type !== 'Tijd' ? `<button onclick="app.playCard(${c.id})" class="bg-green-600 hover:bg-green-500 text-white text-[10px] font-bold py-1.5 rounded transition shadow-lg">SPEEL</button>` : ''}
                                    <button onclick="app.discardCard(${c.id})" class="bg-gray-700 hover:bg-gray-600 text-gray-400 text-[10px] py-1.5 rounded transition">WEG</button>
                                </div>
                            </div>
                        `).join('');

                    document.getElementById('hider-panel').classList.toggle('hidden', !isAnswering);
                    if(isAnswering && state.activeQ) {
                        const q = state.questions.find(x => x.id === state.activeQ);
                        if(q) {
                            document.getElementById('hp-question').innerText = q.vraag;
                            document.getElementById('hp-reward').innerText = q.niveau; // Shows "Trek 2 kaarten..."
                        }
                    }
                }

                // Curses
                document.getElementById('overlay-curse').classList.toggle('hidden', state.role !== 'seeker' || !hasCurses);
                if(hasCurses && state.role === 'seeker') {
                    document.getElementById('active-curses-container').innerHTML = state.activeCurses.map((c, idx) => `
                        <div class="bg-gray-800 p-4 rounded-xl border border-red-500 text-left shadow-lg">
                            <h4 class="font-bold text-yellow-400 text-lg mt-2">${c.naam}</h4>
                            <p class="text-gray-300 text-sm mb-2">${c.effect}</p>
                            <div class="bg-black/30 p-2 rounded italic text-gray-400 mb-3 text-xs border-l-2 border-yellow-500">
                                <span class="font-bold text-yellow-500">Taak:</span> ${c.taak}
                            </div>
                            <button onclick="app.clearCurse(${idx})" class="w-full bg-green-600 hover:bg-green-500 py-3 rounded font-bold text-white text-sm transition">
                                <i class="fa-solid fa-check mr-1"></i> VLOEK VOLTOOID
                            </button>
                        </div>
                    `).join('');
                }

                // Bonus Overlay (Seekers only)
                const showBonus = state.activeBonus && state.role === 'seeker';
                document.getElementById('overlay-bonus').classList.toggle('hidden', !showBonus);
                if(showBonus) {
                    document.getElementById('bonus-title').innerText = state.activeBonus.naam;
                    document.getElementById('bonus-desc').innerText = state.activeBonus.effect;
                }
            },

            startHiding() {
                if(!confirm("Start 15 minuten verstoptijd?")) return;
                update(ref(db, `lobbies/${state.lobby}`), {
                    status: 'hiding',
                    hidingStartTime: serverTimestamp(),
                    logs: [...state.logs, {msg: "VERSTOPTIJD GESTART (15 min)", time: Date.now()}]
                });
            },

            stopHidingEarly() {
                if(!confirm("Zijn jullie klaar om het spel te starten? De tijd gaat nu in.")) return;
                // Switch to active state and START game timer immediately
                update(ref(db, `lobbies/${state.lobby}`), {
                    status: 'active',
                    gameStartTime: serverTimestamp(),
                    hidingStartTime: 0, // Reset hiding timer visual
                    logs: [...state.logs, {msg: "HIDERS KLAAR: SPEL START!", time: Date.now()}]
                });
            },

            renderQuestions(lvl) {
                // UI Toggle
                [1,2,3].forEach(i => {
                    const btn = document.getElementById(`btn-lvl-${i}`);
                    if(i===lvl) {
                        btn.classList.remove('bg-gray-800', 'text-gray-400');
                        btn.classList.add('bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400');
                    } else {
                        btn.classList.add('bg-gray-800', 'text-gray-400');
                        btn.classList.remove('bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400');
                    }
                });

                const list = document.getElementById('question-list-container');
                list.innerHTML = "";
                
                const filtered = state.questions.filter(q => q.niveau === lvl && !q.used);
                
                if (filtered.length === 0) {
                    list.innerHTML = `<div class="text-center text-gray-500 italic mt-8 bg-gray-800/50 p-4 rounded-xl">Alle vragen van dit niveau zijn gesteld!</div>`;
                    return;
                }

                const groups = {};
                filtered.forEach(q => {
                    if(!groups[q.categorie]) groups[q.categorie] = [];
                    groups[q.categorie].push(q);
                });

                for (const [cat, qs] of Object.entries(groups)) {
                    let icon = 'fa-tag';
                    if(cat === 'Locatie') icon = 'fa-map-pin';
                    if(cat === 'Omgeving') icon = 'fa-tree';
                    if(cat === 'Visueel') icon = 'fa-eye';
                    if(cat === 'Risico') icon = 'fa-skull';
                    if(cat === 'Foto') icon = 'fa-camera';
                    if(cat === 'Puzzel') icon = 'fa-puzzle-piece';

                    const html = `
                        <div class="cat-header"><i class="fa-solid ${icon}"></i> ${cat}</div>
                        ${qs.map(q => `
                            <button onclick="app.askQuestion(${q.id})" class="w-full text-left bg-gray-800 p-4 rounded-lg border border-gray-700 hover:bg-gray-750 hover:border-blue-500 active:scale-[0.99] transition mb-2 shadow-sm group">
                                <div class="text-sm font-bold text-gray-200 group-hover:text-white">${q.vraag}</div>
                                <div class="text-[10px] text-gray-500 mt-1 uppercase tracking-wider group-hover:text-blue-400">Klik om te vragen</div>
                            </button>
                        `).join('')}
                    `;
                    list.innerHTML += html;
                }
            },

            askQuestion(id) {
                if(state.status === 'answering') return;
                if(state.status === 'hiding') {
                    const elapsed = Date.now() - state.hidingStartTime;
                    if(elapsed < 15 * 60000) {
                        if(!confirm("De verstoptijd is nog niet voorbij! Wil je toch beginnen en de timer starten?")) return;
                    }
                }
                if(!confirm("Weet je zeker dat je deze vraag wil stellen?")) return;
                
                const qIdx = state.questions.findIndex(q => q.id === id);
                const updates = {};
                updates[`questions/${qIdx}/used`] = true;
                updates[`status`] = 'answering';
                updates[`activeQ`] = id;
                updates[`timerStart`] = serverTimestamp();
                
                // If this is the FIRST question and timer hasn't started yet (e.g. natural flow)
                if (state.gameStartTime === 0) {
                     updates[`gameStartTime`] = serverTimestamp();
                     updates[`logs`] = [...state.logs, {msg: "SPEL START! Timer loopt.", time: Date.now()}];
                } else {
                     updates[`logs`] = [...state.logs, {msg: `ZOEKERS: "${state.questions[qIdx].vraag}"`, time: Date.now()}];
                }

                update(ref(db, `lobbies/${state.lobby}`), updates);
            },

            hiderConfirmAnswer() {
                if(!confirm("Heb je het antwoord verstuurd via WhatsApp?")) return;

                const elapsed = Date.now() - state.timerStart;
                let penaltyAdded = 0;
                if (elapsed > 180000) penaltyAdded = 10; 

                const q = state.questions.find(x => x.id === state.activeQ);
                let drawCount = q.niveau; 
                
                const updates = { status: 'active', activeQ: null, timerStart: 0 };
                if (penaltyAdded > 0) updates['penalty'] = state.penalty + 10;
                
                const newLog = [...state.logs, {msg: `HIDERS geantwoord! ${penaltyAdded ? '(TE LAAT: -10 ptn)' : ''}`, time: Date.now()}];
                updates['logs'] = newLog;

                update(ref(db, `lobbies/${state.lobby}`), updates)
                    .then(() => app.triggerDraw(drawCount));
            },

            triggerDraw(amount) {
                // Get fresh list of all available cards in deck
                const deck = state.deck.filter(c => !c.status || c.status === 'deck');
                if (deck.length === 0) return alert("Kaarten zijn op!");
                
                // TRUE RANDOMIZATION FROM FULL DECK
                const drawn = [];
                const tempDeck = [...deck];
                
                for (let i=0; i<amount; i++) {
                    if(tempDeck.length === 0) break;
                    const r = Math.floor(Math.random() * tempDeck.length);
                    drawn.push(tempDeck[r]);
                    tempDeck.splice(r, 1);
                }

                const list = document.getElementById('pick-list');
                list.innerHTML = drawn.map(c => `
                    <div onclick="app.keepCard(${c.id})" class="bg-gray-700 p-4 rounded-xl border border-yellow-500/30 hover:border-yellow-400 active:bg-gray-600 transition cursor-pointer">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-yellow-400 text-lg">${c.naam}</span>
                            <span class="text-[9px] uppercase px-1.5 py-0.5 rounded ${c.type==='Vloek'?'bg-red-500 text-black':(c.type==='Tijd'?'bg-green-500 text-black':'bg-yellow-500 text-black')}">${c.type}</span>
                        </div>
                        <div class="text-xs text-white mb-2">${c.effect}</div>
                        ${c.type === 'Tijd' ? `<div class="text-[9px] text-green-400 font-bold">Waarde: ${c.val} min (Bewaar voor betalingen)</div>` : ''}
                        <div class="text-[10px] text-gray-400 italic border-l-2 border-gray-500 pl-2 mt-2">${c.taak}</div>
                    </div>
                `).join('');
                
                document.getElementById('modal-pick').classList.remove('hidden');
            },

            keepCard(id) {
                document.getElementById('modal-pick').classList.add('hidden');
                const idx = state.deck.findIndex(c => c.id === id);
                const hand = state.deck.filter(c => c.status === 'hand');
                
                if (hand.length >= 6) {
                    state.tempDrawnCard = state.deck[idx]; 
                    app.showDiscardModal(id);
                } else {
                    update(ref(db, `lobbies/${state.lobby}/deck/${idx}`), { status: 'hand' });
                }
            },

            showDiscardModal(newId) {
                const modal = document.getElementById('modal-discard');
                modal.classList.remove('hidden');
                
                const newItem = state.deck.find(c => c.id === newId);
                document.getElementById('discard-new-list').innerHTML = `
                    <div class="bg-gray-800 p-3 rounded border border-green-500 text-center">
                        <div class="font-bold text-green-400 text-sm">${newItem.naam}</div>
                        <div class="text-[10px] text-gray-400">${newItem.effect}</div>
                    </div>
                `;

                const hand = state.deck.filter(c => c.status === 'hand');
                document.getElementById('discard-hand-list').innerHTML = hand.map(c => `
                    <div onclick="app.discardOldAndKeepNew(${c.id}, ${newId})" class="bg-gray-800 p-3 rounded flex justify-between items-center border border-gray-600 hover:border-red-500 cursor-pointer mb-2 group">
                        <div>
                            <div class="text-white font-bold text-xs group-hover:text-red-400 transition">${c.naam}</div>
                            <div class="text-[9px] text-gray-500">${c.type}</div>
                        </div>
                        <i class="fa-solid fa-trash text-gray-600 group-hover:text-red-500 transition"></i>
                    </div>
                `).join('');
            },

            discardNewCard() {
                document.getElementById('modal-discard').classList.add('hidden');
                const idx = state.deck.findIndex(c => c.id === state.tempDrawnCard.id);
                update(ref(db, `lobbies/${state.lobby}/deck/${idx}`), { status: 'discarded' });
                state.tempDrawnCard = null;
            },

            discardOldAndKeepNew(oldId, newId) {
                const oldIdx = state.deck.findIndex(c => c.id === oldId);
                const updates = {};
                updates[`deck/${oldIdx}/status`] = 'discarded';
                
                const newIdx = state.deck.findIndex(c => c.id === newId);
                updates[`deck/${newIdx}/status`] = 'hand';
                
                update(ref(db, `lobbies/${state.lobby}`), updates);
                document.getElementById('modal-discard').classList.add('hidden');
                state.tempDrawnCard = null;
            },

            playCard(id) {
                const idx = state.deck.findIndex(c => c.id === id);
                const card = state.deck[idx];

                if(card.type === 'Tijd') return; 

                if(card.taak !== "Geen taak.") {
                    if(!confirm(`TAAK VEREIST:\n\n"${card.taak}"\n\nHeb je dit gedaan/gefilmd?`)) return;
                }
                
                const updates = {};
                updates[`deck/${idx}/status`] = 'played';
                
                if (card.type === 'Vloek') {
                    const newCurses = [...state.activeCurses, card];
                    updates['activeCurses'] = newCurses;
                }

                if (card.type === 'Bonus') {
                    updates['activeBonus'] = card;
                }
                
                updates['logs'] = [...state.logs, {msg: `HIDERS spelen: ${card.naam}`, time: Date.now()}];
                update(ref(db, `lobbies/${state.lobby}`), updates);
            },

            clearBonus() {
                // Zet de waarde expliciet op null in de database
                update(ref(db, `lobbies/${state.lobby}`), { activeBonus: null });
                
                // Voor de zekerheid lokaal ook direct verbergen (voor snellere UI feedback)
                state.activeBonus = null;
                app.renderUI();
            },

            discardCard(id) {
                if(!confirm("Weet je zeker dat je deze kaart weg wil gooien? (Als je dit doet om een vloek op te heffen, bevestig dit dan mondeling aan de zoekers).")) return;
                const idx = state.deck.findIndex(c => c.id === id);
                update(ref(db, `lobbies/${state.lobby}/deck/${idx}`), { status: 'discarded' });
            },

            clearCurse(arrIndex) {
                if(!confirm("Bevestig: Hebben de zoekers de vloek/taak succesvol afgerond?")) return;
                const newCurses = state.activeCurses.filter((_, i) => i !== arrIndex);
                const updates = { activeCurses: newCurses, logs: [...state.logs, {msg: `ZOEKERS: Vloek opgeheven!`, time: Date.now()}] };
                update(ref(db, `lobbies/${state.lobby}`), updates);
            },

            clearBonus() {
                update(ref(db, `lobbies/${state.lobby}`), { activeBonus: null });
            }
        };
        window.app = app;
    </script>
</body>
</html>



