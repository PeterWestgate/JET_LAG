<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leuven Hide & Seek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        .card-jetlag { background: #1f2937; border-left: 4px solid #fbbf24; transition: transform 0.1s; }
        .card-jetlag:active { transform: scale(0.98); }
        .btn-primary { background-color: #fbbf24; color: #1a1a1a; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; }
        .btn-primary:hover { background-color: #f59e0b; }
        
        /* Categorie headers */
        .cat-header { background-color: #374151; color: #fbbf24; font-weight: bold; padding: 8px 12px; border-radius: 6px; margin-top: 16px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 2px solid #fbbf24; }

        /* Curse Overlay Animation */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .curse-active { animation: pulse-red 2s infinite; border: 2px solid #ef4444; }
        
        /* Scrollbar hide */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 selection:bg-yellow-500 selection:text-black">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="w-full max-w-md space-y-8 mt-10">
        <div class="text-center space-y-2">
            <i class="fa-solid fa-map-location-dot text-6xl text-yellow-400 mb-4"></i>
            <h1 class="text-5xl font-black text-white tracking-tighter">LEUVEN<br><span class="text-yellow-400">HIDE & SEEK</span></h1>
            <p class="text-gray-400 text-sm font-mono">STRATEGIC OUTDOOR GAME</p>
        </div>
        
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl space-y-6 border border-gray-700">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Speler Naam</label>
                <input type="text" id="username" class="w-full p-4 rounded-lg bg-gray-900 border border-gray-600 focus:border-yellow-400 outline-none text-white font-bold" placeholder="Bijv. Sam">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Lobby Code</label>
                <input type="text" id="lobbycode" class="w-full p-4 rounded-lg bg-gray-900 border border-gray-600 focus:border-yellow-400 outline-none text-white font-bold uppercase tracking-widest" placeholder="LEUVEN1">
            </div>
            <button id="join-btn" onclick="joinLobby()" class="w-full btn-primary p-4 rounded-lg shadow-lg hover:shadow-yellow-400/20 transition-all transform hover:-translate-y-1">
                START SPEL
            </button>
        </div>
    </div>

    <!-- ROLE SELECTION -->
    <div id="role-screen" class="hidden w-full max-w-md space-y-6 mt-10 text-center">
        <h2 class="text-3xl font-black text-white">KIES JE TEAM</h2>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="selectRole('hider')" class="bg-gray-800 p-8 rounded-2xl border-2 border-gray-700 hover:border-yellow-400 hover:bg-gray-700 transition-all group">
                <i class="fa-solid fa-user-secret text-5xl text-gray-500 group-hover:text-yellow-400 mb-4 transition-colors"></i>
                <div class="font-black text-xl text-white">HIDER</div>
                <div class="text-xs text-gray-400 mt-2">Verstop & Saboteer</div>
            </button>
            <button onclick="selectRole('seeker')" class="bg-gray-800 p-8 rounded-2xl border-2 border-gray-700 hover:border-blue-400 hover:bg-gray-700 transition-all group">
                <i class="fa-solid fa-binoculars text-5xl text-gray-500 group-hover:text-blue-400 mb-4 transition-colors"></i>
                <div class="font-black text-xl text-white">ZOEKER</div>
                <div class="text-xs text-gray-400 mt-2">Vraag & Jaag</div>
            </button>
        </div>
    </div>

    <!-- GAME DASHBOARD -->
    <div id="game-screen" class="hidden w-full max-w-lg space-y-4 pb-24">
        <!-- Header -->
        <div class="flex justify-between items-center bg-gray-800/90 backdrop-blur p-4 rounded-xl sticky top-2 z-40 shadow-lg border border-gray-700">
            <div class="flex items-center space-x-3">
                <div id="role-icon" class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-700 text-lg"></div>
                <div>
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Lobby: <span id="display-lobby" class="text-white"></span></div>
                    <div class="text-sm font-bold text-white"><span id="display-user"></span></div>
                </div>
            </div>
            <div id="role-badge" class="px-3 py-1 rounded-full font-black text-[10px] tracking-wider border border-white/10"></div>
        </div>

        <!-- TIMER BAR -->
        <div id="timer-container" class="hidden sticky top-20 z-30 bg-red-600 text-white p-2 rounded-lg text-center font-bold shadow-lg flex items-center justify-center space-x-2 animate-pulse">
            <i class="fa-solid fa-hourglass-half animate-spin"></i>
            <span>ANTWOORD TIJD: <span id="countdown-display" class="font-mono text-xl">03:00</span></span>
        </div>

        <!-- CURSE OVERLAY (For Seekers) -->
        <div id="curse-overlay" class="hidden fixed inset-0 z-50 bg-red-950/95 backdrop-blur-sm flex flex-col items-center justify-center p-6 text-center space-y-6">
            <div class="bg-gray-900 p-8 rounded-2xl border-2 border-red-500 shadow-2xl w-full max-w-md relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-red-500 animate-pulse"></div>
                <i class="fa-solid fa-triangle-exclamation text-6xl text-red-500 mb-4"></i>
                <h2 class="text-3xl font-black text-white mb-2 uppercase">Vloek Actief!</h2>
                <p class="text-gray-300 text-sm mb-6">Jullie zijn vervloekt door de Hiders. Voer de taak uit om verder te gaan.</p>
                
                <div id="active-curses-list" class="space-y-4 text-left max-h-60 overflow-y-auto">
                    <!-- Active curses injected here -->
                </div>
            </div>
        </div>

        <!-- HIDER VIEW -->
        <div id="hider-view" class="hidden space-y-4">
            
            <!-- Active Question Panel -->
            <div id="hider-action-panel" class="hidden bg-gradient-to-br from-blue-900 to-blue-800 border border-blue-500 p-6 rounded-2xl text-center space-y-4 shadow-xl">
                <div class="inline-block bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider mb-1">Nieuwe Vraag</div>
                <h3 id="current-question-text" class="font-bold text-xl text-white leading-tight">...</h3>
                <div class="flex justify-center space-x-4 text-xs text-blue-200">
                    <span class="bg-black/20 px-2 py-1 rounded"><i class="fa-solid fa-layer-group mr-1"></i> Niveau <span id="current-question-level"></span></span>
                </div>
                
                <button onclick="confirmAnswer()" class="w-full bg-white text-blue-900 font-bold p-4 rounded-xl shadow-lg hover:bg-blue-50 transition flex items-center justify-center space-x-2">
                    <i class="fa-solid fa-paper-plane"></i>
                    <span>Bevestig Antwoord & Trek Kaarten</span>
                </button>
                <p class="text-[10px] text-blue-300">Antwoord eerst in WhatsApp, druk dan hier.</p>
            </div>

            <!-- Hand -->
            <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                <div class="flex justify-between items-end mb-4">
                    <h3 class="font-bold text-gray-200 flex items-center">
                        <i class="fa-solid fa-hand text-yellow-400 mr-2"></i> Jouw Hand
                    </h3>
                    <span class="text-xs font-mono bg-gray-900 text-gray-400 px-2 py-1 rounded border border-gray-700"><span id="hand-count">0</span>/6</span>
                </div>
                <div id="hider-hand" class="space-y-3 min-h-[100px]">
                    <p class="text-gray-500 text-sm italic text-center py-8">Je hebt nog geen kaarten.</p>
                </div>
            </div>
        </div>

        <!-- SEEKER VIEW -->
        <div id="seeker-view" class="hidden space-y-4">
            <div class="bg-gray-800 p-2 rounded-2xl border border-gray-700 sticky top-[70px] z-30 shadow-xl">
                <!-- Filter Tabs -->
                <div class="flex space-x-1">
                    <button onclick="filterQuestions(1)" class="flex-1 py-3 rounded-xl bg-gray-700 text-gray-400 text-xs font-bold uppercase transition hover:bg-green-900/50 data-[active=true]:bg-green-600 data-[active=true]:text-white" id="btn-lvl-1">Niveau 1</button>
                    <button onclick="filterQuestions(2)" class="flex-1 py-3 rounded-xl bg-gray-700 text-gray-400 text-xs font-bold uppercase transition hover:bg-yellow-900/50 data-[active=true]:bg-yellow-600 data-[active=true]:text-white" id="btn-lvl-2">Niveau 2</button>
                    <button onclick="filterQuestions(3)" class="flex-1 py-3 rounded-xl bg-gray-700 text-gray-400 text-xs font-bold uppercase transition hover:bg-red-900/50 data-[active=true]:bg-red-600 data-[active=true]:text-white" id="btn-lvl-3">Niveau 3</button>
                </div>
            </div>

            <div id="questions-list" class="space-y-2 pb-10">
                <!-- Vragen worden hier geladen -->
            </div>
        </div>

        <!-- SHARED LOG -->
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
            <h3 class="font-bold mb-3 text-gray-500 text-[10px] uppercase tracking-widest">Spel Logboek</h3>
            <div id="game-log" class="text-xs space-y-2 h-40 overflow-y-auto text-gray-300 font-mono scrollbar-thin">
                <!-- Logs -->
            </div>
        </div>
    </div>

    <!-- Modal for Selection (Normal Draw) -->
    <div id="card-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-gray-900 w-full max-w-md rounded-2xl p-6 space-y-6 border border-yellow-500/30 shadow-2xl">
            <div class="text-center">
                <i class="fa-solid fa-gifts text-4xl text-yellow-400 mb-2"></i>
                <h3 class="text-xl font-black text-white">KIES EEN KAART</h3>
                <p class="text-xs text-gray-400">Kies er 1 om te houden. De rest verdwijnt.</p>
            </div>
            <div id="modal-cards" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Modal for Overflow (Hand Full) -->
    <div id="overflow-modal" class="hidden fixed inset-0 bg-black/95 backdrop-blur flex items-center justify-center p-4 z-50">
        <div class="bg-gray-900 w-full max-w-md rounded-2xl p-6 space-y-4 border-2 border-red-500 shadow-2xl relative">
            <div class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-2"><i class="fa-solid fa-hand"></i></div>
            <div class="text-center">
                <h3 class="text-xl font-black text-white">HAND ZIT VOL!</h3>
                <p class="text-sm text-gray-400">Je moet kaarten weggooien tot je er 6 hebt.</p>
            </div>
            
            <div class="space-y-2 bg-gray-800/50 p-3 rounded-xl">
                <h4 class="text-[10px] font-bold uppercase text-yellow-400 tracking-wider">Nieuw Getrokken (Klik om te houden):</h4>
                <div id="overflow-new-cards" class="space-y-2"></div>
            </div>

            <div class="text-center text-gray-500 text-xs"><i class="fa-solid fa-arrow-down"></i> Wissel met <i class="fa-solid fa-arrow-down"></i></div>

            <div class="space-y-2 bg-gray-800/50 p-3 rounded-xl">
                <h4 class="text-[10px] font-bold uppercase text-blue-400 tracking-wider">Jouw Huidige Hand (Klik om weg te doen):</h4>
                <div id="overflow-hand-cards" class="space-y-2 max-h-40 overflow-y-auto"></div>
            </div>
            
            <button onclick="finishOverflow()" id="btn-finish-overflow" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold hidden shadow-lg">
                Klaar (6 Kaarten over)
            </button>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- VUL HIER JOUW FIREBASE CONFIG IN ---
        const firebaseConfig = {
  apiKey: "AIzaSyCP1yVG3ssEyOub_F6P__90G1bM13kDaz0",
  authDomain: "jetlagleuven.firebaseapp.com",
  databaseURL: "https://jetlagleuven-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "jetlagleuven",
  storageBucket: "jetlagleuven.firebasestorage.app",
  messagingSenderId: "461047598360",
  appId: "1:461047598360:web:34dfbfa265e3004ceb626d"
};
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- COMPLETE DATASET (Leuven + Maaseik Mix + Jetlag Logic) ---
        const GAME_DATA = {
            questions: [
                // NIVEAU 1 (Basis - Trek 1)
                {id:1, niveau:1, categorie:"Locatie", vraag:"Zijn jullie links of rechts van de Dijle (stroomafwaarts)?"},
                {id:2, niveau:1, categorie:"Locatie", vraag:"Bevinden jullie je binnen de ring of op de ring zelf?"},
                {id:3, niveau:1, categorie:"Locatie", vraag:"Is de straatnaam waar jullie zijn langer dan 8 letters?"},
                {id:4, niveau:1, categorie:"Locatie", vraag:"Is de weg waar jullie zijn toegankelijk voor auto's?"},
                {id:5, niveau:1, categorie:"Omgeving", vraag:"Is de ondergrond waar jullie staan bestraat of onverhard?"},
                {id:6, niveau:1, categorie:"Omgeving", vraag:"Horen jullie op dit moment het geluid van stromend water?"},
                {id:7, niveau:1, categorie:"Omgeving", vraag:"Staan jullie onder een afdak/beschutting of in de open lucht?"},
                {id:8, niveau:1, categorie:"Omgeving", vraag:"Is het huisnummer van het dichtstbijzijnde gebouw even of oneven?"},
                {id:9, niveau:1, categorie:"Omgeving", vraag:"Zijn er meer dan 5 andere mensen zichtbaar in een straal van 20 meter?"},
                {id:10, niveau:1, categorie:"Omgeving", vraag:"Is er een fietsenstalling zichtbaar?"},
                {id:11, niveau:1, categorie:"Omgeving", vraag:"Staan jullie op een helling/heuvel of op vlakke grond?"},
                {id:12, niveau:1, categorie:"Omgeving", vraag:"Kunnen jullie een verkeerslicht zien vanaf jullie positie?"},
                {id:13, niveau:1, categorie:"Omgeving", vraag:"Is er een zitbankje binnen 10 meter?"},
                {id:14, niveau:1, categorie:"Omgeving", vraag:"Zien jullie een bewakingscamera?"},
                {id:15, niveau:1, categorie:"Omgeving", vraag:"Zie je op dit moment een hond?"},
                {id:16, niveau:1, categorie:"Omgeving", vraag:"Zie je een 'Verboden te parkeren' bord?"},
                {id:17, niveau:1, categorie:"Omgeving", vraag:"Sta je in de zon of in de schaduw?"},
                {id:18, niveau:1, categorie:"Omgeving", vraag:"Is er een zebrapad zichtbaar?"},
                {id:19, niveau:1, categorie:"Omgeving", vraag:"Zie je iemand fietsen?"},
                {id:20, niveau:1, categorie:"Omgeving", vraag:"Is er een rioolputje binnen 5 meter?"},
                {id:21, niveau:1, categorie:"Visueel", vraag:"Kunnen jullie een toren (kerk, bib, stadhuis) zien?"},
                {id:22, niveau:1, categorie:"Visueel", vraag:"Is er graffiti of street art zichtbaar?"},
                {id:23, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde gevel gemaakt van baksteen?"},
                {id:24, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde prullenbak groen of grijs?"},
                {id:25, niveau:1, categorie:"Visueel", vraag:"Sta je op kasseien?"},
                {id:26, niveau:1, categorie:"Visueel", vraag:"Zie je een vlag wapperen?"},
                {id:27, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde auto rood, zwart of grijs?"},
                {id:28, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde deur van hout of glas?"},
                {id:29, niveau:1, categorie:"Visueel", vraag:"Zie je een reclamebord?"},
                {id:30, niveau:1, categorie:"Visueel", vraag:"Zie je klimop of onkruid groeien?"},
                {id:31, niveau:1, categorie:"Visueel", vraag:"Zien jullie een balkon?"},
                {id:32, niveau:1, categorie:"Zintuig", vraag:"Ruik je op dit moment etensgeuren?"},
                {id:33, niveau:1, categorie:"Zintuig", vraag:"Voel je op dit moment wind?"},
                {id:34, niveau:1, categorie:"Audio", vraag:"Hoor je muziek?"},
                {id:35, niveau:1, categorie:"Audio", vraag:"Hoor je sirenes?"},

                // NIVEAU 2 (Specifiek - Trek 2 Kies 1)
                {id:36, niveau:2, categorie:"Locatie", vraag:"Zijn jullie dichter bij het Station dan bij de Grote Markt?"},
                {id:37, niveau:2, categorie:"Locatie", vraag:"Zijn jullie in een park (Stadspark, Kruidtuin, parkjes)?"},
                {id:38, niveau:2, categorie:"Locatie", vraag:"Zijn jullie dichter bij de Vaartkom dan bij het Arenbergpark?"},
                {id:39, niveau:2, categorie:"Locatie", vraag:"Zijn jullie binnen 200m van een supermarkt?"},
                {id:40, niveau:2, categorie:"Locatie", vraag:"Zijn jullie in de buurt van een universiteitsgebouw (KU Leuven vlaggen)?"},
                {id:41, niveau:2, categorie:"Locatie", vraag:"Zijn jullie ten Oosten of ten Westen van de Naamsestraat?"},
                {id:42, niveau:2, categorie:"Locatie", vraag:"Is je verstopplek binnen 250m van de Hoorn?"},
                {id:43, niveau:2, categorie:"Locatie", vraag:"Is je verstopplek dichter bij de Kruidtuin dan bij de Oude Markt?"},
                {id:44, niveau:2, categorie:"Foto", vraag:"Stuur een foto van de ondergrond (alleen jullie voeten en de grond)."},
                {id:45, niveau:2, categorie:"Foto", vraag:"Stuur een foto van de lucht recht boven jullie."},
                {id:46, niveau:2, categorie:"Foto", vraag:"Stuur een foto van het dichtstbijzijnde verkeersbord (zonder straatnaam)."},
                {id:47, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een object dat 'ROOD' is in jullie omgeving."},
                {id:48, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een textuur in de buurt (muur, schors, paal) close-up."},
                {id:49, niveau:2, categorie:"Foto", vraag:"Stuur een foto van jullie eigen schaduw op de grond."},
                {id:50, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een reflectie (in raam, plas, zonnebril)."},
                {id:51, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een 'rond' object in je omgeving."},
                {id:52, niveau:2, categorie:"Foto", vraag:"Stuur een foto van iets dat van metaal is gemaakt."},
                {id:53, niveau:2, categorie:"Foto", vraag:"Stuur een foto van iets dat geel is."},
                {id:54, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een slot (fietsslot, deurslot)."},
                {id:55, niveau:2, categorie:"Puzzel", vraag:"Wat is de eerste letter van de straat waar jullie zijn?"},
                {id:56, niveau:2, categorie:"Puzzel", vraag:"Hoeveel stappen zijn jullie verwijderd van de dichtstbijzijnde vuilnisbak?"},
                {id:57, niveau:2, categorie:"Puzzel", vraag:"Welke letter komt het vaakst voor op de borden om je heen?"},
                {id:58, niveau:2, categorie:"Puzzel", vraag:"Tel het aantal ramen op de begane grond van het gebouw tegenover je."},
                {id:59, niveau:2, categorie:"Puzzel", vraag:"Zie je een nummerbord met het cijfer 7 erin?"},
                {id:60, niveau:2, categorie:"Omgeving", vraag:"Is er een horecazaak (café/restaurant) zichtbaar met een terras?"},
                {id:61, niveau:2, categorie:"Omgeving", vraag:"Zie je een fiets die fout geparkeerd staat?"},
                {id:62, niveau:2, categorie:"Omgeving", vraag:"Zie je een kinderwagen?"},
                {id:63, niveau:2, categorie:"Omgeving", vraag:"Is het gebouw achter je hoger dan 3 verdiepingen?"},
                {id:64, niveau:2, categorie:"Omgeving", vraag:"Is er glasafval of zwerfvuil zichtbaar?"},
                {id:65, niveau:2, categorie:"Visueel", vraag:"Wat is de kleur van de voordeur die het dichtst bij is?"},
                {id:66, niveau:2, categorie:"Visueel", vraag:"Is de straatverlichting hangend aan een draad of op een paal?"},
                {id:67, niveau:2, categorie:"Visueel", vraag:"Is de dichtstbijzijnde gevel wit geverfd?"},
                {id:68, niveau:2, categorie:"Visueel", vraag:"Zie je een regenpijp? Welke kleur?"},
                {id:69, niveau:2, categorie:"Observatie", vraag:"Zie je iemand die een bril draagt?"},
                {id:70, niveau:2, categorie:"Audio", vraag:"Hoor je een klok luiden?"},

                // NIVEAU 3 (Risico - Trek 3 Kies 1)
                {id:71, niveau:3, categorie:"Risico", vraag:"Stuur een foto van het uitzicht op ooghoogte (zonder jullie zelf)."},
                {id:72, niveau:3, categorie:"Risico", vraag:"Stuur een geluidsopname van 15 seconden van de omgeving."},
                {id:73, niveau:3, categorie:"Risico", vraag:"Geef de naam van de dichtstbijzijnde winkel, café of openbaar gebouw."},
                {id:74, niveau:3, categorie:"Risico", vraag:"Loop naar de dichtstbijzijnde hoek en stuur een foto van wat je daar ziet."},
                {id:75, niveau:3, categorie:"Risico", vraag:"Zijn jullie binnen een straal van 300m van het Ladeuzeplein?"},
                {id:76, niveau:3, categorie:"Risico", vraag:"Stuur een 360 graden panoramafoto (hiders mogen gezicht verbergen)."},
                {id:77, niveau:3, categorie:"Risico", vraag:"Wat is de laatste letter van de straatnaam waar jullie zijn?"},
                {id:78, niveau:3, categorie:"Risico", vraag:"Film 5 seconden lang de grond terwijl je ronddraait."},
                {id:79, niveau:3, categorie:"Risico", vraag:"Geef een beschrijving van de persoon die het dichtst bij jullie staat (niet-speler)."},
                {id:80, niveau:3, categorie:"Risico", vraag:"Teken een ruwe schets van de plattegrond van jullie directe omgeving en stuur de foto."},
                {id:81, niveau:3, categorie:"Risico", vraag:"Stuur een foto van het hoogste punt dat jullie kunnen zien."},
                {id:82, niveau:3, categorie:"Risico", vraag:"Hoeveel ramen heeft het gebouw recht tegenover jullie?"},
                {id:83, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een object dat begint met de letter 'S'."},
                {id:84, niveau:3, categorie:"Risico", vraag:"Zijn jullie binnen de 'oude stadsomwalling' (binnenring)?"},
                {id:85, niveau:3, categorie:"Risico", vraag:"Beschrijf de schoenen van de dichtstbijzijnde voorbijganger."},
                {id:86, niveau:3, categorie:"Risico", vraag:"Wat is het laatste cijfer van het dichtstbijzijnde huisnummer?"},
                {id:87, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een patroon (kasseien, hekwerk) in de buurt."},
                {id:88, niveau:3, categorie:"Risico", vraag:"Hoeveel stappen ben je van de dichtstbijzijnde straathoek?"},
                {id:89, niveau:3, categorie:"Risico", vraag:"Zie je een 'Verboden' bord? Welke kleur?"},
                {id:90, niveau:3, categorie:"Risico", vraag:"Stuur een close-up van iets dat van hout is."},
                {id:91, niveau:3, categorie:"Risico", vraag:"Is er constructie/wegenwerken zichtbaar?"},
                {id:92, niveau:3, categorie:"Risico", vraag:"Zie je een uniform (politie, post, lijn)?"},
                {id:93, niveau:3, categorie:"Risico", vraag:"Stuur een foto van iets ouds/historisch (detail)."},
                {id:94, niveau:3, categorie:"Risico", vraag:"Stuur een foto van iets moderns/nieuws."},
                {id:95, niveau:3, categorie:"Risico", vraag:"Beschrijf de geur van de omgeving in 1 woord."},
                {id:96, niveau:3, categorie:"Risico", vraag:"Zie je een standbeeld?"},
                {id:97, niveau:3, categorie:"Risico", vraag:"Tel het aantal geparkeerde fietsen in zicht (ongeveer)."},
                {id:98, niveau:3, categorie:"Risico", vraag:"Stuur een foto van graffiti of een sticker in de buurt."},
                {id:99, niveau:3, categorie:"Risico", vraag:"Kun je de hemel zien of zit je ergens onder?"},
                {id:100, niveau:3, categorie:"Risico", vraag:"Is het hier stiller of luider dan op de Oude Markt?"},
                {id:101, niveau:3, categorie:"Risico", vraag:"Welke kleur hebben de kozijnen van het dichtstbijzijnde huis?"},
                {id:102, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een plant of bloem in de buurt."},
                {id:103, niveau:3, categorie:"Risico", vraag:"Zie je een brievenbus van Bpost?"},
                {id:104, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een straatnaambord (TEKST ONZICHTBAAR MAKEN)."},
                {id:105, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een object groter dan 1x1x1m in directe omgeving."}
            ],
            deck: [
                // TIJD (15 kaarten)
                {id:1, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:2, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:3, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:4, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:5, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:6, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:7, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:8, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:9, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:10, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:11, type:"Tijd", naam:"Bonus 15 Min", effect:"Eindtijd + 15 minuten.", taak:"Geen taak."},
                {id:12, type:"Tijd", naam:"Bonus 15 Min", effect:"Eindtijd + 15 minuten.", taak:"Geen taak."},
                {id:13, type:"Tijd", naam:"Bonus 15 Min", effect:"Eindtijd + 15 minuten.", taak:"Geen taak."},
                {id:14, type:"Tijd", naam:"Bonus 30 Min", effect:"Eindtijd + 30 minuten.", taak:"Geen taak."},
                {id:15, type:"Tijd", naam:"Bonus 1 Uur", effect:"Eindtijd + 1 Uur.", taak:"Geen taak."},

                // VLOEKEN (45 kaarten)
                {id:16, type:"Vloek", naam:"Freeze (2 min)", effect:"Zoekers moeten direct 2 minuten stilstaan.", taak:"Maak een selfie met een standbeeld (of paal)."},
                {id:17, type:"Vloek", naam:"Freeze (2 min)", effect:"Zoekers moeten direct 2 minuten stilstaan.", taak:"Maak een selfie met een standbeeld (of paal)."},
                {id:18, type:"Vloek", naam:"De Snack Pauze", effect:"Zoekers moeten een snack kopen/eten.", taak:"Overtuig een vreemde om te zwaaien."},
                {id:19, type:"Vloek", naam:"Achteruit", effect:"Zoekers moeten de volgende straat achteruit lopen.", taak:"Film 30 sec moonwalken."},
                {id:20, type:"Vloek", naam:"Hand in Hand", effect:"Zoekers lopen 5 min hand in hand.", taak:"Knoop elkaars veters aan elkaar."},
                {id:21, type:"Vloek", naam:"Op één been", effect:"Zoekers wachten 1 min op één been.", taak:"Sta 1 min op één been als een flamingo."},
                {id:22, type:"Vloek", naam:"Selfie Time", effect:"Zoekers moeten selfie maken met vreemde.", taak:"Maak zelf ook een selfie met vreemde."},
                {id:23, type:"Vloek", naam:"De Vloer is Lava", effect:"Zoekers mogen 3 min straat niet raken.", taak:"Klim ergens op (muurtje, bankje)."},
                {id:24, type:"Vloek", naam:"Slow Motion", effect:"Zoekers bewegen 2 min in slow-mo.", taak:"Film een slow-motion vechtscène."},
                {id:25, type:"Vloek", naam:"Tas Wissel", effect:"Zoekers wisselen rugzak/jas (10 min).", taak:"Doe je schoenen aan de verkeerde voeten."},
                {id:26, type:"Vloek", naam:"Sprintje", effect:"Zoekers trekken sprintje van 50m.", taak:"Doe 20 jumping jacks."},
                {id:27, type:"Vloek", naam:"Omweg Standbeeld", effect:"Zoekers lopen naar dichtstbijzijnde beeld.", taak:"Zing luidkeels het volkslied."},
                {id:28, type:"Vloek", naam:"Vraag Weigeren", effect:"Annuleer huidige vraag.", taak:"Bouw toren van 5 objecten (stenen, takjes)."},
                {id:29, type:"Vloek", naam:"Vraag Weigeren", effect:"Annuleer huidige vraag.", taak:"Bouw toren van 5 objecten."},
                {id:30, type:"Vloek", naam:"Splitsing", effect:"Zoekers gaan 200m uit elkaar (10 min).", taak:"Doe je jas binnenstebuiten aan."},
                {id:31, type:"Vloek", naam:"Links Afslaan", effect:"Zoekers slaan enkel links af (5 min).", taak:"Draai 10 rondjes om je as."},
                {id:32, type:"Vloek", naam:"Geen Maps", effect:"Zoekers: 5 min geen Google Maps.", taak:"Teken een portret van elkaar in 30 sec."},
                {id:33, type:"Vloek", naam:"De Polonaise", effect:"Zoekers lopen 2 min in polonaise.", taak:"Doe de kabouterdans met bewegingen."},
                {id:34, type:"Vloek", naam:"Vogelspotter", effect:"Zoekers moeten duif fotograferen.", taak:"Doe een vogel na (geluid + wapperen)."},
                {id:35, type:"Vloek", naam:"Bus Roulette", effect:"Zoekers nemen bus voor 1 halte (indien mogelijk).", taak:"Film 1 minuut Macarena dansen."},
                {id:36, type:"Vloek", naam:"De Noodklok", effect:"Zoekers moeten kerkdeur aanraken.", taak:"Draag een gedicht voor over de zoekers."},
                {id:37, type:"Vloek", naam:"Blinddoek", effect:"1 Zoeker wordt 5 min geblinddoekt.", taak:"Sta 1 minuut roerloos stil als standbeeld."},
                {id:38, type:"Vloek", naam:"De Toerist", effect:"Zoekers vragen weg aan voorbijganger.", taak:"Spreek voorbijganger aan en wens ze een fijne dag."},
                {id:39, type:"Vloek", naam:"Waterdrager", effect:"Zoekers moeten flesje water atten.", taak:"Doe 10 push-ups in het openbaar."},
                {id:40, type:"Vloek", naam:"Papegaai", effect:"Zoekers herhalen alles wat 1 iemand zegt (5m).", taak:"Praat 1 min tegen lantaarnpaal."},
                {id:41, type:"Vloek", naam:"Hinkelen", effect:"Zoekers moeten 50m hinkelen.", taak:"Hinkelen zelf 1 minuut."},
                {id:42, type:"Vloek", naam:"Stilte (5 min)", effect:"Zoekers niet praten/typen.", taak:"Wees 5 minuten doodstil (geen geluid)."},
                {id:43, type:"Vloek", naam:"De Mol", effect:"Zoekers delen 5 min live locatie.", taak:"Zoek een foto van een mol op Google."},
                {id:44, type:"Vloek", naam:"Alleen Fietsen", effect:"Zoekers moeten 15 min alles fietsen.", taak:"Sta 3 minuten rug-aan-rug, ogen dicht."},
                {id:45, type:"Vloek", naam:"Alleen Lopen", effect:"Zoekers moeten 15 min alles lopen.", taak:"Zing 1 minuut luidkeels een lied."},
                {id:46, type:"Vloek", naam:"Brug Tol", effect:"Binnen 5 min andere brug oversteken.", taak:"Maak een \"brug\" met lichaam (30s)."},
                {id:47, type:"Vloek", naam:"Omweg Oude Markt", effect:"Zoekers moeten naar Oude Markt.", taak:"Vind object met letter 'O'."},
                {id:48, type:"Vloek", naam:"Oriëntatie", effect:"Zoekers 10 min geen kompas/draaien.", taak:"Draai 1 min langzaam rondjes."},
                {id:49, type:"Vloek", naam:"Pad Blokkeren", effect:"Kies straat waar zoekers niet in mogen (20m).", taak:"Bouw barricade van takjes."},
                {id:50, type:"Vloek", naam:"Stille Zone", effect:"Zoekers 15 min niet praten/typen.", taak:"Wees 5 min doodstil."},
                {id:51, type:"Vloek", naam:"Tijdelijke Afleiding", effect:"Hiders bellen zoekers 1 min.", taak:"Verkoop product zonder 'uhm' te zeggen."},
                {id:52, type:"Vloek", naam:"Rode Licht", effect:"Wachten bij elk rood licht (ook spooklichten).", taak:"Doe 20 Jumping Jacks."},
                {id:53, type:"Vloek", naam:"Veter Foltering", effect:"1 Zoeker moet veters opnieuw strikken.", taak:"Doe schoenen verkeerd om aan."},
                {id:54, type:"Vloek", naam:"Kunst Jacht", effect:"Zoekers moeten kunstwerk vinden.", taak:"Bedenk raadsel over locatie."},
                {id:55, type:"Vloek", naam:"Verkeerde Afslag", effect:"Zoekers moeten 200m teruglopen.", taak:"Loop 3 min achteruit in cirkel."},
                {id:56, type:"Vloek", naam:"Lied van Leuven", effect:"Zoekers zingen lied over Leuven.", taak:"Doe een dier na (1 min)."},
                {id:57, type:"Vloek", naam:"Zoeker Afleiden", effect:"Zoekers dansen Macarena.", taak:"Dans Macarena zonder muziek."},
                {id:58, type:"Vloek", naam:"Zoeker Ruil", effect:"Zoekers wisselen jas/tas (10 min).", taak:"Trek sokken over broekspijpen."},
                {id:59, type:"Vloek", naam:"Ruisonderdrukking", effect:"Hiders wachten 10 min met antwoord.", taak:"Zit 2 min vingers in oren, ogen dicht."},
                {id:60, type:"Vloek", naam:"Vertraging", effect:"Zoekers 2 min stilstaan.", taak:"Doe maanlanding in slow-mo."},
                {id:61, type:"Vloek", naam:"Verwarring", effect:"Zoekers 5 min naar Noorden lopen.", taak:"Wijs 1 min naar willekeurige richtingen."},

                // BONUS (18 kaarten)
                {id:62, type:"Bonus", naam:"Locatie Wissel", effect:"Hiders verplaatsen zich 5 min (rennend).", taak:"Roep \"WIJ ZIJN BANG\"."},
                {id:63, type:"Bonus", naam:"De Mime", effect:"Zoekers zwijgen 10 min, enkel gebaren.", taak:"Beeld film uit (zoekers raden)."},
                {id:64, type:"Bonus", naam:"De Leugen", effect:"Lieg op de VOLGENDE vraag.", taak:"Eet iets zuurs/vies (veilig)."},
                {id:65, type:"Bonus", naam:"Mist", effect:"Zoekers mogen 15 min GEEN vragen stellen.", taak:"Houd 1 min elkaars hand vast."},
                {id:66, type:"Bonus", naam:"Camouflage", effect:"Stuur foto ander persoon bij beschrijving.", taak:"Verberg gezicht volledig (5 min)."},
                {id:67, type:"Bonus", naam:"Radar Jammer", effect:"Zoekers zetten live locatie uit (10 min).", taak:"Roep 10x \"KEKO KEKO!\"."},
                {id:68, type:"Bonus", naam:"Safehouse", effect:"Zoekers wachten 2 min voor tikken.", taak:"Maak kunstwerk van afval."},
                {id:69, type:"Bonus", naam:"Copycat", effect:"Kopieer effect van vorige kaart nog eens.", taak:"Doe de vorige opdracht nog eens, maar 2x sneller."},
                {id:70, type:"Bonus", naam:"Herpositioneren", effect:"Hiders verplaatsen 2 min (Nieuwe plek).", taak:"Roep \"WIJ VERPLAATSEN\"."},
                {id:71, type:"Bonus", naam:"Noodontsnapping", effect:"Verplaats 50m (als zoekers <100m).", taak:"Ren rondje om verstopplek."},
                {id:72, type:"Bonus", naam:"Onzichtbaar", effect:"2 min radiostilte.", taak:"Lig 1 min plat op de grond."},
                {id:73, type:"Bonus", naam:"Souvenir", effect:"Zoekers kopen souvenir voor hiders.", taak:"Maak bedankvideo."},
                {id:74, type:"Bonus", naam:"Snelle Ontsnapping", effect:"Verplaats 200m (Immobiliteit verbroken).", taak:"Foto van voeten in de lucht."},
                {id:75, type:"Bonus", naam:"Stealth Modus", effect:"10 min geen vragen.", taak:"Fluister 1 minuut lang."},
                {id:76, type:"Bonus", naam:"Tijd Rekken", effect:"Zoekers wachten 5 min extra op antwoord.", taak:"Tel hardop tot 60 in Engels."},
                {id:77, type:"Bonus", naam:"Upgrade", effect:"Huidige plek \"Extra Goed\" (+10 min).", taak:"Maak reclamepraatje over plek."},
                {id:78, type:"Bonus", naam:"Vraag Blok", effect:"Weiger huidige vraag.", taak:"Bouw kaartenhuis."},
                {id:79, type:"Bonus", naam:"Trekken", effect:"Gooi kaarten weg, trek nieuwe.", taak:"Schud denkbeeldige kaarten (30s)."}
            ]
        };

        let currentUser = null;
        let currentLobby = null;
        let myRole = null;
        let allQuestions = [];
        let allCards = [];
        let activeQuestionId = null;
        let gameState = {};
        let timerInterval = null;
        let activeCurses = [];

        // --- AUTH & LOBBY ---
        window.joinLobby = async () => {
            const btn = document.getElementById('join-btn');
            btn.innerText = "Laden...";
            btn.disabled = true;

            const name = document.getElementById('username').value;
            const lobby = document.getElementById('lobbycode').value.toUpperCase();
            
            if(!name || !lobby) {
                btn.innerText = "JOIN GAME";
                btn.disabled = false;
                return alert("Vul naam en lobby in");
            }

            try {
                await signInAnonymously(auth);
                currentUser = { uid: auth.currentUser.uid, name: name };
                currentLobby = lobby;

                document.getElementById('display-lobby').innerText = lobby;
                document.getElementById('display-user').innerText = name;

                const lobbyRef = ref(db, `lobbies/${lobby}`);
                const snapshot = await get(lobbyRef);

                if (!snapshot.exists()) {
                    await set(lobbyRef, {
                        created: serverTimestamp(),
                        questions: GAME_DATA.questions,
                        deck: GAME_DATA.deck,
                        status: 'idle',
                        activeCurses: {}, 
                        logs: { "init": { msg: `Lobby ${lobby} aangemaakt door ${name}`, time: Date.now() } }
                    });
                } else {
                    push(ref(db, `lobbies/${lobby}/logs`), {
                        msg: `${name} is het spel binnengekomen.`,
                        time: Date.now()
                    });
                }

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('role-screen').classList.remove('hidden');
                listenToGame();

            } catch (error) {
                console.error(error);
                alert("Verbindingsfout. Zorg dat je 'Anonymous Authentication' hebt aangezet in Firebase Console.");
                btn.innerText = "JOIN GAME";
                btn.disabled = false;
            }
        };

        window.selectRole = (role) => {
            myRole = role;
            document.getElementById('role-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            const badge = document.getElementById('role-badge');
            badge.innerText = role.toUpperCase();
            badge.className = `px-3 py-1 rounded-full font-black text-xs tracking-wider ${role === 'hider' ? 'bg-yellow-500 text-black shadow-[0_0_10px_rgba(234,179,8,0.5)]' : 'bg-blue-500 text-white shadow-[0_0_10px_rgba(59,130,246,0.5)]'}`;

            const icon = document.getElementById('role-icon');
            icon.innerHTML = role === 'hider' ? '<i class="fa-solid fa-user-secret text-yellow-400"></i>' : '<i class="fa-solid fa-binoculars text-blue-400"></i>';

            if(role === 'hider') document.getElementById('hider-view').classList.remove('hidden');
            if(role === 'seeker') {
                document.getElementById('seeker-view').classList.remove('hidden');
                filterQuestions(1); 
            }
        };

        // --- GAME SYNC ---
        function listenToGame() {
            const lobbyRef = ref(db, `lobbies/${currentLobby}`);
            onValue(lobbyRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) return;

                allQuestions = data.questions || [];
                allCards = data.deck || [];
                gameState = { status: data.status, questionId: data.activeQuestion, startTime: data.timerStart };
                activeCurses = data.activeCurses ? Object.entries(data.activeCurses) : [];
                const logs = data.logs || {};

                updateUI();
                updateLogs(logs);
                handleTimer();
                handleCurseOverlay();
            });
        }

        function handleTimer() {
            clearInterval(timerInterval);
            const timerDiv = document.getElementById('timer-container');
            const display = document.getElementById('countdown-display');

            if(gameState.status === 'answering' && gameState.startTime) {
                timerDiv.classList.remove('hidden');
                
                timerInterval = setInterval(() => {
                    const now = Date.now();
                    const diff = 180000 - (now - gameState.startTime); // 3 mins

                    if(diff <= 0) {
                        display.innerText = "00:00";
                        timerDiv.classList.replace('bg-red-600', 'bg-gray-800');
                    } else {
                        const m = Math.floor(diff / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        display.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    }
                }, 1000);
            } else {
                timerDiv.classList.add('hidden');
            }
        }

        // --- CURSE LOGIC ---
        function handleCurseOverlay() {
            const overlay = document.getElementById('curse-overlay');
            const list = document.getElementById('active-curses-list');
            
            if (activeCurses.length > 0 && myRole === 'seeker') {
                overlay.classList.remove('hidden');
                list.innerHTML = '';
                
                activeCurses.forEach(([key, curse]) => {
                    const div = document.createElement('div');
                    div.className = "bg-gray-800 p-4 rounded-xl border border-red-500 mb-3 relative overflow-hidden";
                    div.innerHTML = `
                        <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                        <h4 class="font-black text-yellow-400 text-xl mb-1">${curse.naam}</h4>
                        <p class="text-white font-bold mb-2">${curse.effect}</p>
                        <div class="bg-black/30 p-2 rounded text-xs text-gray-400 italic mb-4">
                            <i class="fa-solid fa-camera mr-1"></i> Taak voor Hiders was: ${curse.taak}
                        </div>
                        <button onclick="clearCurse('${key}')" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg transition transform hover:scale-[1.02] active:scale-95 shadow-lg">
                            <i class="fa-solid fa-check mr-2"></i> Taak/Tijd is Voorbij
                        </button>
                    `;
                    list.appendChild(div);
                });
            } else {
                overlay.classList.add('hidden');
            }
        }

        window.clearCurse = (curseKey) => {
            if(!confirm("Zijn jullie zeker dat deze vloek voorbij is of de taak voltooid is?")) return;
            remove(ref(db, `lobbies/${currentLobby}/activeCurses/${curseKey}`));
            
            push(ref(db, `lobbies/${currentLobby}/logs`), {
                msg: `Vloek opgeheven door zoekers.`,
                time: Date.now()
            });
        };

        function updateUI() {
            // Hider Panel Updates
            const panel = document.getElementById('hider-action-panel');
            if(myRole === 'hider' && gameState.status === 'answering') {
                const q = allQuestions.find(qu => qu.id == gameState.questionId);
                if(q) {
                    panel.classList.remove('hidden');
                    document.getElementById('current-question-text').innerText = q.vraag;
                    document.getElementById('current-question-level').innerText = q.niveau;
                }
            } else {
                panel.classList.add('hidden');
            }

            // Update Hand (Hider View)
            if(myRole === 'hider') {
                const myHand = allCards.filter(c => c.status === 'hand');
                document.getElementById('hand-count').innerText = myHand.length;
                const handContainer = document.getElementById('hider-hand');
                handContainer.innerHTML = "";
                
                if(myHand.length === 0) {
                    handContainer.innerHTML = '<p class="text-gray-500 text-sm italic text-center py-8">Je hebt nog geen kaarten.</p>';
                } else {
                    myHand.forEach(card => {
                        const div = document.createElement('div');
                        div.className = "bg-gray-700 p-4 rounded-xl border border-gray-600 flex justify-between items-center shadow-lg relative overflow-hidden group";
                        
                        // Type Badge Logic
                        let typeColor = "bg-gray-500";
                        if(card.type === "Vloek") typeColor = "bg-red-500";
                        if(card.type === "Tijd") typeColor = "bg-green-500";
                        if(card.type === "Bonus") typeColor = "bg-blue-500";

                        div.innerHTML = `
                            <div class="absolute top-0 right-0 ${typeColor} text-[8px] font-bold text-white px-2 py-0.5 rounded-bl uppercase tracking-wider">${card.type}</div>
                            <div class="w-2/3 pr-2">
                                <div class="font-bold text-sm text-yellow-400 leading-tight mb-1">${card.naam}</div>
                                <div class="text-[10px] text-gray-300 leading-snug mb-1">${card.effect}</div>
                                <div class="text-[9px] text-red-300 italic"><i class="fa-solid fa-camera mr-1"></i>${card.taak}</div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button onclick="playCard('${card.id}')" class="bg-green-600 hover:bg-green-500 text-white text-[10px] font-bold px-3 py-1.5 rounded uppercase tracking-wide shadow transition transform active:scale-95">Speel</button>
                                <button onclick="discardCard('${card.id}')" class="bg-red-900/50 hover:bg-red-900 text-red-200 text-[10px] font-bold px-3 py-1.5 rounded uppercase tracking-wide transition">Weg</button>
                            </div>
                        `;
                        handContainer.appendChild(div);
                    });
                }
            }

            // Refresh Seeker list
            if(myRole === 'seeker') {
                const activeBtn = document.querySelector('#seeker-view button.ring-2');
                if(activeBtn) {
                    // check ID to determine level
                    if(activeBtn.id === 'btn-lvl-1') filterQuestions(1);
                    if(activeBtn.id === 'btn-lvl-2') filterQuestions(2);
                    if(activeBtn.id === 'btn-lvl-3') filterQuestions(3);
                } else {
                    filterQuestions(1);
                }
            }
        }

        // --- ACTIONS ---

        window.filterQuestions = (level) => {
            const list = document.getElementById('questions-list');
            list.innerHTML = "";
            
            // Buttons visual state
            const btn1 = document.getElementById('btn-lvl-1');
            const btn2 = document.getElementById('btn-lvl-2');
            const btn3 = document.getElementById('btn-lvl-3');
            
            [btn1, btn2, btn3].forEach(b => {
                b.classList.remove('ring-2', 'ring-white', 'bg-opacity-100');
                b.classList.add('bg-opacity-50');
                b.dataset.active = "false";
            });

            const activeBtn = level === 1 ? btn1 : level === 2 ? btn2 : btn3;
            activeBtn.classList.add('ring-2', 'ring-white');
            activeBtn.dataset.active = "true";

            const filtered = allQuestions.filter(q => q.niveau == level && !q.used);
            
            if(filtered.length === 0) {
                list.innerHTML = `<div class="bg-gray-800/50 p-8 rounded-xl text-center border border-gray-700 border-dashed">
                    <i class="fa-solid fa-check-circle text-3xl text-gray-600 mb-2"></i>
                    <div class="text-gray-500 italic">Geen vragen meer in dit niveau.</div>
                </div>`;
                return;
            }

            const grouped = {};
            filtered.forEach(q => {
                if(!grouped[q.categorie]) grouped[q.categorie] = [];
                grouped[q.categorie].push(q);
            });

            for (const [cat, questions] of Object.entries(grouped)) {
                list.innerHTML += `<div class="cat-header"><i class="fa-solid fa-folder-open mr-2 opacity-50"></i>${cat}</div>`;
                questions.forEach(q => {
                    const div = document.createElement('div');
                    div.className = "bg-gray-700 p-4 rounded-xl border border-gray-600 cursor-pointer hover:border-blue-400 hover:bg-gray-600 transition shadow-sm mt-2 group relative overflow-hidden";
                    div.onclick = () => askQuestion(q.id);
                    div.innerHTML = `
                        <div class="text-sm font-bold text-gray-200 pr-6">${q.vraag}</div>
                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-chevron-right"></i>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        };

        window.askQuestion = (qid) => {
            if(!confirm("Wil je deze vraag stellen?")) return;
            const index = allQuestions.findIndex(q => q.id == qid);
            if(index === -1) return;

            const updates = {};
            updates[`lobbies/${currentLobby}/questions/${index}/used`] = true;
            updates[`lobbies/${currentLobby}/status`] = 'answering';
            updates[`lobbies/${currentLobby}/activeQuestion`] = qid;
            updates[`lobbies/${currentLobby}/timerStart`] = Date.now();
            
            update(ref(db), updates);
            
            push(ref(db, `lobbies/${currentLobby}/logs`), {
                msg: `${currentUser.name} stelde vraag: "${allQuestions[index].vraag}"`,
                time: Date.now()
            });
        };

        window.confirmAnswer = () => {
            const q = allQuestions.find(qu => qu.id == gameState.questionId);
            let drawAmount = q.niveau;
            if(q.categorie === 'Foto' || q.categorie === 'Risico') drawAmount = 3;

            if(!confirm(`Bevestig dat je geantwoord hebt. Je mag nu ${drawAmount} kaarten trekken.`)) return;

            update(ref(db, `lobbies/${currentLobby}/status`), 'idle'); 
            initiateDraw(drawAmount);
        };

        function initiateDraw(amount) {
            const deck = allCards.filter(c => !c.status || c.status === 'deck');
            if(deck.length < 1) return alert("Deck is leeg!");

            const selection = [];
            let tempDeck = [...deck];
            for(let i=0; i<amount; i++) {
                if(tempDeck.length === 0) break;
                const r = Math.floor(Math.random() * tempDeck.length);
                selection.push(tempDeck[r]);
                tempDeck.splice(r, 1);
            }

            const currentHand = allCards.filter(c => c.status === 'hand');
            if(currentHand.length >= 6) {
                showOverflowModal(currentHand, selection);
            } else {
                if(amount === 1) {
                    addToHand(selection[0].id);
                } else {
                    showSelectionModal(selection);
                }
            }
        }

        function showSelectionModal(cards) {
            const modal = document.getElementById('card-modal');
            const container = document.getElementById('modal-cards');
            container.innerHTML = "";
            
            cards.forEach(c => {
                let typeColor = "text-gray-400";
                if(c.type === "Vloek") typeColor = "text-red-400";
                if(c.type === "Bonus") typeColor = "text-blue-400";
                if(c.type === "Tijd") typeColor = "text-green-400";

                const div = document.createElement('div');
                div.className = "bg-gray-800 p-4 rounded-xl border border-gray-700 cursor-pointer hover:border-yellow-400 transition hover:bg-gray-700 relative";
                div.onclick = () => { addToHand(c.id); closeModal(); };
                div.innerHTML = `
                    <div class="absolute top-2 right-2 text-[10px] uppercase font-bold ${typeColor} border border-current px-1 rounded">${c.type}</div>
                    <div class="font-black text-yellow-400 mb-1">${c.naam}</div>
                    <div class="text-xs text-white mb-2 leading-snug">${c.effect}</div>
                    <div class="text-[10px] text-gray-400 italic bg-black/20 p-2 rounded"><i class="fa-solid fa-camera mr-1"></i> ${c.taak}</div>
                `;
                container.appendChild(div);
            });
            modal.classList.remove('hidden');
        }

        function showOverflowModal(handCards, newCards) {
            const modal = document.getElementById('overflow-modal');
            const newContainer = document.getElementById('overflow-new-cards');
            const handContainer = document.getElementById('overflow-hand-cards');
            
            modal.classList.remove('hidden');
            newContainer.innerHTML = "";
            handContainer.innerHTML = "";

            // New Cards
            newCards.forEach(c => {
                const div = document.createElement('div');
                div.className = "bg-gray-800 p-3 rounded-lg border border-green-500/50 cursor-pointer hover:bg-green-900/20 text-xs flex justify-between items-center group";
                div.innerHTML = `<span class="font-bold text-white group-hover:text-green-400 transition">${c.naam}</span> <i class="fa-solid fa-plus text-green-500"></i>`;
                div.onclick = () => {
                    addToHandSilent(c.id); 
                    modal.classList.add('hidden');
                    alert("Kaart toegevoegd. Nu heb je er teveel. Gooi er eentje weg via je hand.");
                };
                newContainer.appendChild(div);
            });

            // Hand Cards (Alternative: Swap directly)
            handCards.forEach(c => {
               const div = document.createElement('div');
               div.className = "bg-gray-800 p-3 rounded-lg border border-red-500/50 cursor-pointer hover:bg-red-900/20 text-xs flex justify-between items-center group";
               div.innerHTML = `<span class="font-bold text-white group-hover:text-red-400 transition">${c.naam}</span> <i class="fa-solid fa-trash text-red-500"></i>`;
               div.onclick = () => {
                   discardCardSilent(c.id);
                   // Then allow picking the new one (simplified flow: just drop hand count first)
                   alert("Kaart weggegooid. Kies nu je nieuwe kaart.");
                   // Re-render modal logic or just keep modal open but update hand list? 
                   // Simplified for robustness: Just close modal and restart draw logic or assume user clicked 'New' first.
                   // Let's stick to: Pick NEW card -> Auto add -> Then user must manually discard from main screen because UI shows >6.
               };
               // handContainer.appendChild(div); 
               // In this UI flow, we force adding first.
            });
            // We only show New Cards to ADD. Discarding happens in main view if Hand > 6.
            handContainer.innerHTML = "<p class='text-gray-500 italic text-[10px] text-center'>Klik op een nieuwe kaart om toe te voegen.<br>Gooi daarna een oude weg via het dashboard.</p>";
        }

        function addToHand(cid) {
            const index = allCards.findIndex(c => c.id == cid);
            update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'hand' });
            push(ref(db, `lobbies/${currentLobby}/logs`), { msg: `Hiders hebben kaart getrokken.`, time: Date.now() });
        }

        function addToHandSilent(cid) {
            const index = allCards.findIndex(c => c.id == cid);
            update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'hand' });
        }

        function discardCardSilent(cid) {
             const index = allCards.findIndex(c => c.id == cid);
             update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'discarded' });
        }

        window.playCard = (cid) => {
            if(!confirm("Kaart spelen? Taak gedaan?")) return;
            const index = allCards.findIndex(c => c.id == cid);
            const card = allCards[index];
            
            update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'played' });
            
            if(card.type === 'Vloek') {
                push(ref(db, `lobbies/${currentLobby}/activeCurses`), card);
            }
            
            push(ref(db, `lobbies/${currentLobby}/logs`), { msg: `⚡ VLOEK: ${card.naam}!`, time: Date.now() });
        };

        window.discardCard = (cid) => {
            if(!confirm("Kaart weggooien?")) return;
            const index = allCards.findIndex(c => c.id == cid);
            update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'discarded' });
        };

        window.closeModal = () => document.getElementById('card-modal').classList.add('hidden');
        window.finishOverflow = () => document.getElementById('overflow-modal').classList.add('hidden');

        function updateLogs(logsObj) {
            const logDiv = document.getElementById('game-log');
            logDiv.innerHTML = "";
            const entries = Object.values(logsObj).sort((a,b) => b.time - a.time);
            entries.forEach(l => {
                const date = new Date(l.time);
                const timeStr = `${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                logDiv.innerHTML += `<div class="border-b border-gray-700 pb-2 mb-2 last:border-0"><span class="text-gray-500 font-mono text-[10px] mr-2">${timeStr}</span> <span class="text-gray-300">${l.msg}</span></div>`;
            });
        }

        // Expose functions
        window.joinLobby = joinLobby;
        window.selectRole = selectRole;
        window.playCard = playCard;
        window.discardCard = discardCard;
        window.filterQuestions = filterQuestions;
        window.askQuestion = askQuestion;
        window.closeModal = closeModal;
        window.confirmAnswer = confirmAnswer;
        window.clearCurse = clearCurse;
        window.finishOverflow = () => document.getElementById('overflow-modal').classList.add('hidden');
    </script>
</body>
</html>

