<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leuven Hunt - Risk & Reward</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #111827; color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* UI Components */
        .card-base { background: #1f2937; border: 1px solid #374151; border-radius: 12px; overflow: hidden; }
        .btn-primary { background-color: #eab308; color: #000; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; box-shadow: 0 4px 6px -1px rgba(234, 179, 8, 0.2); }
        .btn-primary:active { transform: scale(0.98); }
        
        /* Categorie Header voor Vragen */
        .cat-header { 
            background: #374151; color: #fbbf24; 
            font-size: 0.7rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;
            padding: 8px 12px; border-radius: 6px; margin-top: 16px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 8px; border-left: 4px solid #fbbf24;
        }

        /* Animaties */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .curse-mode { animation: pulse-red 2s infinite; border: 2px solid #ef4444; }
        
        /* Utility */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="view-login" class="flex-1 flex flex-col items-center justify-center p-6 space-y-8 z-50 bg-gray-900 absolute inset-0">
        <div class="text-center animate-bounce">
            <i class="fa-solid fa-map-location-dot text-6xl text-yellow-400"></i>
        </div>
        <div class="text-center">
            <h1 class="text-5xl font-black text-white tracking-tighter leading-none">LEUVEN<br><span class="text-yellow-400">HUNT</span></h1>
            <p class="text-gray-500 text-sm mt-2 font-mono">RISK & REWARD</p>
        </div>
        
        <div class="w-full max-w-sm space-y-4">
            <input type="text" id="inp-name" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 text-white font-bold focus:border-yellow-400 outline-none transition" placeholder="Jouw Naam">
            <input type="text" id="inp-lobby" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 text-white font-bold uppercase tracking-widest focus:border-yellow-400 outline-none transition" placeholder="LOBBY CODE (bv. LEUVEN1)">
            <button onclick="app.join()" id="btn-join" class="w-full btn-primary p-4 rounded-xl text-lg transition hover:bg-yellow-300">START SPEL</button>
        </div>
        <p class="text-xs text-gray-600 text-center max-w-xs">Zorg dat iedereen dezelfde Lobby Code gebruikt.</p>
    </div>

    <div id="view-role" class="hidden flex-1 flex flex-col items-center justify-center p-6 space-y-6 z-40 bg-gray-900 absolute inset-0">
        <h2 class="text-2xl font-bold text-white uppercase">Kies je Team</h2>
        <div class="grid grid-cols-2 gap-4 w-full max-w-md">
            <button onclick="app.setRole('hider')" class="bg-gray-800 p-6 rounded-2xl border-2 border-gray-700 hover:border-yellow-400 hover:bg-gray-750 transition group flex flex-col items-center gap-3">
                <i class="fa-solid fa-user-secret text-5xl text-gray-400 group-hover:text-yellow-400 transition-colors"></i>
                <div class="font-black text-xl text-white">HIDERS</div>
                <span class="text-[10px] text-gray-500 text-center">Verstoppen, kaarten spelen & taken uitvoeren.</span>
            </button>
            <button onclick="app.setRole('seeker')" class="bg-gray-800 p-6 rounded-2xl border-2 border-gray-700 hover:border-blue-400 hover:bg-gray-750 transition group flex flex-col items-center gap-3">
                <i class="fa-solid fa-binoculars text-5xl text-gray-400 group-hover:text-blue-400 transition-colors"></i>
                <div class="font-black text-xl text-white">ZOEKERS</div>
                <span class="text-[10px] text-gray-500 text-center">Vragen stellen, jagen & straffen ondergaan.</span>
            </button>
        </div>
    </div>

    <div id="view-game" class="hidden flex-1 flex flex-col w-full max-w-lg mx-auto relative bg-gray-900 h-full">
        
        <div class="bg-gray-800 p-3 shadow-lg z-30 flex justify-between items-center border-b border-gray-700">
            <div>
                <div class="text-[10px] font-bold text-gray-500 uppercase">Lobby: <span id="lbl-lobby" class="text-white">...</span></div>
                <div class="text-sm font-bold text-white truncate max-w-[120px]" id="lbl-user">...</div>
            </div>
            
            <div id="penalty-box" class="bg-red-900/30 border border-red-500/50 px-3 py-1 rounded text-center mx-2">
                <div class="text-[9px] text-red-400 font-bold uppercase">STRAF</div>
                <div class="text-xs font-mono font-bold text-white"><span id="lbl-penalty">0</span>m</div>
            </div>

            <div id="role-badge" class="px-3 py-1 rounded-full font-black text-[10px] tracking-wider uppercase border border-white/10">...</div>
        </div>

        <div id="timer-bar" class="hidden bg-gray-800 border-b border-blue-500 p-2 flex justify-center items-center gap-2 shadow-xl z-20">
            <i class="fa-solid fa-stopwatch text-blue-400 animate-pulse"></i>
            <span class="text-gray-400 text-xs font-bold uppercase">Antwoorden binnen:</span>
            <span id="lbl-timer" class="font-mono text-xl font-bold text-white">03:00</span>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 hide-scrollbar pb-24 relative" id="main-content">
            
            <div id="seeker-panel" class="hidden space-y-4">
                <div class="text-center mb-2">
                    <h3 class="text-white font-bold text-lg">STEL EEN VRAAG</h3>
                    <p class="text-xs text-gray-400">Hoe hoger het niveau, hoe meer kaarten de hiders krijgen.</p>
                </div>

                <div class="grid grid-cols-3 gap-1 bg-gray-800 p-1 rounded-xl sticky top-0 z-10 shadow-lg border border-gray-700">
                    <button onclick="app.renderQuestions(1)" id="btn-lvl-1" class="py-3 rounded-lg text-xs font-bold uppercase transition-colors">Niveau 1<br><span class="text-[9px] opacity-70">1 Kaart</span></button>
                    <button onclick="app.renderQuestions(2)" id="btn-lvl-2" class="py-3 rounded-lg text-xs font-bold uppercase transition-colors">Niveau 2<br><span class="text-[9px] opacity-70">2 Kaarten</span></button>
                    <button onclick="app.renderQuestions(3)" id="btn-lvl-3" class="py-3 rounded-lg text-xs font-bold uppercase transition-colors">Niveau 3<br><span class="text-[9px] opacity-70">3 Kaarten</span></button>
                </div>
                <div id="question-list-container" class="space-y-2 pb-10"></div>
            </div>

            <div id="hider-panel" class="hidden card-base p-6 border-blue-500 border-2 bg-gradient-to-br from-blue-900/50 to-gray-800 text-center space-y-4 animate-pulse">
                <div class="inline-block bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded uppercase">Nieuwe Vraag</div>
                <h3 id="hp-question" class="text-xl font-bold text-white leading-tight">...</h3>
                <div class="text-xs text-blue-300 font-mono">Niveau <span id="hp-level">...</span> - <span id="hp-reward">...</span> Kaarten trekken</div>
                
                <div class="text-xs text-gray-400 bg-black/30 p-3 rounded italic text-left">
                    <i class="fa-brands fa-whatsapp mr-1 text-green-400"></i> <strong class="text-white">Stap 1:</strong> Stuur je antwoord/foto/locatie in de WhatsApp groep.
                </div>

                <button onclick="app.hiderConfirmAnswer()" class="w-full bg-white text-blue-900 font-black p-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> BEVESTIG & TREK KAARTEN
                </button>
            </div>

            <div id="hider-hand-wrapper" class="hidden">
                <div class="flex justify-between items-end mb-2 px-1 border-b border-gray-700 pb-2">
                    <h3 class="text-sm font-bold text-gray-400 uppercase"><i class="fa-solid fa-hand"></i> Jouw Hand</h3>
                    <span class="text-xs font-mono bg-gray-800 text-gray-300 px-2 py-1 rounded border border-gray-600"><span id="lbl-hand-count">0</span>/6</span>
                </div>
                <div id="hand-list" class="space-y-3"></div>
            </div>

            <div class="card-base p-4 mt-8">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest border-b border-gray-700 pb-1">Tijdlijn</h3>
                <div id="log-list" class="text-xs space-y-2 text-gray-400 font-mono h-32 overflow-y-auto flex flex-col-reverse"></div>
            </div>

        </div>

        <div id="overlay-seeker-wait" class="hidden absolute inset-0 bg-gray-900/95 z-40 flex flex-col items-center justify-center text-center p-8 backdrop-blur-sm">
            <i class="fa-solid fa-hourglass-half text-5xl text-blue-500 mb-4 animate-bounce"></i>
            <h3 class="text-2xl font-black text-white">WACHTEN...</h3>
            <p class="text-gray-400 mt-2">Hiders zijn aan het antwoorden.</p>
            <div id="seeker-timer-display" class="mt-4 font-mono text-xl text-blue-400">00:00</div>
        </div>

        <div id="overlay-curse" class="hidden absolute inset-0 bg-red-950/98 z-50 flex flex-col items-center justify-center p-6 text-center backdrop-blur overflow-y-auto">
            <i class="fa-solid fa-triangle-exclamation text-6xl text-red-500 mb-6 animate-pulse"></i>
            <h2 class="text-4xl font-black text-white mb-2 uppercase tracking-tighter">VLOEK ACTIEF!</h2>
            <p class="text-red-200 mb-8 text-sm">Geen vragen mogelijk tot de taak voltooid is.</p>
            <div id="active-curses-container" class="w-full space-y-4 max-w-sm"></div>
        </div>

    </div>

    <div id="modal-pick" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl p-6 border border-yellow-500 max-h-[80vh] flex flex-col shadow-2xl shadow-yellow-500/20">
            <h3 class="text-center font-bold text-yellow-400 text-xl mb-1">KIES 1 KAART</h3>
            <p class="text-center text-gray-500 text-xs mb-4">Je mag er maar eentje houden.</p>
            <div id="pick-list" class="space-y-3 overflow-y-auto flex-1 pr-1"></div>
        </div>
    </div>

    <div id="modal-discard" class="hidden fixed inset-0 bg-black/95 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-md rounded-2xl p-6 border-2 border-red-500 max-h-[90vh] flex flex-col shadow-2xl shadow-red-500/20">
            <div class="text-center mb-4">
                <i class="fa-solid fa-ban text-red-500 text-3xl mb-2"></i>
                <h3 class="text-xl font-black text-white">HAND VOL! (6/6)</h3>
                <p class="text-xs text-gray-400">Je moet kaarten weggooien om verder te kunnen.</p>
            </div>
            
            <div class="text-[10px] uppercase font-bold text-green-400 mb-2">Net Getrokken (Wil je deze houden?):</div>
            <div id="discard-new-list" class="space-y-2 mb-4"></div>

            <div class="text-[10px] uppercase font-bold text-blue-400 mb-2">Huidige Hand (Klik om weg te gooien):</div>
            <div id="discard-hand-list" class="space-y-2 overflow-y-auto flex-1 pr-1"></div>

            <button onclick="app.discardNewCard()" class="mt-4 w-full py-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-gray-300 text-xs font-bold transition">Annuleren (Nieuwe kaart weggooien)</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCP1yVG3ssEyOub_F6P__90G1bM13kDaz0",
            authDomain: "jetlagleuven.firebaseapp.com",
            databaseURL: "https://jetlagleuven-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "jetlagleuven",
            storageBucket: "jetlagleuven.firebasestorage.app",
            messagingSenderId: "461047598360",
            appId: "1:461047598360:web:34dfbfa265e3004ceb626d"
        };

        const appInit = initializeApp(firebaseConfig);
        const db = getDatabase(appInit);
        const auth = getAuth(appInit);

        // --- GAME DATA ---
        const DATA = {
            questions: [
                // LEVEL 1
                {id:1, niveau:1, categorie:"Locatie", vraag:"Bevinden jullie je ten noorden of ten zuiden van de Bondgenotenlaan?"},
                {id:2, niveau:1, categorie:"Locatie", vraag:"Bevinden jullie je binnen de ring of op de ring zelf?"},
                {id:3, niveau:1, categorie:"Locatie", vraag:"Is de straatnaam waar jullie zijn langer dan 8 letters?"},
                {id:4, niveau:1, categorie:"Locatie", vraag:"Is de weg waar jullie zijn toegankelijk voor auto's?"},
                {id:5, niveau:1, categorie:"Locatie", vraag:"Zijn jullie ten oosten of ten westen van de Naamsestraat?"},
                {id:6, niveau:1, categorie:"Locatie", vraag:"Is het dichtstbijzijnde gebouw een winkel of een woonhuis?"},
                {id:7, niveau:1, categorie:"Omgeving", vraag:"Is de ondergrond waar jullie staan bestraat of onverhard?"},
                {id:8, niveau:1, categorie:"Omgeving", vraag:"Horen jullie op dit moment het geluid van stromend water?"},
                {id:9, niveau:1, categorie:"Omgeving", vraag:"Staan jullie onder een afdak of in de open lucht?"},
                {id:10, niveau:1, categorie:"Omgeving", vraag:"Is het huisnummer van het dichtstbijzijnde gebouw even of oneven?"},
                {id:11, niveau:1, categorie:"Omgeving", vraag:"Zijn er meer dan 5 andere mensen zichtbaar in een straal van 20 meter?"},
                {id:12, niveau:1, categorie:"Omgeving", vraag:"Is er een fietsenstalling zichtbaar?"},
                {id:13, niveau:1, categorie:"Omgeving", vraag:"Staan jullie op een helling of op vlakke grond?"},
                {id:14, niveau:1, categorie:"Omgeving", vraag:"Kunnen jullie een verkeerslicht zien vanaf jullie positie?"},
                {id:15, niveau:1, categorie:"Omgeving", vraag:"Is er een zitbankje binnen 10 meter?"},
                {id:16, niveau:1, categorie:"Omgeving", vraag:"Zien jullie een bewakingscamera?"},
                {id:17, niveau:1, categorie:"Omgeving", vraag:"Zie je op dit moment een hond?"},
                {id:18, niveau:1, categorie:"Omgeving", vraag:"Zie je een 'verboden te parkeren' bord?"},
                {id:19, niveau:1, categorie:"Omgeving", vraag:"Is er een zebrapad zichtbaar?"},
                {id:20, niveau:1, categorie:"Omgeving", vraag:"Zie je iemand fietsen?"},
                {id:21, niveau:1, categorie:"Omgeving", vraag:"Is er een rioolputje binnen 5 meter?"},
                {id:22, niveau:1, categorie:"Visueel", vraag:"Kunnen jullie een toren zien vanaf jullie plek?"},
                {id:23, niveau:1, categorie:"Visueel", vraag:"Is er graffiti of street art zichtbaar?"},
                {id:24, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde gevel gemaakt van baksteen?"},
                {id:25, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde prullenbak groen of grijs?"},
                {id:26, niveau:1, categorie:"Visueel", vraag:"Sta je op kasseien?"},
                {id:27, niveau:1, categorie:"Visueel", vraag:"Zie je een vlag wapperen?"},
                {id:28, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde auto rood, zwart of grijs?"},
                {id:29, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde deur van hout of glas?"},
                {id:30, niveau:1, categorie:"Visueel", vraag:"Zie je een reclamebord?"},
                {id:31, niveau:1, categorie:"Visueel", vraag:"Zie je klimop of onkruid groeien?"},
                {id:32, niveau:1, categorie:"Visueel", vraag:"Zien jullie een balkon?"},
                {id:33, niveau:1, categorie:"Zintuig", vraag:"Ruik je op dit moment etensgeuren?"},
                {id:34, niveau:1, categorie:"Zintuig", vraag:"Voel je op dit moment wind?"},
                {id:35, niveau:1, categorie:"Audio", vraag:"Hoor je muziek?"},
                {id:36, niveau:1, categorie:"Audio", vraag:"Hoor je sirenes?"},

                // LEVEL 2
                {id:37, niveau:2, categorie:"Locatie", vraag:"Zijn jullie dichter bij het station dan bij de Grote Markt?"},
                {id:38, niveau:2, categorie:"Locatie", vraag:"Zijn jullie in een park of groene zone?"},
                {id:39, niveau:2, categorie:"Locatie", vraag:"Zijn jullie dichter bij de Vaartkom dan bij het Arenbergpark?"},
                {id:40, niveau:2, categorie:"Locatie", vraag:"Zijn jullie binnen 200m van een supermarkt?"},
                {id:41, niveau:2, categorie:"Locatie", vraag:"Zijn jullie in de buurt van een universiteitsgebouw?"},
                {id:42, niveau:2, categorie:"Locatie", vraag:"Is je verstopplek binnen 250m van de Hoorn?"},
                {id:43, niveau:2, categorie:"Locatie", vraag:"Zijn jullie dichter bij de Kruidtuin dan bij de Oude Markt?"},
                {id:44, niveau:2, categorie:"Locatie", vraag:"Zijn jullie in de buurt van het Ladeuzeplein?"},
                {id:45, niveau:2, categorie:"Locatie", vraag:"Bevinden jullie je in een autovrije straat?"},
                {id:46, niveau:2, categorie:"Foto", vraag:"Stuur een foto van de ondergrond (alleen jullie voeten en de grond)."},
                {id:47, niveau:2, categorie:"Foto", vraag:"Stuur een foto van de lucht recht boven jullie."},
                {id:48, niveau:2, categorie:"Foto", vraag:"Stuur een foto van het dichtstbijzijnde verkeersbord."},
                {id:49, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een object dat rood is in jullie omgeving."},
                {id:50, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een textuur dichtbij (muur, schors, paal)."},
                {id:51, niveau:2, categorie:"Foto", vraag:"Stuur een foto van jullie eigen schaduw op de grond."},
                {id:52, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een reflectie (in raam of plas)."},
                {id:53, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een rond object in je omgeving."},
                {id:54, niveau:2, categorie:"Foto", vraag:"Stuur een foto van iets dat van metaal is gemaakt."},
                {id:55, niveau:2, categorie:"Foto", vraag:"Stuur een foto van iets dat geel is."},
                {id:56, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een slot of ketting."},
                {id:57, niveau:2, categorie:"Puzzel", vraag:"Wat is de eerste letter van de straat waar jullie zijn?"},
                {id:58, niveau:2, categorie:"Puzzel", vraag:"Hoeveel stappen zijn jullie verwijderd van de dichtstbijzijnde vuilnisbak?"},
                {id:59, niveau:2, categorie:"Puzzel", vraag:"Welke letter komt het vaakst voor op de borden om je heen?"},
                {id:60, niveau:2, categorie:"Puzzel", vraag:"Tel het aantal ramen op de onderste verdieping van het gebouw tegenover je."},
                {id:61, niveau:2, categorie:"Puzzel", vraag:"Zie je een nummerbord met het cijfer 7 erin?"},
                {id:62, niveau:2, categorie:"Omgeving", vraag:"Is er een horecazaak zichtbaar met een terras?"},
                {id:63, niveau:2, categorie:"Omgeving", vraag:"Zie je een fiets die fout geparkeerd staat?"},
                {id:64, niveau:2, categorie:"Omgeving", vraag:"Zie je een kinderwagen in je buurt?"},
                {id:65, niveau:2, categorie:"Omgeving", vraag:"Is het gebouw achter je hoger dan 3 verdiepingen?"},
                {id:66, niveau:2, categorie:"Omgeving", vraag:"Is er glasafval of zwerfvuil zichtbaar?"},
                {id:67, niveau:2, categorie:"Visueel", vraag:"Wat is de kleur van de voordeur die het dichtst bij is?"},
                {id:68, niveau:2, categorie:"Visueel", vraag:"Is de straatverlichting hangend aan een draad of op een paal?"},
                {id:69, niveau:2, categorie:"Visueel", vraag:"Is de dichtstbijzijnde gevel wit geverfd?"},
                {id:70, niveau:2, categorie:"Visueel", vraag:"Zie je een regenpijp? Welke kleur?"},
                {id:71, niveau:2, categorie:"Observatie", vraag:"Zie je iemand die een bril draagt?"},
                {id:72, niveau:2, categorie:"Audio", vraag:"Hoor je een klok luiden?"},

                // LEVEL 3
                {id:73, niveau:3, categorie:"Risico", vraag:"Stuur een foto van het uitzicht op ooghoogte (zonder landmarks)."},
                {id:74, niveau:3, categorie:"Risico", vraag:"Stuur een geluidsopname van 15 seconden van de omgeving."},
                {id:75, niveau:3, categorie:"Risico", vraag:"Geef de naam van de dichtstbijzijnde winkel of café."},
                {id:76, niveau:3, categorie:"Risico", vraag:"Loop naar de dichtstbijzijnde hoek en stuur een foto van wat je ziet."},
                {id:77, niveau:3, categorie:"Risico", vraag:"Zijn jullie binnen een straal van 300m van het stadhuis?"},
                {id:78, niveau:3, categorie:"Risico", vraag:"Stuur een 360 graden panoramafoto."},
                {id:79, niveau:3, categorie:"Risico", vraag:"Wat is de laatste letter van de straatnaam waar jullie zijn?"},
                {id:80, niveau:3, categorie:"Risico", vraag:"Film 5 seconden lang de grond terwijl je ronddraait."},
                {id:81, niveau:3, categorie:"Risico", vraag:"Geef een beschrijving van de dichtstbijzijnde persoon (niet-speler)."},
                {id:82, niveau:3, categorie:"Risico", vraag:"Teken een ruwe schets van de plattegrond van jullie omgeving."},
                {id:83, niveau:3, categorie:"Risico", vraag:"Stuur een foto van het hoogste punt dat jullie kunnen zien."},
                {id:84, niveau:3, categorie:"Risico", vraag:"Hoeveel ramen heeft het gebouw recht tegenover jullie?"},
                {id:85, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een object dat begint met de letter 'S'."},
                {id:86, niveau:3, categorie:"Risico", vraag:"Zijn jullie binnen de oude stadsomwalling?"},
                {id:87, niveau:3, categorie:"Risico", vraag:"Beschrijf de schoenen van een voorbijganger."},
                {id:88, niveau:3, categorie:"Risico", vraag:"Wat is het laatste cijfer van het dichtstbijzijnde huisnummer?"},
                {id:89, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een patroon (kasseien of hekwerk)."},
                {id:90, niveau:3, categorie:"Risico", vraag:"Hoeveel stappen ben je van de dichtstbijzijnde straathoek?"},
                {id:91, niveau:3, categorie:"Risico", vraag:"Zie je een 'verboden' bord? Welke kleur heeft het?"},
                {id:92, niveau:3, categorie:"Risico", vraag:"Stuur een close-up van iets dat van hout is."},
                {id:93, niveau:3, categorie:"Risico", vraag:"Is er constructie of wegenwerken zichtbaar?"},
                {id:94, niveau:3, categorie:"Risico", vraag:"Zie je een uniform (politie, post, buschauffeur)?"},
                {id:95, niveau:3, categorie:"Risico", vraag:"Stuur een foto van iets historisch in je directe buurt."},
                {id:96, niveau:3, categorie:"Risico", vraag:"Stuur een foto van iets moderns in je directe buurt."},
                {id:97, niveau:3, categorie:"Risico", vraag:"Beschrijf de geur van de omgeving in 1 woord."},
                {id:98, niveau:3, categorie:"Risico", vraag:"Zie je een standbeeld?"},
                {id:99, niveau:3, categorie:"Risico", vraag:"Tel het aantal geparkeerde fietsen in zicht."},
                {id:100, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een sticker in de buurt."},
                {id:101, niveau:3, categorie:"Risico", vraag:"Kun je de hemel zien of zit je ergens onder?"},
                {id:102, niveau:3, categorie:"Risico", vraag:"Is het hier stiller of luider dan op de Oude Markt?"},
                {id:103, niveau:3, categorie:"Risico", vraag:"Welke kleur hebben de kozijnen van het huis tegenover je?"},
                {id:104, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een plant of bloem."},
                {id:105, niveau:3, categorie:"Risico", vraag:"Zie je een brievenbus van Bpost?"}
            ],
            deck: [
                {id:1, type:"Tijd", naam:"Bonus 5 min", effect:"Eindtijd wordt met 5 minuten verlengd.", taak:"Geen taak."},
                {id:2, type:"Tijd", naam:"Bonus 5 min", effect:"Eindtijd wordt met 5 minuten verlengd.", taak:"Geen taak."},
                {id:3, type:"Tijd", naam:"Bonus 5 min", effect:"Eindtijd wordt met 5 minuten verlengd.", taak:"Geen taak."},
                {id:4, type:"Tijd", naam:"Bonus 5 min", effect:"Eindtijd wordt met 5 minuten verlengd.", taak:"Geen taak."},
                {id:5, type:"Tijd", naam:"Bonus 5 min", effect:"Eindtijd wordt met 5 minuten verlengd.", taak:"Geen taak."},
                {id:6, type:"Tijd", naam:"Bonus 5 min", effect:"Eindtijd wordt met 5 minuten verlengd.", taak:"Geen taak."},
                {id:7, type:"Tijd", naam:"Bonus 10 min", effect:"Eindtijd wordt met 10 minuten verlengd.", taak:"Geen taak."},
                {id:8, type:"Tijd", naam:"Bonus 10 min", effect:"Eindtijd wordt met 10 minuten verlengd.", taak:"Geen taak."},
                {id:9, type:"Tijd", naam:"Bonus 10 min", effect:"Eindtijd wordt met 10 minuten verlengd.", taak:"Geen taak."},
                {id:10, type:"Tijd", naam:"Bonus 10 min", effect:"Eindtijd wordt met 10 minuten verlengd.", taak:"Geen taak."},
                {id:11, type:"Tijd", naam:"Bonus 15 min", effect:"Eindtijd wordt met 15 minuten verlengd.", taak:"Geen taak."},
                {id:12, type:"Tijd", naam:"Bonus 15 min", effect:"Eindtijd wordt met 15 minuten verlengd.", taak:"Geen taak."},
                {id:13, type:"Tijd", naam:"Bonus 15 min", effect:"Eindtijd wordt met 15 minuten verlengd.", taak:"Geen taak."},
                {id:14, type:"Tijd", naam:"Bonus 30 min", effect:"Eindtijd wordt met 30 minuten verlengd.", taak:"Geen taak."},
                {id:15, type:"Tijd", naam:"Bonus 1 uur", effect:"Eindtijd wordt met 60 minuten verlengd.", taak:"Geen taak."},
                {id:16, type:"Vloek", naam:"Freeze (2 min)", effect:"Zoekers moeten direct 2 minuten stilstaan.", taak:"Maak een selfie met een standbeeld (of paal)."},
                {id:17, type:"Vloek", naam:"Freeze (2 min)", effect:"Zoekers moeten direct 2 minuten stilstaan.", taak:"Maak een selfie met een standbeeld (of paal)."},
                {id:18, type:"Vloek", naam:"De snack pauze", effect:"Zoekers moeten stoppen en een snack kopen en opeten.", taak:"Overtuig een vreemde om naar de camera te zwaaien."},
                {id:19, type:"Vloek", naam:"Achteruit", effect:"Zoekers moeten de volledige volgende straat achteruit lopen.", taak:"Film 30 seconden waarin je de moonwalk doet."},
                {id:20, type:"Vloek", naam:"Hand in hand", effect:"Zoekers moeten 5 minuten hand in hand lopen.", taak:"Knoop jullie veters aan elkaar vast voor 1 minuut."},
                {id:21, type:"Vloek", naam:"Op één been", effect:"Zoekers moeten 1 minuut op één been wachten.", taak:"Sta zelf 1 minuut op één been als een flamingo."},
                {id:22, type:"Vloek", naam:"Selfie time", effect:"Zoekers moeten een selfie maken met een vreemde.", taak:"Maak zelf ook een selfie met een vreemde voorbijganger."},
                {id:23, type:"Vloek", naam:"De vloer is lava", effect:"Zoekers mogen 3 minuten de straatstenen niet raken.", taak:"Klim ergens op (muurtje of bankje) en maak een foto."},
                {id:24, type:"Vloek", naam:"Slow motion", effect:"Zoekers moeten 2 minuten in overdreven slow-mo bewegen.", taak:"Film een slow-motion actiegevecht met elkaar."},
                {id:25, type:"Vloek", naam:"Tas wissel", effect:"Zoekers wisselen 10 minuten van rugzak of jas.", taak:"Doe je eigen schoenen aan de verkeerde voeten (L aan R)."},
                {id:26, type:"Vloek", naam:"Sprintje", effect:"Zoekers moeten een sprintje trekken van 50 meter.", taak:"Doe 20 jumping jacks op je verstopplek."},
                {id:27, type:"Vloek", naam:"Omweg standbeeld", effect:"Zoekers moeten eerst het dichtstbijzijnde standbeeld aantikken.", taak:"Zing luidkeels het eerste couplet van de Brabanconne."},
                {id:28, type:"Vloek", naam:"Vraag weigeren", effect:"De huidige vraag van de zoekers vervalt.", taak:"Bouw een toren van 5 objecten (stenen, takjes)."},
                {id:29, type:"Vloek", naam:"Vraag weigeren", effect:"De huidige vraag van de zoekers vervalt.", taak:"Bouw een toren van 5 objecten (stenen, takjes)."},
                {id:30, type:"Vloek", naam:"Splitsing", effect:"Zoekers moeten 10 minuten minstens 200m uit elkaar gaan.", taak:"Doe je jas of trui binnenstebuiten aan."},
                {id:31, type:"Vloek", naam:"Links afslaan", effect:"Zoekers mogen 5 minuten enkel links afslaan.", taak:"Draai 10 rondjes om je eigen as."},
                {id:32, type:"Vloek", naam:"Geen maps", effect:"Zoekers mogen 5 minuten geen Google Maps gebruiken.", taak:"Teken een portret van elkaar in 30 seconden."},
                {id:33, type:"Vloek", naam:"De polonaise", effect:"Zoekers moeten 2 minuten in polonaise lopen.", taak:"Doe de kabouterdans met alle bewegingen erbij."},
                {id:34, type:"Vloek", naam:"Vogelspotter", effect:"Zoekers moeten een duif of eend fotograferen.", taak:"Doe een vogel na (geluid en beweging) op video."},
                {id:35, type:"Vloek", naam:"Bus roulette", effect:"Zoekers moeten wachten bij een halte tot er een bus stopt.", taak:"Film jezelf terwijl je doet alsof je een bus bestuurt."},
                {id:36, type:"Vloek", naam:"De noodklok", effect:"Zoekers moeten de dichtstbijzijnde kerkdeur aanraken.", taak:"Draag een gedicht voor over hoe traag de zoekers zijn."},
                {id:37, type:"Vloek", naam:"Blinddoek", effect:"Eén zoeker moet 5 minuten geblinddoekt geleid worden.", taak:"Sta 1 minuut roerloos stil als een standbeeld."},
                {id:38, type:"Vloek", naam:"De toerist", effect:"Zoekers moeten de weg vragen aan een vreemde naar het station.", taak:"Wens een willekeurige voorbijganger een geweldige dag."},
                {id:39, type:"Vloek", naam:"Waterdrager", effect:"Zoekers moeten een flesje water in één keer leegdrinken.", taak:"Doe 10 push-ups op een openbare plek."},
                {id:40, type:"Vloek", naam:"Papegaai", effect:"Zoekers herhalen 5 minuten alles wat één iemand zegt.", taak:"Praat 1 minuut lang tegen een lantaarnpaal."},
                {id:41, type:"Vloek", naam:"Hinkelen", effect:"Zoekers moeten de volgende 50 meter hinkelen.", taak:"Hinkel zelf een rondje om je verstopplek."},
                {id:42, type:"Vloek", naam:"Stilte (5 min)", effect:"Zoekers mogen 5 minuten niet praten of typen.", taak:"Wees zelf 5 minuten doodstil (stuur video als bewijs)."},
                {id:43, type:"Vloek", naam:"De mol", effect:"Zoekers moeten 5 minuten hun live locatie delen.", taak:"Zoek een afbeelding van een mol en stuur deze door."},
                {id:44, type:"Vloek", naam:"Alleen fietsen", effect:"Zoekers moeten 15 minuten alles fietsend doen.", taak:"Sta 3 minuten rug-aan-rug met ogen dicht."},
                {id:45, type:"Vloek", naam:"Alleen lopen", effect:"Zoekers moeten 15 minuten lopen (fiets aan de hand).", taak:"Zing 1 minuut luidkeels een lied naar keuze."},
                {id:46, type:"Vloek", naam:"Brug tol", effect:"Zoekers moeten binnen 5 minuten een brug oversteken.", taak:"Maak een 'brug' met je lichaam (plank) voor 30 seconden."},
                {id:47, type:"Vloek", naam:"Omweg markt", effect:"Zoekers moeten eerst de Oude Markt aantikken.", taak:"Vind een object dat begint met de letter O."},
                {id:48, type:"Vloek", naam:"Oriëntatie", effect:"Zoekers mogen 10 min geen draaiende kaart gebruiken.", taak:"Draai 1 minuut lang heel langzaam rondjes."},
                {id:49, type:"Vloek", naam:"Pad blokkeren", effect:"Zoekers mogen één specifieke straat 20 min niet in.", taak:"Bouw een kleine barricade van takjes of steentjes."},
                {id:50, type:"Vloek", naam:"Stille zone", effect:"Zoekers mogen 15 min niet praten/typen.", taak:"Wees zelf 5 minuten volledig stil."},
                {id:51, type:"Vloek", naam:"Tijdelijke afleiding", effect:"Hiders bellen zoekers 1 minuut (zoekers staan stil).", taak:"Verkoop een product aan de zoekers zonder 'uhm' te zeggen."},
                {id:52, type:"Vloek", naam:"Rode licht", effect:"Wachten bij elk rood licht (ook als het groen is).", taak:"Doe 20 jumping jacks."},
                {id:53, type:"Vloek", naam:"Veter foltering", effect:"Eén zoeker moet veters losmaken en opnieuw strikken.", taak:"Doe je eigen schoenen verkeerd om aan."},
                {id:54, type:"Vloek", naam:"Kunst jacht", effect:"Zoekers moeten een straatkunstwerk fotograferen.", taak:"Bedenk een raadsel over je huidige locatie."},
                {id:55, type:"Vloek", naam:"Verkeerde afslag", effect:"Zoekers moeten 200m teruglopen.", taak:"Loop 3 minuten lang achteruit in een klein cirkeltje."},
                {id:56, type:"Vloek", naam:"Lied van Leuven", effect:"Zoekers zingen een lied over Leuven op straat.", taak:"Doe een dier naar keuze na voor 1 minuut."},
                {id:57, type:"Vloek", naam:"Zoeker afleiden", effect:"Zoekers moeten de Macarena dansen op straat.", taak:"Dans zelf de Macarena (zonder muziek) voor 1 minuut."},
                {id:58, type:"Vloek", naam:"Zoeker ruil", effect:"Zoekers wisselen 10 min van jas of tas.", taak:"Trek je sokken over je broekspijpen aan."},
                {id:59, type:"Vloek", naam:"Ruisonderdrukking", effect:"Hiders wachten 10 min extra met antwoorden.", taak:"Zit 2 min met vingers in je oren en ogen dicht."},
                {id:60, type:"Vloek", naam:"Vertraging", effect:"Zoekers moeten 2 minuten stilstaan (freeze).", taak:"Doe de eerste maanlanding na in slow-motion."},
                {id:61, type:"Vloek", naam:"Verwarring", effect:"Zoekers moeten 5 min naar het Noorden lopen.", taak:"Wijs 1 minuut lang naar willekeurige richtingen."},
                {id:62, type:"Bonus", naam:"Locatie wissel", effect:"Hiders mogen hun plek 5 min verlaten (rennend).", taak:"Roep luidkeels 'WIJ ZIJN BANG' in een drukke straat."},
                {id:63, type:"Bonus", naam:"De mime", effect:"Zoekers mogen 10 min niet praten, enkel gebaren.", taak:"Beeld een bekende film uit zonder geluid te maken."},
                {id:64, type:"Bonus", naam:"De leugen", effect:"Hiders mogen liegen op de VOLGENDE vraag.", taak:"Eet iets op dat je normaal niet puur eet (citroen/zout)."},
                {id:65, type:"Bonus", naam:"Mist", effect:"Zoekers mogen 15 min geen vragen stellen.", taak:"Houd 1 minuut lang elkaars hand vast."},
                {id:66, type:"Bonus", naam:"Camouflage", effect:"Stuur een foto van iemand anders bij een beschrijving.", taak:"Verberg je gezicht volledig voor 10 minuten."},
                {id:67, type:"Bonus", naam:"Radar jammer", effect:"Zoekers zetten 10 min hun live locatie uit.", taak:"Roep 10 keer luidkeels 'KEKO KEKO!'."},
                {id:68, type:"Bonus", naam:"Safehouse", effect:"Zoekers wachten 2 min voor tikken als ze dichtbij zijn.", taak:"Maak een klein kunstwerk van afval dat je vindt."},
                {id:69, type:"Bonus", naam:"Copycat", effect:"Kopieer het effect van de vorige kaart nog eens.", taak:"Doe de vorige opdracht nog eens, maar 2x sneller."},
                {id:70, type:"Bonus", naam:"Herpositioneren", effect:"Hiders mogen 2 min verplaatsen naar een nieuwe plek.", taak:"Roep luidkeels 'WIJ VERPLAATSEN ONS!'."},
                {id:71, type:"Bonus", naam:"Noodontsnapping", effect:"Verplaats 50m (enkel als zoekers binnen 100m zijn).", taak:"Ren drie rondjes om je huidige verstopplek."},
                {id:72, type:"Bonus", naam:"Onzichtbaar", effect:"2 minuten volledige radiostilte (geen GPS/chat).", taak:"Lig 1 minuut lang plat op de grond."},
                {id:73, type:"Bonus", naam:"Souvenir", effect:"Zoekers moeten een klein souvenir kopen voor hiders.", taak:"Maak een enthousiaste bedankvideo voor het souvenir."},
                {id:74, type:"Bonus", naam:"Snelle ontsnapping", effect:"Hiders mogen 200m verplaatsen.", taak:"Maak een foto van je voeten die de grond niet raken."},
                {id:75, type:"Bonus", naam:"Stealth modus", effect:"De komende 10 min mogen er geen vragen komen.", taak:"Fluister 1 minuut lang alles wat je zegt."},
                {id:76, type:"Bonus", naam:"Tijd rekken", effect:"Zoekers wachten 5 min extra op je antwoord.", taak:"Tel hardop tot 60 in een vreemde taal naar keuze."},
                {id:77, type:"Bonus", naam:"Upgrade", effect:"Huidige plek telt voor +10 min extra tijd.", taak:"Maak een reclamepraatje over je verstopplek."},
                {id:78, type:"Bonus", naam:"Vraag blok", effect:"Weiger de huidige vraag van de zoekers.", taak:"Bouw een kaartenhuis van minstens twee verdiepingen."},
                {id:79, type:"Bonus", naam:"Trekken", effect:"Gooi al je kaarten weg en trek 3 nieuwe.", taak:"Schud 30 seconden lang denkbeeldige kaarten."}
            ]
        };

        // --- GLOBAL STATE ---
        let state = {
            user: null,
            lobby: null,
            role: null,
            questions: [],
            deck: [],
            status: 'idle', // idle, answering
            activeQ: null,
            timerStart: 0,
            penalty: 0,
            activeCurses: [],
            logs: [],
            tempDrawnCard: null // Voor overflow handling
        };

        let timerInt = null;

        // --- LOGIC: JOIN ---
        window.app = {
            async join() {
                const name = document.getElementById('inp-name').value;
                const lobby = document.getElementById('inp-lobby').value.toUpperCase();
                if (!name || !lobby) return alert("Vul naam en lobby code in.");

                document.getElementById('btn-join').innerText = "LADEN...";
                
                try {
                    // Try anonymous auth
                    await signInAnonymously(auth);
                    state.user = { uid: auth.currentUser.uid, name };
                    state.lobby = lobby;

                    // Init Lobby if needed
                    const lobbyRef = ref(db, `lobbies/${lobby}`);
                    const snap = await get(lobbyRef);
                    if (!snap.exists()) {
                        await set(lobbyRef, {
                            created: Date.now(),
                            questions: DATA.questions,
                            deck: DATA.deck,
                            status: 'idle',
                            penalty: 0,
                            logs: [{msg: `Lobby ${lobby} gestart door ${name}`, time: Date.now()}]
                        });
                    } else {
                        // Log Join
                        const logs = snap.val().logs || [];
                        logs.push({msg: `${name} joined`, time: Date.now()});
                        update(lobbyRef, { logs });
                    }

                    // UI Switch
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-role').classList.remove('hidden');
                    
                    app.listen();

                } catch (e) {
                    console.error(e);
                    alert("Verbindingsfout:\n" + e.message + "\n\nControleer of 'Anonymous Authentication' aan staat in Firebase Console!");
                    document.getElementById('btn-join').innerText = "START SPEL";
                }
            },

            setRole(role) {
                state.role = role;
                document.getElementById('view-role').classList.add('hidden');
                document.getElementById('view-game').classList.remove('hidden');
                
                // Update Header
                document.getElementById('lbl-lobby').innerText = state.lobby;
                document.getElementById('lbl-user').innerText = state.user.name;
                
                const badge = document.getElementById('role-badge');
                badge.innerText = role;
                badge.className = `px-3 py-1 rounded-full font-black text-[10px] tracking-wider uppercase border border-white/10 ${role === 'hider' ? 'bg-yellow-500 text-black' : 'bg-blue-500 text-white'}`;
                
                // Init Views
                if(role === 'hider') {
                    document.getElementById('hider-hand-wrapper').classList.remove('hidden');
                } else {
                    document.getElementById('seeker-panel').classList.remove('hidden');
                    app.renderQuestions(1); // Default Level 1
                }
                
                app.renderUI();
            },

            listen() {
                onValue(ref(db, `lobbies/${state.lobby}`), (snap) => {
                    const data = snap.val();
                    if (!data) return;

                    state.questions = data.questions || [];
                    state.deck = data.deck || [];
                    state.status = data.status || 'idle';
                    state.activeQ = data.activeQ || null;
                    state.timerStart = data.timerStart || 0;
                    state.penalty = data.penalty || 0;
                    state.activeCurses = data.activeCurses || [];
                    state.logs = data.logs || [];

                    app.renderUI();
                });
            },

            renderUI() {
                // 1. Logs
                const logList = document.getElementById('log-list');
                logList.innerHTML = state.logs.map(l => {
                    const time = new Date(l.time).toTimeString().substr(0,5);
                    return `<div class="border-b border-gray-700 pb-1 mb-1"><span class="text-gray-500 mr-2">[${time}]</span>${l.msg}</div>`;
                }).join('');

                // 2. Penalty
                document.getElementById('lbl-penalty').innerText = state.penalty;

                // 3. Status & Timer
                const isAnswering = state.status === 'answering';
                const hasCurses = state.activeCurses.length > 0;
                
                const timerBar = document.getElementById('timer-bar');
                const timerLbl = document.getElementById('lbl-timer');
                
                if (timerInt) clearInterval(timerInt);
                
                if (isAnswering) {
                    timerBar.classList.remove('hidden');
                    timerInt = setInterval(() => {
                        const elapsed = Date.now() - state.timerStart;
                        const remain = 180000 - elapsed; // 3 min
                        
                        if(state.role === 'seeker') {
                            const m = Math.max(0, Math.floor(remain / 60000));
                            const s = Math.max(0, Math.floor((remain % 60000) / 1000));
                            document.getElementById('seeker-timer-display').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                        }

                        if (remain <= 0) {
                            timerLbl.innerText = "TE LAAT! (+10m)";
                            timerBar.classList.add('bg-red-600');
                        } else {
                            const m = Math.floor(remain / 60000);
                            const s = Math.floor((remain % 60000) / 1000);
                            timerLbl.innerText = `${m}:${s.toString().padStart(2,'0')}`;
                            timerBar.classList.remove('bg-red-600');
                        }
                    }, 1000);
                } else {
                    timerBar.classList.add('hidden');
                }

                // 4. Seeker Logic
                if (state.role === 'seeker') {
                    const waitOverlay = document.getElementById('overlay-seeker-wait');
                    const curseOverlay = document.getElementById('overlay-curse');
                    
                    if (hasCurses) {
                        // Show Curse Overlay
                        curseOverlay.classList.remove('hidden');
                        waitOverlay.classList.add('hidden');
                        document.getElementById('active-curses-container').innerHTML = state.activeCurses.map((c, idx) => `
                            <div class="bg-gray-800 p-4 rounded-xl border border-red-500 text-left shadow-lg relative overflow-hidden">
                                <div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-bold px-2 py-1">ACTIVE VLOEK</div>
                                <h4 class="font-bold text-yellow-400 text-lg mt-2">${c.naam}</h4>
                                <p class="text-gray-300 text-sm mb-2">${c.effect}</p>
                                <div class="bg-black/30 p-2 rounded italic text-gray-400 mb-3 text-xs border-l-2 border-yellow-500">
                                    <span class="font-bold text-yellow-500">Taak:</span> ${c.taak}
                                </div>
                                <button onclick="app.clearCurse(${idx})" class="w-full bg-green-600 hover:bg-green-500 py-3 rounded font-bold text-white text-sm transition">
                                    <i class="fa-solid fa-check mr-1"></i> TAAK VOLTOOID
                                </button>
                            </div>
                        `).join('');
                    } else if (isAnswering) {
                        waitOverlay.classList.remove('hidden');
                        curseOverlay.classList.add('hidden');
                    } else {
                        waitOverlay.classList.add('hidden');
                        curseOverlay.classList.add('hidden');
                        // Refresh question list to show availability if needed
                        // Note: We don't re-render full list every update to prevent scroll jumping, 
                        // but logic is data-driven.
                    }
                }

                // 5. Hider Logic
                if (state.role === 'hider') {
                    // Hand Render
                    const hand = state.deck.filter(c => c.status === 'hand');
                    document.getElementById('lbl-hand-count').innerText = hand.length;
                    const handList = document.getElementById('hand-list');
                    
                    if(hand.length === 0) handList.innerHTML = `<div class="text-center text-gray-600 italic py-4 text-xs">Je hand is leeg. Beantwoord vragen om kaarten te krijgen.</div>`;
                    else {
                        handList.innerHTML = hand.map(c => `
                            <div class="card-base p-3 flex justify-between items-center ${c.type === 'Vloek' ? 'border-red-500/50 bg-red-900/10' : (c.type === 'Bonus' ? 'border-yellow-500/50 bg-yellow-900/10' : 'border-green-500/50')}">
                                <div class="w-2/3 pr-2">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[9px] font-black uppercase px-1.5 py-0.5 rounded ${c.type==='Vloek'?'bg-red-500 text-black':(c.type==='Tijd'?'bg-green-500 text-black':'bg-yellow-500 text-black')}">${c.type}</span>
                                        <span class="font-bold text-white text-xs truncate">${c.naam}</span>
                                    </div>
                                    <div class="text-[10px] text-gray-300 leading-tight mb-1">${c.effect}</div>
                                    ${c.taak !== 'Geen taak.' ? `<div class="text-[9px] text-yellow-500 italic border-l-2 border-yellow-500 pl-1">${c.taak}</div>` : ''}
                                </div>
                                <div class="flex flex-col gap-1 w-16 shrink-0">
                                    <button onclick="app.playCard(${c.id})" class="bg-green-600 hover:bg-green-500 text-white text-[10px] font-bold py-1.5 rounded transition shadow-lg">SPEEL</button>
                                    <button onclick="app.discardCard(${c.id})" class="bg-gray-700 hover:bg-gray-600 text-gray-400 text-[10px] py-1.5 rounded transition">WEG</button>
                                </div>
                            </div>
                        `).join('');
                    }

                    // Answering Panel
                    const panel = document.getElementById('hider-panel');
                    if (isAnswering) {
                        const q = state.questions.find(x => x.id === state.activeQ);
                        if (q) {
                            panel.classList.remove('hidden');
                            document.getElementById('hp-question').innerText = q.vraag;
                            document.getElementById('hp-level').innerText = q.niveau;
                            document.getElementById('hp-reward').innerText = q.niveau; // 1 lvl = 1 card
                        }
                    } else {
                        panel.classList.add('hidden');
                    }
                }
            },

            // --- ACTIONS ---

            renderQuestions(lvl) {
                // Update tabs
                [1,2,3].forEach(i => {
                    const btn = document.getElementById(`btn-lvl-${i}`);
                    if(i===lvl) {
                        btn.classList.remove('bg-gray-800', 'text-gray-400');
                        btn.classList.add('bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400');
                    } else {
                        btn.classList.add('bg-gray-800', 'text-gray-400');
                        btn.classList.remove('bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400');
                    }
                });

                const list = document.getElementById('question-list-container');
                list.innerHTML = "";

                // Filter logic
                const filtered = state.questions.filter(q => q.niveau === lvl && !q.used);
                
                if (filtered.length === 0) {
                    list.innerHTML = `<div class="text-center text-gray-500 italic mt-8 bg-gray-800/50 p-4 rounded-xl">Alle vragen van dit niveau zijn gesteld!</div>`;
                    return;
                }

                // Group by Category
                const groups = {};
                filtered.forEach(q => {
                    if(!groups[q.categorie]) groups[q.categorie] = [];
                    groups[q.categorie].push(q);
                });

                // Render Groups
                for (const [cat, qs] of Object.entries(groups)) {
                    let icon = 'fa-tag';
                    if(cat === 'Locatie') icon = 'fa-map-pin';
                    if(cat === 'Omgeving') icon = 'fa-tree';
                    if(cat === 'Visueel') icon = 'fa-eye';
                    if(cat === 'Risico') icon = 'fa-skull';
                    if(cat === 'Foto') icon = 'fa-camera';
                    if(cat === 'Puzzel') icon = 'fa-puzzle-piece';

                    const html = `
                        <div class="cat-header"><i class="fa-solid ${icon}"></i> ${cat}</div>
                        ${qs.map(q => `
                            <button onclick="app.askQuestion(${q.id})" class="w-full text-left bg-gray-800 p-4 rounded-lg border border-gray-700 hover:bg-gray-750 hover:border-blue-500 active:scale-[0.99] transition mb-2 shadow-sm group">
                                <div class="text-sm font-bold text-gray-200 group-hover:text-white">${q.vraag}</div>
                                <div class="text-[10px] text-gray-500 mt-1 uppercase tracking-wider group-hover:text-blue-400">Klik om te vragen</div>
                            </button>
                        `).join('')}
                    `;
                    list.innerHTML += html;
                }
            },

            askQuestion(id) {
                if(!confirm("Weet je zeker dat je deze vraag wil stellen?")) return;
                
                const qIdx = state.questions.findIndex(q => q.id === id);
                
                // Update DB
                const updates = {};
                updates[`questions/${qIdx}/used`] = true;
                updates[`status`] = 'answering';
                updates[`activeQ`] = id;
                updates[`timerStart`] = serverTimestamp(); // Use server time for sync
                
                // Add Log
                const newLog = [...state.logs, {msg: `ZOEKERS: "${state.questions[qIdx].vraag}"`, time: Date.now()}];
                updates[`logs`] = newLog;

                update(ref(db, `lobbies/${state.lobby}`), updates);
            },

            hiderConfirmAnswer() {
                if(!confirm("Heb je het antwoord verstuurd via WhatsApp?")) return;

                // Penalty Check locally (server time is better but this works for simple apps)
                const elapsed = Date.now() - state.timerStart;
                let penaltyAdded = 0;
                if (elapsed > 180000) penaltyAdded = 10; // > 3 min

                const q = state.questions.find(x => x.id === state.activeQ);
                // Risk / Level logic determines cards
                let drawCount = q.niveau; 
                
                const updates = { status: 'idle', activeQ: null, timerStart: 0 };
                if (penaltyAdded > 0) updates['penalty'] = state.penalty + 10;
                
                const newLog = [...state.logs, {msg: `HIDERS geantwoord! ${penaltyAdded ? '(TE LAAT: +10 min)' : ''}`, time: Date.now()}];
                updates['logs'] = newLog;

                update(ref(db, `lobbies/${state.lobby}`), updates)
                    .then(() => app.triggerDraw(drawCount));
            },

            triggerDraw(amount) {
                const deck = state.deck.filter(c => !c.status || c.status === 'deck');
                
                if (deck.length === 0) return alert("Kaarten zijn op!");
                
                // Random draw logic
                const drawn = [];
                const tempDeck = [...deck]; // Copy to avoid messing up state directly before save
                
                for (let i=0; i<amount; i++) {
                    if(tempDeck.length === 0) break;
                    const r = Math.floor(Math.random() * tempDeck.length);
                    drawn.push(tempDeck[r]);
                    tempDeck.splice(r, 1);
                }

                // Show Modal to PICK 1
                const list = document.getElementById('pick-list');
                list.innerHTML = drawn.map(c => `
                    <div onclick="app.keepCard(${c.id})" class="bg-gray-700 p-4 rounded-xl border border-yellow-500/30 hover:border-yellow-400 active:bg-gray-600 transition cursor-pointer">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-yellow-400 text-lg">${c.naam}</span>
                            <span class="text-[9px] uppercase px-1.5 py-0.5 rounded ${c.type==='Vloek'?'bg-red-500 text-black':'bg-green-500 text-black'}">${c.type}</span>
                        </div>
                        <div class="text-xs text-white mb-2">${c.effect}</div>
                        <div class="text-[10px] text-gray-400 italic border-l-2 border-gray-500 pl-2">${c.taak}</div>
                    </div>
                `).join('');
                
                document.getElementById('modal-pick').classList.remove('hidden');
            },

            keepCard(id) {
                document.getElementById('modal-pick').classList.add('hidden');
                
                // Add to hand
                const idx = state.deck.findIndex(c => c.id === id);
                
                // Check Hand Size Limit BEFORE confirming in DB
                const hand = state.deck.filter(c => c.status === 'hand');
                if (hand.length >= 6) {
                    // Overflow state
                    state.tempDrawnCard = state.deck[idx]; // Store locally temporarily
                    app.showDiscardModal(id);
                } else {
                    // Fits in hand
                    update(ref(db, `lobbies/${state.lobby}/deck/${idx}`), { status: 'hand' });
                }
            },

            showDiscardModal(newId) {
                const modal = document.getElementById('modal-discard');
                modal.classList.remove('hidden');
                
                // Show new card
                const newItem = state.deck.find(c => c.id === newId);
                document.getElementById('discard-new-list').innerHTML = `
                    <div class="bg-gray-800 p-3 rounded border border-green-500 text-center">
                        <div class="font-bold text-green-400 text-sm">${newItem.naam}</div>
                        <div class="text-[10px] text-gray-400">${newItem.effect}</div>
                    </div>
                `;

                // Show hand to discard
                const hand = state.deck.filter(c => c.status === 'hand');
                document.getElementById('discard-hand-list').innerHTML = hand.map(c => `
                    <div onclick="app.discardOldAndKeepNew(${c.id}, ${newId})" class="bg-gray-800 p-3 rounded flex justify-between items-center border border-gray-600 hover:border-red-500 cursor-pointer mb-2 group">
                        <div>
                            <div class="text-white font-bold text-xs group-hover:text-red-400 transition">${c.naam}</div>
                            <div class="text-[9px] text-gray-500">${c.type}</div>
                        </div>
                        <i class="fa-solid fa-trash text-gray-600 group-hover:text-red-500 transition"></i>
                    </div>
                `).join('');
            },

            discardNewCard() {
                // User chose not to keep the new card
                document.getElementById('modal-discard').classList.add('hidden');
                // No DB update needed, card remains 'deck' (or mark discarded if rules say so? Let's say it goes back to pile or discard. Let's discard it)
                const idx = state.deck.findIndex(c => c.id === state.tempDrawnCard.id);
                update(ref(db, `lobbies/${state.lobby}/deck/${idx}`), { status: 'discarded' });
                state.tempDrawnCard = null;
            },

            discardOldAndKeepNew(oldId, newId) {
                // 1. Set old to discarded
                const oldIdx = state.deck.findIndex(c => c.id === oldId);
                const updates = {};
                updates[`deck/${oldIdx}/status`] = 'discarded';
                
                // 2. Set new to hand
                const newIdx = state.deck.findIndex(c => c.id === newId);
                updates[`deck/${newIdx}/status`] = 'hand';
                
                update(ref(db, `lobbies/${state.lobby}`), updates);
                document.getElementById('modal-discard').classList.add('hidden');
                state.tempDrawnCard = null;
            },

            playCard(id) {
                const idx = state.deck.findIndex(c => c.id === id);
                const card = state.deck[idx];

                if(card.taak !== "Geen taak.") {
                    if(!confirm(`TAAK VEREIST:\n\n"${card.taak}"\n\nHeb je dit gedaan/gefilmd?`)) return;
                }
                
                const updates = {};
                updates[`deck/${idx}/status`] = 'played';
                
                // Handle Curse
                if (card.type === 'Vloek') {
                    const newCurses = [...state.activeCurses, card];
                    updates['activeCurses'] = newCurses;
                }
                
                // Logs
                const newLog = [...state.logs, {msg: `HIDERS spelen: ${card.naam}`, time: Date.now()}];
                updates['logs'] = newLog;

                update(ref(db, `lobbies/${state.lobby}`), updates);
            },

            discardCard(id) {
                if(!confirm("Weet je zeker dat je deze kaart weg wil gooien zonder effect?")) return;
                const idx = state.deck.findIndex(c => c.id === id);
                update(ref(db, `lobbies/${state.lobby}/deck/${idx}`), { status: 'discarded' });
            },

            clearCurse(arrIndex) {
                if(!confirm("Bevestig: Hebben de hiders de taak succesvol afgerond?")) return;
                
                // Remove specific index logic needs to be safe
                // Filter out item at index
                const newCurses = state.activeCurses.filter((_, i) => i !== arrIndex);
                
                const updates = { activeCurses: newCurses };
                const newLog = [...state.logs, {msg: `ZOEKERS: Vloek opgeheven!`, time: Date.now()}];
                updates['logs'] = newLog;

                update(ref(db, `lobbies/${state.lobby}`), updates);
            }
        };

        // Initialize listener just in case
        window.app = app;
    </script>
</body>
</html>
