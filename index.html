<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leuven Hide & Seek</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        .card-jetlag { background: #1f2937; border-left: 4px solid #fbbf24; transition: transform 0.1s; }
        .card-jetlag:active { transform: scale(0.98); }
        .btn-primary { background-color: #fbbf24; color: #1a1a1a; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; }
        
        /* Categorie headers */
        .cat-header { background-color: #374151; color: #fbbf24; font-weight: bold; padding: 8px 12px; border-radius: 6px; margin-top: 16px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 2px solid #fbbf24; }

        /* Animaties */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .curse-active { animation: pulse-red 2s infinite; border: 2px solid #ef4444; }
        .disabled-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; border-radius: inherit; z-index: 10; }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 selection:bg-yellow-500 selection:text-black">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="w-full max-w-md space-y-8 mt-10">
        <div class="text-center space-y-2">
            <i class="fa-solid fa-map-location-dot text-6xl text-yellow-400 mb-4"></i>
            <h1 class="text-5xl font-black text-white tracking-tighter">LEUVEN<br><span class="text-yellow-400">HIDE & SEEK</span></h1>
        </div>
        
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl space-y-6 border border-gray-700">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Speler Naam</label>
                <input type="text" id="username" class="w-full p-4 rounded-lg bg-gray-900 border border-gray-600 focus:border-yellow-400 outline-none text-white font-bold" placeholder="Bijv. Sam">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Lobby Code</label>
                <input type="text" id="lobbycode" class="w-full p-4 rounded-lg bg-gray-900 border border-gray-600 focus:border-yellow-400 outline-none text-white font-bold uppercase tracking-widest" placeholder="LEUVEN1">
            </div>
            <button id="join-btn" onclick="joinLobby()" class="w-full btn-primary p-4 rounded-lg shadow-lg">START SPEL</button>
        </div>
    </div>

    <!-- ROLE SELECTION -->
    <div id="role-screen" class="hidden w-full max-w-md space-y-6 mt-10 text-center">
        <h2 class="text-3xl font-black text-white">KIES JE TEAM</h2>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="selectRole('hider')" class="bg-gray-800 p-8 rounded-2xl border-2 border-gray-700 hover:border-yellow-400 transition-all group">
                <i class="fa-solid fa-user-secret text-5xl text-gray-500 group-hover:text-yellow-400 mb-4"></i>
                <div class="font-black text-xl text-white">HIDER</div>
            </button>
            <button onclick="selectRole('seeker')" class="bg-gray-800 p-8 rounded-2xl border-2 border-gray-700 hover:border-blue-400 transition-all group">
                <i class="fa-solid fa-binoculars text-5xl text-gray-500 group-hover:text-blue-400 mb-4"></i>
                <div class="font-black text-xl text-white">ZOEKER</div>
            </button>
        </div>
    </div>

    <!-- GAME DASHBOARD -->
    <div id="game-screen" class="hidden w-full max-w-lg space-y-4 pb-24">
        <!-- Header & Stats -->
        <div class="bg-gray-800/90 backdrop-blur p-4 rounded-xl sticky top-2 z-40 shadow-lg border border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center space-x-3">
                    <div id="role-icon" class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-700 text-lg"></div>
                    <div>
                        <div class="text-[10px] font-bold text-gray-400 uppercase">Lobby: <span id="display-lobby" class="text-white"></span></div>
                        <div class="text-sm font-bold text-white"><span id="display-user"></span></div>
                    </div>
                </div>
                <div id="role-badge" class="px-3 py-1 rounded-full font-black text-[10px] tracking-wider border border-white/10"></div>
            </div>
            <!-- Penalty Display -->
            <div class="flex justify-between bg-black/40 p-2 rounded text-xs font-mono">
                <span class="text-gray-400">STRAFTIJD:</span>
                <span id="penalty-display" class="text-red-400 font-bold">0 min</span>
            </div>
        </div>

        <!-- TIMER BAR -->
        <div id="timer-container" class="hidden sticky top-32 z-30 bg-gray-800 text-white p-2 rounded-lg text-center font-bold shadow-lg flex items-center justify-center space-x-2 border border-blue-500">
            <i class="fa-solid fa-hourglass-half animate-spin text-blue-400"></i>
            <span>ANTWOORD TIJD: <span id="countdown-display" class="font-mono text-xl">03:00</span></span>
        </div>

        <!-- CURSE OVERLAY (For Seekers) -->
        <div id="curse-overlay" class="hidden fixed inset-0 z-50 bg-red-950/95 backdrop-blur-sm flex flex-col items-center justify-center p-6 text-center space-y-6 overflow-y-auto">
            <div class="bg-gray-900 p-6 rounded-2xl border-2 border-red-500 shadow-2xl w-full max-w-md">
                <i class="fa-solid fa-triangle-exclamation text-6xl text-red-500 mb-4"></i>
                <h2 class="text-3xl font-black text-white mb-2 uppercase">Vloek Actief!</h2>
                <div id="active-curses-list" class="space-y-4 text-left"></div>
            </div>
        </div>

        <!-- HIDER VIEW -->
        <div id="hider-view" class="hidden space-y-4">
            
            <!-- Answer Panel -->
            <div id="hider-action-panel" class="hidden bg-blue-900 border border-blue-500 p-6 rounded-2xl text-center space-y-4 shadow-xl">
                <div class="inline-block bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider mb-1">Nieuwe Vraag</div>
                <h3 id="current-question-text" class="font-bold text-xl text-white">...</h3>
                <div class="text-xs text-blue-200">Niveau <span id="current-question-level"></span></div>
                
                <button onclick="openAnswerModal('question')" class="w-full bg-white text-blue-900 font-bold p-4 rounded-xl shadow-lg hover:bg-blue-50 transition flex items-center justify-center space-x-2">
                    <i class="fa-solid fa-paper-plane"></i>
                    <span>BEANTWOORDEN</span>
                </button>
            </div>

            <!-- Hand -->
            <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                <div class="flex justify-between items-end mb-4">
                    <h3 class="font-bold text-gray-200 flex items-center"><i class="fa-solid fa-hand text-yellow-400 mr-2"></i> Hand</h3>
                    <span class="text-xs font-mono bg-gray-900 text-gray-400 px-2 py-1 rounded"><span id="hand-count">0</span>/6</span>
                </div>
                <div id="hider-hand" class="space-y-3 min-h-[100px]"></div>
            </div>
        </div>

        <!-- SEEKER VIEW -->
        <div id="seeker-view" class="hidden space-y-4 relative">
            <!-- Block overlay when status is not idle -->
            <div id="seeker-lock" class="hidden absolute inset-0 bg-gray-900/80 z-20 flex flex-col items-center justify-center text-center p-4 rounded-xl backdrop-blur-sm">
                <i class="fa-solid fa-lock text-4xl text-gray-500 mb-2"></i>
                <p class="font-bold text-white">Wachten op Hiders...</p>
                <p class="text-xs text-gray-400 mt-1">Je kan geen vragen stellen nu.</p>
            </div>

            <div class="bg-gray-800 p-2 rounded-2xl border border-gray-700 sticky top-[85px] z-10 shadow-xl">
                <div class="flex space-x-1">
                    <button onclick="filterQuestions(1)" class="flex-1 py-3 rounded-xl bg-gray-700 text-gray-400 text-xs font-bold uppercase" id="btn-lvl-1">Niveau 1</button>
                    <button onclick="filterQuestions(2)" class="flex-1 py-3 rounded-xl bg-gray-700 text-gray-400 text-xs font-bold uppercase" id="btn-lvl-2">Niveau 2</button>
                    <button onclick="filterQuestions(3)" class="flex-1 py-3 rounded-xl bg-gray-700 text-gray-400 text-xs font-bold uppercase" id="btn-lvl-3">Niveau 3</button>
                </div>
            </div>
            <div id="questions-list" class="space-y-2 pb-10"></div>
        </div>

        <!-- LOG -->
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
            <h3 class="font-bold mb-3 text-gray-500 text-[10px] uppercase tracking-widest">Logboek</h3>
            <div id="game-log" class="text-xs space-y-2 h-40 overflow-y-auto text-gray-300 font-mono scrollbar-thin"></div>
        </div>
    </div>

    <!-- ANSWER / UPLOAD MODAL -->
    <div id="answer-modal" class="hidden fixed inset-0 bg-black/95 backdrop-blur flex items-center justify-center p-4 z-[60]">
        <div class="bg-gray-900 w-full max-w-md rounded-2xl p-6 space-y-4 border border-blue-500">
            <h3 class="text-xl font-bold text-white" id="answer-modal-title">Antwoorden</h3>
            
            <div>
                <label class="text-xs text-gray-400 uppercase font-bold">Tekst Antwoord</label>
                <textarea id="answer-text" class="w-full bg-gray-800 text-white p-3 rounded mt-1 h-24 border border-gray-700 focus:border-blue-500 outline-none"></textarea>
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase font-bold">Foto/Video (Optioneel)</label>
                <input type="file" id="answer-file" accept="image/*,video/*" class="w-full bg-gray-800 text-gray-300 text-xs p-2 rounded mt-1 border border-gray-700">
                <p class="text-[10px] text-gray-500 mt-1">Wordt geüpload naar GitHub. Max 5MB aanbevolen.</p>
            </div>

            <button id="btn-send-answer" onclick="submitAnswer()" class="w-full btn-primary p-3 rounded-lg flex justify-center items-center">
                <span id="btn-send-text">VERSTUREN</span>
                <i id="btn-send-loader" class="fa-solid fa-spinner fa-spin ml-2 hidden"></i>
            </button>
            <button onclick="closeAnswerModal()" class="w-full text-gray-500 text-xs py-2">Annuleren</button>
        </div>
    </div>

    <!-- CARD SELECTION MODAL -->
    <div id="card-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-gray-900 w-full max-w-md rounded-2xl p-6 space-y-6 border border-yellow-500/30">
            <div class="text-center">
                <i class="fa-solid fa-gifts text-4xl text-yellow-400 mb-2"></i>
                <h3 class="text-xl font-black text-white">KIES EEN KAART</h3>
                <p class="text-xs text-gray-400">Kies er 1 om te houden. De rest verdwijnt.</p>
            </div>
            <div id="modal-cards" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <!-- OVERFLOW MODAL -->
    <div id="overflow-modal" class="hidden fixed inset-0 bg-black/95 backdrop-blur flex items-center justify-center p-4 z-50">
        <div class="bg-gray-900 w-full max-w-md rounded-2xl p-6 space-y-4 border-2 border-red-500">
            <div class="text-center"><h3 class="text-xl font-black text-white">HAND ZIT VOL!</h3><p class="text-sm text-gray-400">Je moet kaarten weggooien tot je er 6 hebt.</p></div>
            <div class="space-y-2 bg-gray-800/50 p-3 rounded-xl"><h4 class="text-[10px] font-bold uppercase text-yellow-400">Nieuw:</h4><div id="overflow-new-cards" class="space-y-2"></div></div>
            <div class="space-y-2 bg-gray-800/50 p-3 rounded-xl"><h4 class="text-[10px] font-bold uppercase text-blue-400">Huidige Hand:</h4><div id="overflow-hand-cards" class="space-y-2 max-h-40 overflow-y-auto"></div></div>
            <button onclick="finishOverflow()" id="btn-finish-overflow" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold hidden">Klaar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- GITHUB CONFIG ---
        const GITHUB_CONFIG = {
            token: "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", 
            owner: "PeterWestgate",
            repo: "JET_LAG", 
            path: "uploads"
        };

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyCP1yVG3ssEyOub_F6P__90G1bM13kDaz0",
          authDomain: "jetlagleuven.firebaseapp.com",
          databaseURL: "https://jetlagleuven-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "jetlagleuven",
          storageBucket: "jetlagleuven.firebasestorage.app",
          messagingSenderId: "461047598360",
          appId: "1:461047598360:web:34dfbfa265e3004ceb626d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- COMPLETE DATASET ---
        const GAME_DATA = {
            questions: [
                // NIVEAU 1
                {id:1, niveau:1, categorie:"Locatie", vraag:"Zijn jullie links of rechts van de Dijle (stroomafwaarts)?"},
                {id:2, niveau:1, categorie:"Locatie", vraag:"Bevinden jullie je binnen de ring of op de ring zelf?"},
                {id:3, niveau:1, categorie:"Locatie", vraag:"Is de straatnaam waar jullie zijn langer dan 8 letters?"},
                {id:4, niveau:1, categorie:"Locatie", vraag:"Is de weg waar jullie zijn toegankelijk voor auto's?"},
                {id:5, niveau:1, categorie:"Omgeving", vraag:"Is de ondergrond waar jullie staan bestraat of onverhard?"},
                {id:6, niveau:1, categorie:"Omgeving", vraag:"Horen jullie op dit moment het geluid van stromend water?"},
                {id:7, niveau:1, categorie:"Omgeving", vraag:"Staan jullie onder een afdak/beschutting of in de open lucht?"},
                {id:8, niveau:1, categorie:"Omgeving", vraag:"Is het huisnummer van het dichtstbijzijnde gebouw even of oneven?"},
                {id:9, niveau:1, categorie:"Omgeving", vraag:"Zijn er meer dan 5 andere mensen zichtbaar in een straal van 20 meter?"},
                {id:10, niveau:1, categorie:"Omgeving", vraag:"Is er een fietsenstalling zichtbaar?"},
                {id:11, niveau:1, categorie:"Omgeving", vraag:"Staan jullie op een helling/heuvel of op vlakke grond?"},
                {id:12, niveau:1, categorie:"Omgeving", vraag:"Kunnen jullie een verkeerslicht zien vanaf jullie positie?"},
                {id:13, niveau:1, categorie:"Omgeving", vraag:"Is er een zitbankje binnen 10 meter?"},
                {id:14, niveau:1, categorie:"Omgeving", vraag:"Zien jullie een bewakingscamera?"},
                {id:15, niveau:1, categorie:"Omgeving", vraag:"Zie je op dit moment een hond?"},
                {id:16, niveau:1, categorie:"Omgeving", vraag:"Zie je een 'Verboden te parkeren' bord?"},
                {id:17, niveau:1, categorie:"Omgeving", vraag:"Sta je in de zon of in de schaduw?"},
                {id:18, niveau:1, categorie:"Omgeving", vraag:"Is er een zebrapad zichtbaar?"},
                {id:19, niveau:1, categorie:"Omgeving", vraag:"Zie je iemand fietsen?"},
                {id:20, niveau:1, categorie:"Omgeving", vraag:"Is er een rioolputje binnen 5 meter?"},
                {id:21, niveau:1, categorie:"Visueel", vraag:"Kunnen jullie een toren (kerk, bib, stadhuis) zien?"},
                {id:22, niveau:1, categorie:"Visueel", vraag:"Is er graffiti of street art zichtbaar?"},
                {id:23, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde gevel gemaakt van baksteen?"},
                {id:24, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde prullenbak groen of grijs?"},
                {id:25, niveau:1, categorie:"Visueel", vraag:"Sta je op kasseien?"},
                {id:26, niveau:1, categorie:"Visueel", vraag:"Zie je een vlag wapperen?"},
                {id:27, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde auto rood, zwart of grijs?"},
                {id:28, niveau:1, categorie:"Visueel", vraag:"Is de dichtstbijzijnde deur van hout of glas?"},
                {id:29, niveau:1, categorie:"Visueel", vraag:"Zie je een reclamebord?"},
                {id:30, niveau:1, categorie:"Visueel", vraag:"Zie je klimop of onkruid groeien?"},
                {id:31, niveau:1, categorie:"Visueel", vraag:"Zien jullie een balkon?"},
                {id:32, niveau:1, categorie:"Zintuig", vraag:"Ruik je op dit moment etensgeuren?"},
                {id:33, niveau:1, categorie:"Zintuig", vraag:"Voel je op dit moment wind?"},
                {id:34, niveau:1, categorie:"Audio", vraag:"Hoor je muziek?"},
                {id:35, niveau:1, categorie:"Audio", vraag:"Hoor je sirenes?"},

                // NIVEAU 2 (Specifiek - Trek 2 Kies 1)
                {id:36, niveau:2, categorie:"Locatie", vraag:"Zijn jullie dichter bij het Station dan bij de Grote Markt?"},
                {id:37, niveau:2, categorie:"Locatie", vraag:"Zijn jullie in een park (Stadspark, Kruidtuin, parkjes)?"},
                {id:38, niveau:2, categorie:"Locatie", vraag:"Zijn jullie dichter bij de Vaartkom dan bij het Arenbergpark?"},
                {id:39, niveau:2, categorie:"Locatie", vraag:"Zijn jullie binnen 200m van een supermarkt?"},
                {id:40, niveau:2, categorie:"Locatie", vraag:"Zijn jullie in de buurt van een universiteitsgebouw (KU Leuven vlaggen)?"},
                {id:41, niveau:2, categorie:"Locatie", vraag:"Zijn jullie ten Oosten of ten Westen van de Naamsestraat?"},
                {id:42, niveau:2, categorie:"Locatie", vraag:"Is je verstopplek binnen 250m van de Hoorn?"},
                {id:43, niveau:2, categorie:"Locatie", vraag:"Is je verstopplek dichter bij de Kruidtuin dan bij de Oude Markt?"},
                {id:44, niveau:2, categorie:"Foto", vraag:"Stuur een foto van de ondergrond (alleen jullie voeten en de grond)."},
                {id:45, niveau:2, categorie:"Foto", vraag:"Stuur een foto van de lucht recht boven jullie."},
                {id:46, niveau:2, categorie:"Foto", vraag:"Stuur een foto van het dichtstbijzijnde verkeersbord (zonder straatnaam)."},
                {id:47, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een object dat 'ROOD' is in jullie omgeving."},
                {id:48, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een textuur in de buurt (muur, schors, paal) close-up."},
                {id:49, niveau:2, categorie:"Foto", vraag:"Stuur een foto van jullie eigen schaduw op de grond."},
                {id:50, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een reflectie (in raam, plas, zonnebril)."},
                {id:51, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een 'rond' object in je omgeving."},
                {id:52, niveau:2, categorie:"Foto", vraag:"Stuur een foto van iets dat van metaal is gemaakt."},
                {id:53, niveau:2, categorie:"Foto", vraag:"Stuur een foto van iets dat geel is."},
                {id:54, niveau:2, categorie:"Foto", vraag:"Stuur een foto van een slot (fietsslot, deurslot)."},
                {id:55, niveau:2, categorie:"Puzzel", vraag:"Wat is de eerste letter van de straat waar jullie zijn?"},
                {id:56, niveau:2, categorie:"Puzzel", vraag:"Hoeveel stappen zijn jullie verwijderd van de dichtstbijzijnde vuilnisbak?"},
                {id:57, niveau:2, categorie:"Puzzel", vraag:"Welke letter komt het vaakst voor op de borden om je heen?"},
                {id:58, niveau:2, categorie:"Puzzel", vraag:"Tel het aantal ramen op de begane grond van het gebouw tegenover je."},
                {id:59, niveau:2, categorie:"Puzzel", vraag:"Zie je een nummerbord met het cijfer 7 erin?"},
                {id:60, niveau:2, categorie:"Omgeving", vraag:"Is er een horecazaak (café/restaurant) zichtbaar met een terras?"},
                {id:61, niveau:2, categorie:"Omgeving", vraag:"Zie je een fiets die fout geparkeerd staat?"},
                {id:62, niveau:2, categorie:"Omgeving", vraag:"Zie je een kinderwagen?"},
                {id:63, niveau:2, categorie:"Omgeving", vraag:"Is het gebouw achter je hoger dan 3 verdiepingen?"},
                {id:64, niveau:2, categorie:"Omgeving", vraag:"Is er glasafval of zwerfvuil zichtbaar?"},
                {id:65, niveau:2, categorie:"Visueel", vraag:"Wat is de kleur van de voordeur die het dichtst bij is?"},
                {id:66, niveau:2, categorie:"Visueel", vraag:"Is de straatverlichting hangend aan een draad of op een paal?"},
                {id:67, niveau:2, categorie:"Visueel", vraag:"Is de dichtstbijzijnde gevel wit geverfd?"},
                {id:68, niveau:2, categorie:"Visueel", vraag:"Zie je een regenpijp? Welke kleur?"},
                {id:69, niveau:2, categorie:"Observatie", vraag:"Zie je iemand die een bril draagt?"},
                {id:70, niveau:2, categorie:"Audio", vraag:"Hoor je een klok luiden?"},

                // NIVEAU 3 (Risico - Trek 3 Kies 1)
                {id:71, niveau:3, categorie:"Risico", vraag:"Stuur een foto van het uitzicht op ooghoogte (zonder jullie zelf)."},
                {id:72, niveau:3, categorie:"Risico", vraag:"Stuur een geluidsopname van 15 seconden van de omgeving."},
                {id:73, niveau:3, categorie:"Risico", vraag:"Geef de naam van de dichtstbijzijnde winkel, café of openbaar gebouw."},
                {id:74, niveau:3, categorie:"Risico", vraag:"Loop naar de dichtstbijzijnde hoek en stuur een foto van wat je daar ziet."},
                {id:75, niveau:3, categorie:"Risico", vraag:"Zijn jullie binnen een straal van 300m van het Ladeuzeplein?"},
                {id:76, niveau:3, categorie:"Risico", vraag:"Stuur een 360 graden panoramafoto (hiders mogen gezicht verbergen)."},
                {id:77, niveau:3, categorie:"Risico", vraag:"Wat is de laatste letter van de straatnaam waar jullie zijn?"},
                {id:78, niveau:3, categorie:"Risico", vraag:"Film 5 seconden lang de grond terwijl je ronddraait."},
                {id:79, niveau:3, categorie:"Risico", vraag:"Geef een beschrijving van de persoon die het dichtst bij jullie staat (niet-speler)."},
                {id:80, niveau:3, categorie:"Risico", vraag:"Teken een ruwe schets van de plattegrond van jullie directe omgeving en stuur de foto."},
                {id:81, niveau:3, categorie:"Risico", vraag:"Stuur een foto van het hoogste punt dat jullie kunnen zien."},
                {id:82, niveau:3, categorie:"Risico", vraag:"Hoeveel ramen heeft het gebouw recht tegenover jullie?"},
                {id:83, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een object dat begint met de letter 'S'."},
                {id:84, niveau:3, categorie:"Risico", vraag:"Zijn jullie binnen de 'oude stadsomwalling' (binnenring)?"},
                {id:85, niveau:3, categorie:"Risico", vraag:"Beschrijf de schoenen van de dichtstbijzijnde voorbijganger."},
                {id:86, niveau:3, categorie:"Risico", vraag:"Wat is het laatste cijfer van het dichtstbijzijnde huisnummer?"},
                {id:87, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een patroon (kasseien, hekwerk) in de buurt."},
                {id:88, niveau:3, categorie:"Risico", vraag:"Hoeveel stappen ben je van de dichtstbijzijnde straathoek?"},
                {id:89, niveau:3, categorie:"Risico", vraag:"Zie je een 'Verboden' bord? Welke kleur?"},
                {id:90, niveau:3, categorie:"Risico", vraag:"Stuur een close-up van iets dat van hout is."},
                {id:91, niveau:3, categorie:"Risico", vraag:"Is er constructie/wegenwerken zichtbaar?"},
                {id:92, niveau:3, categorie:"Risico", vraag:"Zie je een uniform (politie, post, lijn)?"},
                {id:93, niveau:3, categorie:"Risico", vraag:"Stuur een foto van iets ouds/historisch (detail)."},
                {id:94, niveau:3, categorie:"Risico", vraag:"Stuur een foto van iets moderns/nieuws."},
                {id:95, niveau:3, categorie:"Risico", vraag:"Beschrijf de geur van de omgeving in 1 woord."},
                {id:96, niveau:3, categorie:"Risico", vraag:"Zie je een standbeeld?"},
                {id:97, niveau:3, categorie:"Risico", vraag:"Tel het aantal geparkeerde fietsen in zicht (ongeveer)."},
                {id:98, niveau:3, categorie:"Risico", vraag:"Stuur een foto van graffiti of een sticker in de buurt."},
                {id:99, niveau:3, categorie:"Risico", vraag:"Kun je de hemel zien of zit je ergens onder?"},
                {id:100, niveau:3, categorie:"Risico", vraag:"Is het hier stiller of luider dan op de Oude Markt?"},
                {id:101, niveau:3, categorie:"Risico", vraag:"Welke kleur hebben de kozijnen van het dichtstbijzijnde huis?"},
                {id:102, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een plant of bloem in de buurt."},
                {id:103, niveau:3, categorie:"Risico", vraag:"Zie je een brievenbus van Bpost?"},
                {id:104, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een straatnaambord (TEKST ONZICHTBAAR MAKEN)."},
                {id:105, niveau:3, categorie:"Risico", vraag:"Stuur een foto van een object groter dan 1x1x1m in directe omgeving."}
            ],
            deck: [
                // TIJD (15 kaarten)
                {id:1, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:2, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:3, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:4, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:5, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:6, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:7, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:8, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:9, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:10, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:11, type:"Tijd", naam:"Bonus 15 Min", effect:"Eindtijd + 15 minuten.", taak:"Geen taak."},
                {id:12, type:"Tijd", naam:"Bonus 15 Min", effect:"Eindtijd + 15 minuten.", taak:"Geen taak."},
                {id:13, type:"Tijd", naam:"Bonus 15 Min", effect:"Eindtijd + 15 minuten.", taak:"Geen taak."},
                {id:14, type:"Tijd", naam:"Bonus 30 Min", effect:"Eindtijd + 30 minuten.", taak:"Geen taak."},
                {id:15, type:"Tijd", naam:"Bonus 1 Uur", effect:"Eindtijd + 1 Uur.", taak:"Geen taak."},

                // VLOEKEN (46 kaarten)
                {id:16, type:"Vloek", naam:"Freeze (2 min)", effect:"Zoekers moeten direct 2 minuten stilstaan.", taak:"Maak een selfie met een standbeeld (of paal)."},
                {id:17, type:"Vloek", naam:"Freeze (2 min)", effect:"Zoekers moeten direct 2 minuten stilstaan.", taak:"Maak een selfie met een standbeeld (of paal)."},
                {id:18, type:"Vloek", naam:"De Snack Pauze", effect:"Zoekers moeten een snack kopen/eten.", taak:"Overtuig een vreemde om te zwaaien."},
                {id:19, type:"Vloek", naam:"Achteruit", effect:"Zoekers moeten de volgende straat achteruit lopen.", taak:"Film 30 sec moonwalken."},
                {id:20, type:"Vloek", naam:"Hand in Hand", effect:"Zoekers lopen 5 min hand in hand.", taak:"Knoop elkaars veters aan elkaar."},
                {id:21, type:"Vloek", naam:"Op één been", effect:"Zoekers wachten 1 min op één been.", taak:"Sta 1 min op één been als een flamingo."},
                {id:22, type:"Vloek", naam:"Selfie Time", effect:"Zoekers moeten selfie maken met vreemde.", taak:"Maak zelf ook een selfie met vreemde."},
                {id:23, type:"Vloek", naam:"De Vloer is Lava", effect:"Zoekers mogen 3 min straat niet raken.", taak:"Klim ergens op (muurtje, bankje)."},
                {id:24, type:"Vloek", naam:"Slow Motion", effect:"Zoekers bewegen 2 min in slow-mo.", taak:"Film een slow-motion vechtscène."},
                {id:25, type:"Vloek", naam:"Tas Wissel", effect:"Zoekers wisselen rugzak/jas (10 min).", taak:"Doe je schoenen aan de verkeerde voeten."},
                {id:26, type:"Vloek", naam:"Sprintje", effect:"Zoekers trekken sprintje van 50m.", taak:"Doe 20 jumping jacks."},
                {id:27, type:"Vloek", naam:"Omweg Standbeeld", effect:"Zoekers lopen naar dichtstbijzijnde beeld.", taak:"Zing luidkeels het volkslied."},
                {id:28, type:"Vloek", naam:"Vraag Weigeren", effect:"Annuleer huidige vraag.", taak:"Bouw toren van 5 objecten (stenen, takjes)."},
                {id:29, type:"Vloek", naam:"Vraag Weigeren", effect:"Annuleer huidige vraag.", taak:"Bouw toren van 5 objecten."},
                {id:30, type:"Vloek", naam:"Splitsing", effect:"Zoekers gaan 200m uit elkaar (10 min).", taak:"Doe je jas binnenstebuiten aan."},
                {id:31, type:"Vloek", naam:"Links Afslaan", effect:"Zoekers slaan enkel links af (5 min).", taak:"Draai 10 rondjes om je as."},
                {id:32, type:"Vloek", naam:"Geen Maps", effect:"Zoekers: 5 min geen Google Maps.", taak:"Teken een portret van elkaar in 30 sec."},
                {id:33, type:"Vloek", naam:"De Polonaise", effect:"Zoekers lopen 2 min in polonaise.", taak:"Doe de kabouterdans met bewegingen."},
                {id:34, type:"Vloek", naam:"Vogelspotter", effect:"Zoekers moeten duif fotograferen.", taak:"Doe een vogel na (geluid + wapperen)."},
                {id:35, type:"Vloek", naam:"Bus Roulette", effect:"Zoekers nemen bus voor 1 halte (indien mogelijk).", taak:"Film 1 minuut Macarena dansen."},
                {id:36, type:"Vloek", naam:"De Noodklok", effect:"Zoekers moeten kerkdeur aanraken.", taak:"Draag een gedicht voor over de zoekers."},
                {id:37, type:"Vloek", naam:"Blinddoek", effect:"1 Zoeker wordt 5 min geblinddoekt.", taak:"Sta 1 minuut roerloos stil als standbeeld."},
                {id:38, type:"Vloek", naam:"De Toerist", effect:"Zoekers vragen weg aan voorbijganger.", taak:"Spreek voorbijganger aan en wens ze een fijne dag."},
                {id:39, type:"Vloek", naam:"Waterdrager", effect:"Zoekers moeten flesje water atten.", taak:"Doe 10 push-ups in het openbaar."},
                {id:40, type:"Vloek", naam:"Papegaai", effect:"Zoekers herhalen alles wat 1 iemand zegt (5m).", taak:"Praat 1 min tegen lantaarnpaal."},
                {id:41, type:"Vloek", naam:"Hinkelen", effect:"Zoekers moeten 50m hinkelen.", taak:"Hinkelen zelf 1 minuut."},
                {id:42, type:"Vloek", naam:"Stilte (5 min)", effect:"Zoekers niet praten/typen.", taak:"Wees 5 minuten doodstil (geen geluid)."},
                {id:43, type:"Vloek", naam:"De Mol", effect:"Zoekers delen 5 min live locatie.", taak:"Zoek een foto van een mol op Google."},
                {id:44, type:"Vloek", naam:"Alleen Fietsen", effect:"Zoekers moeten 15 min alles fietsen.", taak:"Sta 3 minuten rug-aan-rug, ogen dicht."},
                {id:45, type:"Vloek", naam:"Alleen Lopen", effect:"Zoekers moeten 15 min alles lopen.", taak:"Zing 1 minuut luidkeels een lied."},
                {id:46, type:"Vloek", naam:"Brug Tol", effect:"Binnen 5 min andere brug oversteken.", taak:"Maak een \"brug\" met lichaam (30s)."},
                {id:47, type:"Vloek", naam:"Omweg Oude Markt", effect:"Zoekers moeten naar Oude Markt.", taak:"Vind object met letter 'O'."},
                {id:48, type:"Vloek", naam:"Oriëntatie", effect:"Zoekers 10 min geen kompas/draaien.", taak:"Draai 1 min langzaam rondjes."},
                {id:49, type:"Vloek", naam:"Pad Blokkeren", effect:"Kies straat waar zoekers niet in mogen (20m).", taak:"Bouw barricade van takjes."},
                {id:50, type:"Vloek", naam:"Stille Zone", effect:"Zoekers 15 min niet praten/typen.", taak:"Wees 5 min doodstil."},
                {id:51, type:"Vloek", naam:"Tijdelijke Afleiding", effect:"Hiders bellen zoekers 1 min.", taak:"Verkoop product zonder 'uhm' te zeggen."},
                {id:52, type:"Vloek", naam:"Rode Licht", effect:"Wachten bij elk rood licht (ook spooklichten).", taak:"Doe 20 Jumping Jacks."},
                {id:53, type:"Vloek", naam:"Veter Foltering", effect:"1 Zoeker moet veters opnieuw strikken.", taak:"Doe schoenen verkeerd om aan."},
                {id:54, type:"Vloek", naam:"Kunst Jacht", effect:"Zoekers moeten kunstwerk vinden.", taak:"Bedenk raadsel over locatie."},
                {id:55, type:"Vloek", naam:"Verkeerde Afslag", effect:"Zoekers moeten 200m teruglopen.", taak:"Loop 3 min achteruit in cirkel."},
                {id:56, type:"Vloek", naam:"Lied van Leuven", effect:"Zoekers zingen lied over Leuven.", taak:"Doe een dier na (1 min)."},
                {id:57, type:"Vloek", naam:"Zoeker Afleiden", effect:"Zoekers dansen Macarena.", taak:"Dans Macarena zonder muziek."},
                {id:58, type:"Vloek", naam:"Zoeker Ruil", effect:"Zoekers wisselen jas/tas (10 min).", taak:"Trek sokken over broekspijpen."},
                {id:59, type:"Vloek", naam:"Ruisonderdrukking", effect:"Hiders wachten 10 min met antwoord.", taak:"Zit 2 min vingers in oren, ogen dicht."},
                {id:60, type:"Vloek", naam:"Vertraging", effect:"Zoekers 2 min stilstaan.", taak:"Doe maanlanding in slow-mo."},
                {id:61, type:"Vloek", naam:"Verwarring", effect:"Zoekers 5 min naar Noorden lopen.", taak:"Wijs 1 min naar willekeurige richtingen."},

                // BONUSSEN (18 kaarten)
                {id:62, type:"Bonus", naam:"Locatie Wissel", effect:"Hiders verplaatsen zich 5 min (rennend).", taak:"Roep \"WIJ ZIJN BANG\"."},
                {id:63, type:"Bonus", naam:"De Mime", effect:"Zoekers zwijgen 10 min, enkel gebaren.", taak:"Beeld film uit (zoekers raden)."},
                {id:64, type:"Bonus", naam:"De Leugen", effect:"Lieg op de VOLGENDE vraag.", taak:"Eet iets zuurs/vies (veilig)."},
                {id:65, type:"Bonus", naam:"Mist", effect:"Zoekers mogen 15 min GEEN vragen stellen.", taak:"Houd 1 min elkaars hand vast."},
                {id:66, type:"Bonus", naam:"Camouflage", effect:"Stuur foto ander persoon bij beschrijving.", taak:"Verberg gezicht volledig (5 min)."},
                {id:67, type:"Bonus", naam:"Radar Jammer", effect:"Zoekers zetten live locatie uit (10 min).", taak:"Roep 10x \"KEKO KEKO!\"."},
                {id:68, type:"Bonus", naam:"Safehouse", effect:"Zoekers wachten 2 min voor tikken.", taak:"Maak kunstwerk van afval."},
                {id:69, type:"Bonus", naam:"Copycat", effect:"Kopieer effect van vorige kaart nog eens.", taak:"Doe de vorige opdracht nog eens, maar 2x sneller."},
                {id:70, type:"Bonus", naam:"Herpositioneren", effect:"Hiders verplaatsen 2 min (Nieuwe plek).", taak:"Roep \"WIJ VERPLAATSEN\"."},
                {id:71, type:"Bonus", naam:"Noodontsnapping", effect:"Verplaats 50m (als zoekers <100m).", taak:"Ren rondje om verstopplek."},
                {id:72, type:"Bonus", naam:"Onzichtbaar", effect:"2 min radiostilte.", taak:"Lig 1 min plat op de grond."},
                {id:73, type:"Bonus", naam:"Souvenir", effect:"Zoekers kopen souvenir voor hiders.", taak:"Maak bedankvideo."},
                {id:74, type:"Bonus", naam:"Snelle Ontsnapping", effect:"Verplaats 200m (Immobiliteit verbroken).", taak:"Foto van voeten in de lucht."},
                {id:75, type:"Bonus", naam:"Stealth Modus", effect:"10 min geen vragen.", taak:"Fluister 1 minuut lang."},
                {id:76, type:"Bonus", naam:"Tijd Rekken", effect:"Zoekers wachten 5 min extra op antwoord.", taak:"Tel hardop tot 60 in Engels."},
                {id:77, type:"Bonus", naam:"Upgrade", effect:"Huidige plek \"Extra Goed\" (+10 min).", taak:"Maak reclamepraatje over plek."},
                {id:78, type:"Bonus", naam:"Vraag Blok", effect:"Weiger huidige vraag.", taak:"Bouw kaartenhuis."},
                {id:79, type:"Bonus", naam:"Trekken", effect:"Gooi kaarten weg, trek nieuwe.", taak:"Schud denkbeeldige kaarten (30s)."}
            ]
        };

        let currentUser = null;
        let currentLobby = null;
        let myRole = null;
        let allQuestions = [];
        let allCards = [];
        let gameState = {};
        let activeCurses = [];
        let timerInterval = null;
        let currentModalContext = null; // 'question' or 'curse_ID'

        // --- AUTH & LOBBY ---
        window.joinLobby = async () => {
            const btn = document.getElementById('join-btn');
            btn.innerText = "Laden..."; btn.disabled = true;
            const name = document.getElementById('username').value;
            const lobby = document.getElementById('lobbycode').value.toUpperCase();
            
            if(!name || !lobby) { btn.innerText = "START SPEL"; btn.disabled = false; return alert("Vul alles in"); }

            try {
                await signInAnonymously(auth);
                currentUser = { uid: auth.currentUser.uid, name: name };
                currentLobby = lobby;
                document.getElementById('display-lobby').innerText = lobby;
                document.getElementById('display-user').innerText = name;

                const lobbyRef = ref(db, `lobbies/${lobby}`);
                const snapshot = await get(lobbyRef);

                if (!snapshot.exists()) {
                    await set(lobbyRef, {
                        created: serverTimestamp(),
                        questions: GAME_DATA.questions,
                        deck: GAME_DATA.deck,
                        status: 'idle', // idle, answering
                        penaltyTime: 0,
                        logs: { "init": { msg: `Lobby ${lobby} gestart`, time: Date.now() } }
                    });
                }
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('role-screen').classList.remove('hidden');
                listenToGame();
            } catch (e) { alert("Login error: " + e.message); btn.disabled = false; }
        };

        window.selectRole = (role) => {
            myRole = role;
            document.getElementById('role-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            const badge = document.getElementById('role-badge');
            badge.innerText = role.toUpperCase();
            badge.className = `px-3 py-1 rounded-full font-black text-xs tracking-wider ${role === 'hider' ? 'bg-yellow-500 text-black' : 'bg-blue-500 text-white'}`;
            
            if(role === 'hider') document.getElementById('hider-view').classList.remove('hidden');
            if(role === 'seeker') {
                document.getElementById('seeker-view').classList.remove('hidden');
                filterQuestions(1);
            }
            updateUI();
        };

        // --- SYNC ---
        function listenToGame() {
            onValue(ref(db, `lobbies/${currentLobby}`), (snap) => {
                const data = snap.val();
                if(!data) return;
                allQuestions = data.questions || [];
                allCards = data.deck || [];
                gameState = { 
                    status: data.status, 
                    questionId: data.activeQuestion, 
                    startTime: data.timerStart,
                    penalty: data.penaltyTime || 0
                };
                activeCurses = data.activeCurses ? Object.entries(data.activeCurses) : [];
                
                document.getElementById('penalty-display').innerText = `${gameState.penalty} min`;
                updateLogs(data.logs || {});
                handleTimer();
                updateUI();
            });
        }

        // --- UI UPDATES ---
        function updateUI() {
            const hiderPanel = document.getElementById('hider-action-panel');
            const seekerLock = document.getElementById('seeker-lock');
            const curseOverlay = document.getElementById('curse-overlay');

            // 1. Status Checks
            const isAnswering = gameState.status === 'answering';
            const hasCurses = activeCurses.length > 0;

            // Seeker Lock
            if (isAnswering || hasCurses) {
                seekerLock.classList.remove('hidden');
                seekerLock.innerHTML = isAnswering 
                    ? `<i class="fa-solid fa-hourglass-half text-4xl mb-2 text-yellow-500"></i><p>Hiders zijn aan het antwoorden...</p>`
                    : `<i class="fa-solid fa-skull text-4xl mb-2 text-red-500"></i><p>VLOEK ACTIEF!</p>`;
            } else {
                seekerLock.classList.add('hidden');
            }

            // Hider Panel
            if (myRole === 'hider' && isAnswering) {
                const q = allQuestions.find(i => i.id == gameState.questionId);
                if(q) {
                    hiderPanel.classList.remove('hidden');
                    document.getElementById('current-question-text').innerText = q.vraag;
                    document.getElementById('current-question-level').innerText = q.niveau;
                }
            } else {
                hiderPanel.classList.add('hidden');
            }

            // Curse Overlay (Seekers Only)
            if (myRole === 'seeker' && hasCurses) {
                curseOverlay.classList.remove('hidden');
                const list = document.getElementById('active-curses-list');
                list.innerHTML = '';
                activeCurses.forEach(([key, curse]) => {
                    list.innerHTML += `
                        <div class="bg-gray-800 p-4 rounded border border-red-500 mb-2">
                            <h4 class="font-bold text-yellow-400">${curse.naam}</h4>
                            <p class="text-white text-xs mb-2">${curse.effect}</p>
                            <button onclick="openAnswerModal('curse_${key}')" class="w-full bg-green-600 p-2 rounded text-xs font-bold">
                                <i class="fa-solid fa-camera mr-1"></i> Bewijs / Klaar
                            </button>
                        </div>`;
                });
            } else {
                curseOverlay.classList.add('hidden');
            }

            // Hider Hand
            if (myRole === 'hider') {
                const hand = allCards.filter(c => c.status === 'hand');
                document.getElementById('hand-count').innerText = hand.length;
                const container = document.getElementById('hider-hand');
                container.innerHTML = hand.length ? '' : '<p class="text-gray-500 text-sm italic text-center py-4">Leeg</p>';
                
                hand.forEach(c => {
                    let color = c.type === 'Vloek' ? 'text-red-400' : (c.type === 'Bonus' ? 'text-blue-400' : 'text-green-400');
                    container.innerHTML += `
                        <div class="bg-gray-700 p-3 rounded flex justify-between items-center border border-gray-600">
                            <div class="w-2/3">
                                <div class="text-xs font-bold ${color}">${c.type}</div>
                                <div class="font-bold text-sm text-white">${c.naam}</div>
                                <div class="text-[10px] text-gray-400">${c.effect}</div>
                                <div class="text-[10px] text-yellow-500 italic mt-1">Taak: ${c.taak}</div>
                            </div>
                            <div class="space-y-1">
                                <button onclick="playCard('${c.id}')" class="bg-green-600 text-white text-[10px] px-2 py-1 rounded block w-full">SPEEL</button>
                                <button onclick="discardCard('${c.id}')" class="bg-red-900 text-red-200 text-[10px] px-2 py-1 rounded block w-full">WEG</button>
                            </div>
                        </div>`;
                });
            }

            // Refresh Seeker list
            if(myRole === 'seeker') {
                const activeBtn = document.querySelector('#seeker-view button.ring-2');
                if(activeBtn) {
                    // check ID to determine level
                    if(activeBtn.id === 'btn-lvl-1') filterQuestions(1);
                    if(activeBtn.id === 'btn-lvl-2') filterQuestions(2);
                    if(activeBtn.id === 'btn-lvl-3') filterQuestions(3);
                } else {
                    filterQuestions(1);
                }
            }
        }

        // --- TIMER & PENALTY ---
        function handleTimer() {
            clearInterval(timerInterval);
            const timerDiv = document.getElementById('timer-container');
            if (gameState.status === 'answering' && gameState.startTime) {
                timerDiv.classList.remove('hidden');
                timerInterval = setInterval(() => {
                    const diff = 180000 - (Date.now() - gameState.startTime); // 3 min
                    if (diff <= 0) {
                        document.getElementById('countdown-display').innerText = "TE LAAT! (-10 min)";
                        timerDiv.classList.replace('bg-gray-800', 'bg-red-600');
                    } else {
                        const m = Math.floor(diff / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        document.getElementById('countdown-display').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                    }
                }, 1000);
            } else {
                timerDiv.classList.add('hidden');
                timerDiv.classList.replace('bg-red-600', 'bg-gray-800');
            }
        }

        // --- ANSWER & UPLOAD ---
        window.openAnswerModal = (context) => {
            currentModalContext = context;
            document.getElementById('answer-modal').classList.remove('hidden');
            document.getElementById('answer-text').value = "";
            document.getElementById('answer-file').value = "";
            document.getElementById('answer-modal-title').innerText = context.startsWith('curse') ? "Vloek Oplossen" : "Vraag Beantwoorden";
        };

        window.closeAnswerModal = () => document.getElementById('answer-modal').classList.add('hidden');

        window.submitAnswer = async () => {
            const text = document.getElementById('answer-text').value;
            const fileInput = document.getElementById('answer-file');
            const btn = document.getElementById('btn-send-answer');
            const loader = document.getElementById('btn-send-loader');
            const btnText = document.getElementById('btn-send-text');

            if(!text && fileInput.files.length === 0) return alert("Vul iets in of kies een bestand.");

            // UI Loading state
            btn.disabled = true;
            btnText.innerText = "UPLOADING...";
            loader.classList.remove('hidden');

            let mediaUrl = "";

            // GitHub Upload Logic
            if(fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                try {
                    const contentBase64 = await new Promise((resolve, reject) => {
                        reader.onload = e => resolve(e.target.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });

                    const fileName = `${Date.now()}_${file.name}`;
                    const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}/${fileName}`;
                    
                    const res = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Upload from game by ${currentUser.name}`,
                            content: contentBase64
                        })
                    });

                    if(!res.ok) throw new Error("GitHub Upload Failed");
                    const json = await res.json();
                    mediaUrl = json.content.download_url; // Direct link

                } catch (e) {
                    console.error(e);
                    alert("Upload mislukt! Check console/token. Tekst wordt wel verstuurd.");
                }
            }

            // Process Logic based on Context
            if (currentModalContext === 'question') {
                // Check Penalty
                const timeTaken = Date.now() - gameState.startTime;
                let penaltyAdded = 0;
                if (timeTaken > 180000) { // 3 mins
                    penaltyAdded = 10;
                    // Update penalty in DB
                    const currentP = gameState.penalty || 0;
                    update(ref(db, `lobbies/${currentLobby}`), { penaltyTime: currentP + 10 });
                }

                // Log Answer
                const msg = `ANTWOORD: ${text} ${mediaUrl ? `[BEKIJK MEDIA](${mediaUrl})` : ''} ${penaltyAdded ? '(+10 MIN STRAF!)' : ''}`;
                push(ref(db, `lobbies/${currentLobby}/logs`), { msg: msg, time: Date.now() });

                // Draw Cards Logic
                const q = allQuestions.find(qu => qu.id == gameState.questionId);
                let drawAmount = q.niveau;
                if(q.categorie === 'Foto' || q.categorie === 'Risico') drawAmount = 3;
                
                update(ref(db, `lobbies/${currentLobby}/status`), 'idle'); // Unlock seekers
                closeAnswerModal();
                initiateDraw(drawAmount);

            } else if (currentModalContext.startsWith('curse_')) {
                const curseKey = currentModalContext.split('_')[1];
                remove(ref(db, `lobbies/${currentLobby}/activeCurses/${curseKey}`));
                
                const msg = `VLOEK OPGELOST: ${text} ${mediaUrl ? `[BEWIJS](${mediaUrl})` : ''}`;
                push(ref(db, `lobbies/${currentLobby}/logs`), { msg: msg, time: Date.now() });
                closeAnswerModal();
            }

            // Reset UI
            btn.disabled = false;
            btnText.innerText = "VERSTUREN";
            loader.classList.add('hidden');
        };

        // --- CARD DRAW LOGIC (Hergebruik van vorige keer, maar robuust) ---
        function initiateDraw(amount) {
            const deck = allCards.filter(c => !c.status || c.status === 'deck');
            const selection = [];
            let tempDeck = [...deck];
            for(let i=0; i<amount; i++) {
                if(tempDeck.length === 0) break;
                const r = Math.floor(Math.random() * tempDeck.length);
                selection.push(tempDeck[r]);
                tempDeck.splice(r, 1);
            }

            const hand = allCards.filter(c => c.status === 'hand');
            if(hand.length >= 6) {
                showOverflowModal(hand, selection);
            } else {
                if(amount === 1) addToHand(selection[0].id);
                else showSelectionModal(selection);
            }
        }

        // ... (De rest van de kaart logica: showSelectionModal, showOverflowModal, addToHand, playCard, discardCard blijft hetzelfde als vorige versie, maar playCard voegt toe aan activeCurses) ...
        
        function addToHand(cid) {
            const index = allCards.findIndex(c => c.id == cid);
            update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'hand' });
        }
        
        function addToHandSilent(cid) { addToHand(cid); }
        
        function discardCardSilent(cid) {
             const index = allCards.findIndex(c => c.id == cid);
             update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'discarded' });
        }

        window.playCard = (cid) => {
            if(!confirm("Kaart spelen?")) return;
            const index = allCards.findIndex(c => c.id == cid);
            const card = allCards[index];
            update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'played' });
            
            if(card.type === 'Vloek') {
                push(ref(db, `lobbies/${currentLobby}/activeCurses`), card);
            } else if (card.type === 'Tijd') {
                // Tijd bonus logica kan hier (bv penalty verminderen)
            }
            
            push(ref(db, `lobbies/${currentLobby}/logs`), { msg: `KAART GESPEELD: ${card.naam}`, time: Date.now() });
        };

        window.discardCard = (cid) => {
            if(!confirm("Weggooien?")) return;
            const index = allCards.findIndex(c => c.id == cid);
            update(ref(db, `lobbies/${currentLobby}/deck/${index}`), { status: 'discarded' });
        };
        
        // --- CLEAR CURSE ---
        window.clearCurse = (curseKey) => {
            if(!confirm("Zijn jullie zeker dat deze vloek voorbij is of de taak voltooid is?")) return;
            remove(ref(db, `lobbies/${currentLobby}/activeCurses/${curseKey}`));
            
            push(ref(db, `lobbies/${currentLobby}/logs`), {
                msg: `Vloek opgeheven door zoekers.`,
                time: Date.now()
            });
        };

        // ... (Overflow modal functies ook kopiëren van vorige versie) ...
        function showSelectionModal(cards) {
            const modal = document.getElementById('card-modal');
            const container = document.getElementById('modal-cards');
            container.innerHTML = "";
            cards.forEach(c => {
                const div = document.createElement('div');
                div.className = "bg-gray-800 p-4 rounded border border-yellow-500 cursor-pointer";
                div.innerHTML = `<div class="font-bold text-yellow-400">${c.naam}</div><div class="text-xs text-white">${c.effect}</div>`;
                div.onclick = () => { addToHand(c.id); closeModal(); };
                container.appendChild(div);
            });
            modal.classList.remove('hidden');
        }

        function showOverflowModal(handCards, newCards) {
            const modal = document.getElementById('overflow-modal');
            const newContainer = document.getElementById('overflow-new-cards');
            const handContainer = document.getElementById('overflow-hand-cards');
            const finishBtn = document.getElementById('btn-finish-overflow');
            
            modal.classList.remove('hidden');
            newContainer.innerHTML = "";
            handContainer.innerHTML = "";
            finishBtn.classList.add('hidden');

            newCards.forEach(c => {
                const div = document.createElement('div');
                div.className = "bg-gray-800 p-2 rounded border border-green-500 cursor-pointer text-xs";
                div.innerText = `${c.naam}`;
                div.onclick = () => {
                    addToHandSilent(c.id); 
                    alert("Toegevoegd. Gooi nu eentje weg.");
                    modal.classList.add('hidden');
                    // In real implementation force discard logic here
                };
                newContainer.appendChild(div);
            });
            
            handCards.forEach(c => {
                 const div = document.createElement('div');
                 div.className = "bg-gray-800 p-2 rounded border border-red-500 cursor-pointer text-xs flex justify-between";
                 div.innerHTML = `<span>${c.naam}</span> <i class="fa-solid fa-trash"></i>`;
                 div.onclick = () => { discardCardSilent(c.id); alert("Weggegooid."); };
                 handContainer.appendChild(div);
            });
        }

        window.closeModal = () => document.getElementById('card-modal').classList.add('hidden');
        window.finishOverflow = () => document.getElementById('overflow-modal').classList.add('hidden');

        // Seeker Actions
        window.filterQuestions = (level) => {
            const list = document.getElementById('questions-list');
            list.innerHTML = "";
            
            // Buttons visual state
            const btn1 = document.getElementById('btn-lvl-1');
            const btn2 = document.getElementById('btn-lvl-2');
            const btn3 = document.getElementById('btn-lvl-3');
            
            [btn1, btn2, btn3].forEach(b => {
                b.classList.remove('ring-2', 'ring-white', 'bg-opacity-100');
                b.classList.add('bg-opacity-50');
                b.dataset.active = "false";
            });

            const activeBtn = level === 1 ? btn1 : level === 2 ? btn2 : btn3;
            activeBtn.classList.add('ring-2', 'ring-white');
            activeBtn.dataset.active = "true";

            const filtered = allQuestions.filter(q => q.niveau == level && !q.used);
            if(filtered.length === 0) {
                 list.innerHTML = `<div class="bg-gray-800/50 p-8 rounded-xl text-center border border-gray-700 border-dashed">
                    <i class="fa-solid fa-check-circle text-3xl text-gray-600 mb-2"></i>
                    <div class="text-gray-500 italic">Geen vragen meer in dit niveau.</div>
                </div>`;
                return;
            }

            // Grouping logic (simplified)
            const grouped = {};
            filtered.forEach(q => {
                if(!grouped[q.categorie]) grouped[q.categorie] = [];
                grouped[q.categorie].push(q);
            });

            for (const [cat, questions] of Object.entries(grouped)) {
                list.innerHTML += `<div class="cat-header">${cat}</div>`;
                questions.forEach(q => {
                    const div = document.createElement('div');
                    div.className = "bg-gray-700 p-3 rounded border border-gray-600 cursor-pointer hover:border-blue-400 mt-2";
                    div.onclick = () => askQuestion(q.id);
                    div.innerHTML = `<div class="text-xs font-bold text-gray-400 uppercase">${q.categorie}</div><div class="text-sm font-bold text-gray-200">${q.vraag}</div>`;
                    list.appendChild(div);
                });
            }
        };

        window.askQuestion = (qid) => {
            if(gameState.status !== 'idle') return alert("Wacht tot de hiders geantwoord hebben!");
            if(!confirm("Vraag stellen?")) return;
            const index = allQuestions.findIndex(q => q.id == qid);
            
            const updates = {};
            updates[`lobbies/${currentLobby}/questions/${index}/used`] = true;
            updates[`lobbies/${currentLobby}/status`] = 'answering';
            updates[`lobbies/${currentLobby}/activeQuestion`] = qid;
            updates[`lobbies/${currentLobby}/timerStart`] = Date.now();
            update(ref(db), updates);
            
            push(ref(db, `lobbies/${currentLobby}/logs`), { msg: `VRAAG: ${allQuestions[index].vraag}`, time: Date.now() });
        };

        function updateLogs(logsObj) {
            const logDiv = document.getElementById('game-log');
            logDiv.innerHTML = "";
            Object.values(logsObj).sort((a,b) => b.time - a.time).forEach(l => {
                const time = new Date(l.time).toTimeString().substr(0,5);
                // Check if log contains markdown link [text](url)
                let msg = l.msg;
                const linkMatch = msg.match(/\[(.*?)\]\((.*?)\)/);
                if(linkMatch) {
                    msg = msg.replace(linkMatch[0], `<a href="${linkMatch[2]}" target="_blank" class="text-blue-400 underline">${linkMatch[1]}</a>`);
                }
                logDiv.innerHTML += `<div class="border-b border-gray-700 pb-1 mb-1"><span class="text-gray-500 text-[10px]">${time}</span> ${msg}</div>`;
            });
        }

        // Globals
        window.joinLobby = joinLobby;
        window.selectRole = selectRole;
        window.playCard = playCard;
        window.discardCard = discardCard;
        window.filterQuestions = filterQuestions;
        window.askQuestion = askQuestion;
        window.openAnswerModal = openAnswerModal;
        window.closeAnswerModal = closeAnswerModal;
        window.submitAnswer = submitAnswer;
        window.clearCurse = clearCurse; // Missing in export previously
        window.closeModal = closeModal;
        window.finishOverflow = window.finishOverflow;
    </script>
</body>
</html>
