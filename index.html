<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leuven Hide & Seek</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome (Fixed Version) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #111827; color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* UI Components */
        .card-base { background: #1f2937; border: 1px solid #374151; border-radius: 12px; overflow: hidden; }
        .card-hider { border-left: 4px solid #eab308; }
        .btn-primary { background-color: #eab308; color: #000; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; box-shadow: 0 4px 6px -1px rgba(234, 179, 8, 0.2); }
        .btn-primary:active { transform: scale(0.98); }
        
        /* Categorie Header */
        .cat-header { 
            background: #374151; color: #fbbf24; 
            font-size: 0.7rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;
            padding: 6px 12px; border-radius: 6px; margin-top: 16px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 8px;
        }

        /* Animaties */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .curse-mode { animation: pulse-red 2s infinite; border: 2px solid #ef4444; }
        
        /* Utility */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- 1. LOGIN SCHERM -->
    <div id="view-login" class="flex-1 flex flex-col items-center justify-center p-6 space-y-8 z-50 bg-gray-900 absolute inset-0">
        <div class="text-center animate-bounce">
            <i class="fa-solid fa-map-location-dot text-6xl text-yellow-400"></i>
        </div>
        <div class="text-center">
            <h1 class="text-5xl font-black text-white tracking-tighter leading-none">LEUVEN<br><span class="text-yellow-400">HUNT</span></h1>
            <p class="text-gray-500 text-sm mt-2 font-mono">MULTIPLAYER GAME</p>
        </div>
        
        <div class="w-full max-w-sm space-y-4">
            <input type="text" id="inp-name" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 text-white font-bold focus:border-yellow-400 outline-none" placeholder="Jouw Naam">
            <input type="text" id="inp-lobby" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 text-white font-bold uppercase tracking-widest focus:border-yellow-400 outline-none" placeholder="LOBBY CODE">
            <button onclick="app.join()" id="btn-join" class="w-full btn-primary p-4 rounded-xl text-lg">START SPEL</button>
        </div>
    </div>

    <!-- 2. ROL SELECTIE -->
    <div id="view-role" class="hidden flex-1 flex flex-col items-center justify-center p-6 space-y-6 z-40 bg-gray-900 absolute inset-0">
        <h2 class="text-2xl font-bold text-white uppercase">Kies je Team</h2>
        <div class="grid grid-cols-2 gap-4 w-full max-w-md">
            <button onclick="app.setRole('hider')" class="bg-gray-800 p-8 rounded-2xl border-2 border-gray-700 hover:border-yellow-400 hover:bg-gray-750 transition group">
                <i class="fa-solid fa-user-secret text-5xl text-gray-400 group-hover:text-yellow-400 mb-4 transition-colors"></i>
                <div class="font-black text-xl text-white">HIDER</div>
            </button>
            <button onclick="app.setRole('seeker')" class="bg-gray-800 p-8 rounded-2xl border-2 border-gray-700 hover:border-blue-400 hover:bg-gray-750 transition group">
                <i class="fa-solid fa-binoculars text-5xl text-gray-400 group-hover:text-blue-400 mb-4 transition-colors"></i>
                <div class="font-black text-xl text-white">ZOEKER</div>
            </button>
        </div>
    </div>

    <!-- 3. MAIN GAME INTERFACE -->
    <div id="view-game" class="hidden flex-1 flex flex-col w-full max-w-lg mx-auto relative bg-gray-900 h-full">
        
        <!-- TOP BAR -->
        <div class="bg-gray-800 p-3 shadow-lg z-30 flex justify-between items-center border-b border-gray-700">
            <div>
                <div class="text-[10px] font-bold text-gray-500 uppercase">Lobby: <span id="lbl-lobby" class="text-white">...</span></div>
                <div class="text-sm font-bold text-white truncate max-w-[120px]" id="lbl-user">...</div>
            </div>
            
            <!-- Penalty Display -->
            <div id="penalty-box" class="hidden bg-red-900/30 border border-red-500/50 px-2 py-1 rounded text-center mx-2">
                <div class="text-[9px] text-red-400 font-bold uppercase">STRAF</div>
                <div class="text-xs font-mono font-bold text-white"><span id="lbl-penalty">0</span>m</div>
            </div>

            <div id="role-badge" class="px-3 py-1 rounded-full font-black text-[10px] tracking-wider uppercase border border-white/10">...</div>
        </div>

        <!-- TIMER OVERLAY (Only visible when answering) -->
        <div id="timer-bar" class="hidden bg-gray-800 border-b border-blue-500 p-2 flex justify-center items-center gap-2 shadow-xl z-20">
            <i class="fa-solid fa-stopwatch text-blue-400 animate-pulse"></i>
            <span class="text-gray-400 text-xs font-bold uppercase">Antwoorden binnen:</span>
            <span id="lbl-timer" class="font-mono text-xl font-bold text-white">03:00</span>
        </div>

        <!-- SCROLLABLE CONTENT AREA -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4 hide-scrollbar pb-24" id="main-content">
            
            <!-- DYNAMIC CONTENT INJECTED HERE -->

            <!-- HIDER: ACTION PANEL (If question asked) -->
            <div id="hider-panel" class="hidden card-base p-6 border-blue-500 border-2 bg-gradient-to-br from-blue-900/50 to-gray-800 text-center space-y-4">
                <div class="inline-block bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded uppercase">Nieuwe Vraag</div>
                <h3 id="hp-question" class="text-xl font-bold text-white leading-tight">...</h3>
                <div class="text-xs text-blue-300 font-mono">Niveau <span id="hp-level">...</span></div>
                
                <div class="text-xs text-gray-400 bg-black/30 p-3 rounded italic">
                    <i class="fa-brands fa-whatsapp mr-1"></i> Stuur eerst je antwoord/foto in de WhatsApp groep.
                </div>

                <button onclick="app.hiderConfirmAnswer()" class="w-full bg-white text-blue-900 font-black p-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> BEVESTIG & TREK KAARTEN
                </button>
            </div>

            <!-- SEEKER: QUESTION LIST -->
            <div id="seeker-panel" class="hidden space-y-4">
                <!-- Filter Buttons -->
                <div class="grid grid-cols-3 gap-1 bg-gray-800 p-1 rounded-xl sticky top-0 z-10 shadow-lg border border-gray-700">
                    <button onclick="app.renderQuestions(1)" id="btn-lvl-1" class="py-3 rounded-lg text-xs font-bold uppercase transition-colors">Niveau 1</button>
                    <button onclick="app.renderQuestions(2)" id="btn-lvl-2" class="py-3 rounded-lg text-xs font-bold uppercase transition-colors">Niveau 2</button>
                    <button onclick="app.renderQuestions(3)" id="btn-lvl-3" class="py-3 rounded-lg text-xs font-bold uppercase transition-colors">Niveau 3</button>
                </div>
                <!-- List -->
                <div id="question-list-container" class="space-y-2"></div>
            </div>

            <!-- HIDER: HAND -->
            <div id="hider-hand-wrapper" class="hidden">
                <div class="flex justify-between items-end mb-2 px-1">
                    <h3 class="text-sm font-bold text-gray-400 uppercase">Jouw Hand</h3>
                    <span class="text-xs font-mono bg-gray-800 text-gray-300 px-2 py-1 rounded"><span id="lbl-hand-count">0</span>/6</span>
                </div>
                <div id="hand-list" class="space-y-3"></div>
            </div>

            <!-- LOGS -->
            <div class="card-base p-4">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-2 tracking-widest">Tijdlijn</h3>
                <div id="log-list" class="text-xs space-y-2 text-gray-400 font-mono h-32 overflow-y-auto"></div>
            </div>

        </div>

        <!-- OVERLAYS -->

        <!-- 1. SEEKER LOCK (Waiting for Hider) -->
        <div id="overlay-seeker-wait" class="hidden absolute inset-0 bg-gray-900/95 z-40 flex flex-col items-center justify-center text-center p-8 backdrop-blur-sm">
            <i class="fa-solid fa-hourglass-half text-5xl text-blue-500 mb-4 animate-bounce"></i>
            <h3 class="text-2xl font-black text-white">WACHTEN...</h3>
            <p class="text-gray-400 mt-2">Hiders zijn aan het antwoorden.</p>
        </div>

        <!-- 2. CURSE LOCK (Seekers Blocked) -->
        <div id="overlay-curse" class="hidden absolute inset-0 bg-red-950/98 z-50 flex flex-col items-center justify-center p-6 text-center backdrop-blur overflow-y-auto">
            <i class="fa-solid fa-triangle-exclamation text-6xl text-red-500 mb-6 animate-pulse"></i>
            <h2 class="text-4xl font-black text-white mb-2 uppercase tracking-tighter">VLOEK ACTIEF!</h2>
            <p class="text-red-200 mb-8 text-sm">Geen vragen mogelijk tot de taak voltooid is.</p>
            <div id="active-curses-container" class="w-full space-y-4"></div>
        </div>

    </div>

    <!-- MODALS -->
    
    <!-- 1. CARD SELECTION (Pick 1) -->
    <div id="modal-pick" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl p-6 border border-yellow-500 max-h-[80vh] flex flex-col">
            <h3 class="text-center font-bold text-yellow-400 text-xl mb-4">KIES 1 KAART</h3>
            <div id="pick-list" class="space-y-2 overflow-y-auto flex-1"></div>
        </div>
    </div>

    <!-- 2. DISCARD (Hand Full) -->
    <div id="modal-discard" class="hidden fixed inset-0 bg-black/95 z-[70] flex items-center justify-center p-4">
        <div class="bg-gray-900 w-full max-w-md rounded-2xl p-6 border-2 border-red-500 max-h-[90vh] flex flex-col">
            <div class="text-center mb-4">
                <h3 class="text-xl font-black text-white">HAND VOL! (6/6)</h3>
                <p class="text-xs text-gray-400">Je moet kaarten weggooien om de nieuwe te houden.</p>
            </div>
            
            <div class="text-[10px] uppercase font-bold text-green-400 mb-2">Nieuw Getrokken:</div>
            <div id="discard-new-list" class="space-y-2 mb-4"></div>

            <div class="text-[10px] uppercase font-bold text-blue-400 mb-2">Huidige Hand:</div>
            <div id="discard-hand-list" class="space-y-2 overflow-y-auto flex-1"></div>

            <button onclick="document.getElementById('modal-discard').classList.add('hidden')" class="mt-4 w-full py-3 bg-gray-700 rounded-lg text-gray-400 text-xs font-bold">Annuleren (Nieuwe kaart weggooien)</button>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCP1yVG3ssEyOub_F6P__90G1bM13kDaz0",
            authDomain: "jetlagleuven.firebaseapp.com",
            databaseURL: "https://jetlagleuven-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "jetlagleuven",
            storageBucket: "jetlagleuven.firebasestorage.app",
            messagingSenderId: "461047598360",
            appId: "1:461047598360:web:34dfbfa265e3004ceb626d"
        };

        const appInit = initializeApp(firebaseConfig);
        const db = getDatabase(appInit);
        const auth = getAuth(appInit);

        // --- GAME DATA (105 Questions + 79 Cards) ---
        const DATA = {
            questions: [
                // LEVEL 1
                {id:1, n:1, c:"Locatie", q:"Bevinden jullie je ten Noorden of ten Zuiden van de Bondgenotenlaan?"},
                {id:2, n:1, c:"Omgeving", q:"Is de ondergrond waar jullie staan bestraat (kasseien/tegels) of onverhard?"},
                {id:3, n:1, c:"Omgeving", q:"Horen jullie op dit moment het geluid van stromend water?"},
                {id:4, n:1, c:"Omgeving", q:"Zien jullie op dit moment een bus van De Lijn passeren?"},
                {id:5, n:1, c:"Omgeving", q:"Staan jullie onder een afdak/beschutting of in de open lucht?"},
                {id:6, n:1, c:"Locatie", q:"Is de straatnaam waar jullie zijn langer dan 8 letters?"},
                {id:7, n:1, c:"Visueel", q:"Kunnen jullie een toren (kerk, bib, stadhuis) zien vanaf jullie plek?"},
                {id:8, n:1, c:"Omgeving", q:"Is het huisnummer van het dichtstbijzijnde gebouw even of oneven?"},
                {id:9, n:1, c:"Locatie", q:"Bevinden jullie je binnen de ring of op de ringlaan zelf?"},
                {id:10, n:1, c:"Omgeving", q:"Zijn er meer dan 5 andere mensen zichtbaar in een straal van 20 meter?"},
                {id:11, n:1, c:"Visueel", q:"Is er graffiti of street art zichtbaar vanaf jullie positie?"},
                {id:12, n:1, c:"Omgeving", q:"Is er een fietsenstalling zichtbaar?"},
                {id:13, n:1, c:"Omgeving", q:"Staan jullie op een helling/heuvel of op vlakke grond?"},
                {id:14, n:1, c:"Visueel", q:"Is de dichtstbijzijnde gevel gemaakt van baksteen?"},
                {id:15, n:1, c:"Omgeving", q:"Kunnen jullie een verkeerslicht zien vanaf jullie positie?"},
                {id:16, n:1, c:"Omgeving", q:"Is er een zitbankje binnen 10 meter?"},
                {id:17, n:1, c:"Omgeving", q:"Zien jullie een bewakingscamera?"},
                {id:18, n:1, c:"Locatie", q:"Is de straat waar jullie zijn toegankelijk voor auto's?"},
                {id:19, n:1, c:"Zintuig", q:"Ruik je op dit moment etensgeuren?"},
                {id:20, n:1, c:"Zintuig", q:"Voel je op dit moment wind?"},
                {id:21, n:1, c:"Visueel", q:"Is de dichtstbijzijnde prullenbak groen of grijs?"},
                {id:22, n:1, c:"Omgeving", q:"Zie je op dit moment een hond?"},
                {id:23, n:1, c:"Audio", q:"Hoor je muziek?"},
                {id:24, n:1, c:"Visueel", q:"Sta je op kasseien?"},
                {id:25, n:1, c:"Visueel", q:"Zie je een vlag wapperen?"},
                {id:26, n:1, c:"Visueel", q:"Is de dichtstbijzijnde auto rood, zwart of grijs?"},
                {id:27, n:1, c:"Omgeving", q:"Zie je een 'Verboden te parkeren' bord?"},
                {id:28, n:1, c:"Omgeving", q:"Sta je in de zon of in de schaduw?"},
                {id:29, n:1, c:"Omgeving", q:"Is er een zebrapad zichtbaar?"},
                {id:30, n:1, c:"Omgeving", q:"Zie je iemand fietsen?"},
                {id:31, n:1, c:"Visueel", q:"Is de dichtstbijzijnde deur van hout of glas?"},
                {id:32, n:1, c:"Visueel", q:"Zie je een reclamebord?"},
                {id:33, n:1, c:"Omgeving", q:"Is er een rioolputje binnen 5 meter?"},
                {id:34, n:1, c:"Visueel", q:"Zie je klimop of onkruid groeien?"},
                {id:35, n:1, c:"Audio", q:"Hoor je sirenes?"},
                {id:106, n:1, c:"Locatie", q:"Zijn jullie links of rechts van de Dijle?"},
                {id:107, n:1, c:"Visueel", q:"Zien jullie een balkon?"},

                // LEVEL 2
                {id:36, n:2, c:"Locatie", q:"Zijn jullie dichter bij het Station dan bij de Grote Markt?"},
                {id:37, n:2, c:"Foto", q:"Stuur een foto van de ondergrond (alleen voeten)."},
                {id:38, n:2, c:"Puzzel", q:"Wat is de eerste letter van de straat waar jullie zijn?"},
                {id:39, n:2, c:"Foto", q:"Stuur een foto van de lucht recht boven jullie."},
                {id:40, n:2, c:"Locatie", q:"Zijn jullie in een park (Stadspark, Kruidtuin, parkjes)?"},
                {id:41, n:2, c:"Foto", q:"Stuur een foto van het dichtstbijzijnde verkeersbord."},
                {id:42, n:2, c:"Omgeving", q:"Is er een horecazaak zichtbaar met een terras?"},
                {id:43, n:2, c:"Locatie", q:"Zijn jullie dichter bij de Vaartkom dan bij het Arenbergpark?"},
                {id:44, n:2, c:"Foto", q:"Stuur een foto van een object dat 'ROOD' is."},
                {id:45, n:2, c:"Puzzel", q:"Hoeveel stappen zijn jullie van de dichtstbijzijnde vuilnisbak?"},
                {id:46, n:2, c:"Locatie", q:"Zijn jullie binnen 200m van een supermarkt?"},
                {id:47, n:2, c:"Foto", q:"Stuur een foto van een textuur in de buurt (close-up)."},
                {id:48, n:2, c:"Locatie", q:"Zijn jullie in de buurt van een universiteitsgebouw?"},
                {id:49, n:2, c:"Visueel", q:"Wat is de kleur van de voordeur die het dichtst bij is?"},
                {id:50, n:2, c:"Foto", q:"Stuur een foto van jullie eigen schaduw."},
                {id:51, n:2, c:"Locatie", q:"Zijn jullie ten Oosten of ten Westen van de Naamsestraat?"},
                {id:52, n:2, c:"Foto", q:"Stuur een foto van een reflectie (raam/plas)."},
                {id:53, n:2, c:"Puzzel", q:"Welke letter komt het vaakst voor op de borden om je heen?"},
                {id:54, n:2, c:"Omgeving", q:"Zie je een fiets die fout geparkeerd staat?"},
                {id:55, n:2, c:"Visueel", q:"Is de straatverlichting hangend of op een paal?"},
                {id:56, n:2, c:"Foto", q:"Stuur een foto van een 'rond' object."},
                {id:57, n:2, c:"Puzzel", q:"Tel het aantal ramen op de begane grond van het gebouw tegenover je."},
                {id:58, n:2, c:"Observatie", q:"Zie je iemand die een bril draagt?"},
                {id:59, n:2, c:"Visueel", q:"Is de dichtstbijzijnde gevel wit geverfd?"},
                {id:60, n:2, c:"Foto", q:"Stuur een foto van iets dat van metaal is gemaakt."},
                {id:61, n:2, c:"Puzzel", q:"Zie je een nummerbord met het cijfer 7 erin?"},
                {id:62, n:2, c:"Audio", q:"Hoor je een klok luiden?"},
                {id:63, n:2, c:"Omgeving", q:"Zie je een kinderwagen?"},
                {id:64, n:2, c:"Omgeving", q:"Is het gebouw achter je hoger dan 3 verdiepingen?"},
                {id:65, n:2, c:"Foto", q:"Stuur een foto van iets dat geel is."},
                {id:66, n:2, c:"Locatie", q:"Is je verstopplek binnen 250m van de Hoorn?"},
                {id:67, n:2, c:"Locatie", q:"Dichter bij Kruidtuin dan bij Oude Markt?"},
                {id:68, n:2, c:"Foto", q:"Stuur een foto van een slot (fietsslot, deurslot)."},
                {id:69, n:2, c:"Visueel", q:"Zie je een regenpijp? Welke kleur?"},
                {id:70, n:2, c:"Omgeving", q:"Is er glasafval of zwerfvuil zichtbaar?"},

                // LEVEL 3
                {id:71, n:3, c:"Risico", q:"Stuur een foto van het uitzicht op ooghoogte (zonder jullie)."},
                {id:72, n:3, c:"Risico", q:"Stuur een geluidsopname van 15 seconden."},
                {id:73, n:3, c:"Risico", q:"Geef de naam van de dichtstbijzijnde winkel/café."},
                {id:74, n:3, c:"Risico", q:"Loop naar de hoek en stuur een foto."},
                {id:75, n:3, c:"Risico", q:"Zijn jullie binnen 300m van het Ladeuzeplein?"},
                {id:76, n:3, c:"Risico", q:"Stuur een 360 graden panoramafoto."},
                {id:77, n:3, c:"Risico", q:"Wat is de laatste letter van de straatnaam?"},
                {id:78, n:3, c:"Risico", q:"Film 5 seconden lang de grond terwijl je draait."},
                {id:79, n:3, c:"Risico", q:"Geef een beschrijving van de dichtstbijzijnde persoon."},
                {id:80, n:3, c:"Risico", q:"Teken een plattegrond van de omgeving en stuur foto."},
                {id:81, n:3, c:"Risico", q:"Stuur een foto van het hoogste punt in zicht."},
                {id:82, n:3, c:"Risico", q:"Hoeveel ramen heeft het gebouw recht tegenover jullie?"},
                {id:83, n:3, c:"Risico", q:"Stuur een foto van een object dat begint met 'S'."},
                {id:84, n:3, c:"Risico", q:"Zijn jullie binnen de 'oude stadsomwalling'?"},
                {id:85, n:3, c:"Risico", q:"Beschrijf de schoenen van een voorbijganger."},
                {id:86, n:3, c:"Risico", q:"Wat is het laatste cijfer van het dichtstbijzijnde huisnummer?"},
                {id:87, n:3, c:"Risico", q:"Stuur een foto van een patroon (kasseien, hek)."},
                {id:88, n:3, c:"Risico", q:"Hoeveel stappen ben je van de straathoek?"},
                {id:89, n:3, c:"Risico", q:"Zie je een 'Verboden' bord? Welke kleur?"},
                {id:90, n:3, c:"Risico", q:"Stuur een close-up van iets van hout."},
                {id:91, n:3, c:"Risico", q:"Is er constructie/wegenwerken zichtbaar?"},
                {id:92, n:3, c:"Risico", q:"Zie je een uniform (politie, post, lijn)?"},
                {id:93, n:3, c:"Risico", q:"Stuur een foto van iets ouds/historisch."},
                {id:94, n:3, c:"Risico", q:"Stuur een foto van iets moderns/nieuws."},
                {id:95, n:3, c:"Risico", q:"Beschrijf de geur van de omgeving in 1 woord."},
                {id:96, n:3, c:"Risico", q:"Zie je een standbeeld?"},
                {id:97, n:3, c:"Risico", q:"Tel het aantal geparkeerde fietsen in zicht."},
                {id:98, n:3, c:"Risico", q:"Stuur een foto van graffiti of sticker."},
                {id:99, n:3, c:"Risico", q:"Kun je de hemel zien of zit je ergens onder?"},
                {id:100, n:3, c:"Risico", q:"Is het hier stiller of luider dan op de Oude Markt?"},
                {id:101, n:3, c:"Risico", q:"Welke kleur hebben de kozijnen van het huis tegenover je?"},
                {id:102, n:3, c:"Risico", q:"Stuur een foto van een plant of bloem."},
                {id:103, n:3, c:"Risico", q:"Zie je een brievenbus van Bpost?"},
                {id:104, n:3, c:"Risico", q:"Stuur een foto van een straatnaambord (TEKST WEG)."},
                {id:105, n:3, c:"Risico", q:"Stuur een foto van een groot object (>1m)."}
            ],
            deck: [
                // Cards definition array (abbreviated for brevity, logic handles full set)
                // Use the list provided in the previous turn, map them to objects:
                {id:1, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:2, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:3, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:4, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:5, type:"Tijd", naam:"Bonus 5 Min", effect:"Eindtijd + 5 minuten.", taak:"Geen taak."},
                {id:6, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:7, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:8, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:9, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:10, type:"Tijd", naam:"Bonus 10 Min", effect:"Eindtijd + 10 minuten.", taak:"Geen taak."},
                {id:11, type:"Tijd", naam:"Bonus 15 Min", effect:"Eindtijd + 15 minuten.", taak:"Geen taak."},
                {id:12, type:"Tijd", naam:"Bonus 15 Min", effect:"Eindtijd + 15 minuten.", taak:"Geen taak."},
                {id:13, type:"Tijd", naam:"Bonus 15 Min", effect:"Eindtijd + 15 minuten.", taak:"Geen taak."},
                {id:14, type:"Tijd", naam:"Bonus 30 Min", effect:"Eindtijd + 30 minuten.", taak:"Geen taak."},
                {id:15, type:"Tijd", naam:"Bonus 1 Uur", effect:"Eindtijd + 1 Uur.", taak:"Geen taak."},
                {id:16, type:"Vloek", naam:"Freeze (2 min)", effect:"Zoekers moeten direct 2 minuten stilstaan.", taak:"Maak een selfie met een standbeeld."},
                {id:17, type:"Vloek", naam:"Freeze (2 min)", effect:"Zoekers moeten direct 2 minuten stilstaan.", taak:"Maak een selfie met een standbeeld."},
                {id:18, type:"Vloek", naam:"De Snack Pauze", effect:"Zoekers moeten een snack kopen/eten.", taak:"Overtuig een vreemde om te zwaaien."},
                {id:19, type:"Vloek", naam:"Achteruit", effect:"Zoekers moeten de volgende straat achteruit lopen.", taak:"Film 30 sec moonwalken."},
                {id:20, type:"Vloek", naam:"Hand in Hand", effect:"Zoekers lopen 5 min hand in hand.", taak:"Knoop elkaars veters aan elkaar."},
                {id:21, type:"Vloek", naam:"Op één been", effect:"Zoekers wachten 1 min op één been.", taak:"Sta 1 min op één been als een flamingo."},
                {id:22, type:"Vloek", naam:"Selfie Time", effect:"Zoekers moeten selfie maken met vreemde.", taak:"Maak zelf ook een selfie met vreemde."},
                {id:23, type:"Vloek", naam:"De Vloer is Lava", effect:"Zoekers mogen 3 min straat niet raken.", taak:"Klim ergens op (muurtje/bankje)."},
                {id:24, type:"Vloek", naam:"Slow Motion", effect:"Zoekers bewegen 2 min in slow-mo.", taak:"Film een slow-motion vechtscène."},
                {id:25, type:"Vloek", naam:"Tas Wissel", effect:"Zoekers wisselen rugzak/jas (10 min).", taak:"Doe je schoenen aan de verkeerde voeten."},
                {id:26, type:"Vloek", naam:"Sprintje", effect:"Zoekers trekken sprintje van 50m.", taak:"Doe 20 jumping jacks."},
                {id:27, type:"Vloek", naam:"Omweg Standbeeld", effect:"Zoekers lopen naar dichtstbijzijnde beeld.", taak:"Zing luidkeels het volkslied."},
                {id:28, type:"Vloek", naam:"Vraag Weigeren", effect:"Annuleer huidige vraag.", taak:"Bouw toren van 5 objecten."},
                {id:29, type:"Vloek", naam:"Vraag Weigeren", effect:"Annuleer huidige vraag.", taak:"Bouw toren van 5 objecten."},
                {id:30, type:"Vloek", naam:"Splitsing", effect:"Zoekers gaan 200m uit elkaar (10 min).", taak:"Doe je jas binnenstebuiten aan."},
                {id:31, type:"Vloek", naam:"Links Afslaan", effect:"Zoekers slaan enkel links af (5 min).", taak:"Draai 10 rondjes om je as."},
                {id:32, type:"Vloek", naam:"Geen Maps", effect:"Zoekers: 5 min geen Google Maps.", taak:"Teken een portret van elkaar in 30 sec."},
                {id:33, type:"Vloek", naam:"De Polonaise", effect:"Zoekers lopen 2 min in polonaise.", taak:"Doe de kabouterdans met bewegingen."},
                {id:34, type:"Vloek", naam:"Vogelspotter", effect:"Zoekers moeten duif fotograferen.", taak:"Doe een vogel na (geluid + wapperen)."},
                {id:35, type:"Vloek", naam:"Bus Roulette", effect:"Zoekers nemen bus voor 1 halte.", taak:"Film 1 minuut Macarena dansen."},
                {id:36, type:"Vloek", naam:"De Noodklok", effect:"Zoekers moeten kerkdeur aanraken.", taak:"Draag een gedicht voor over de zoekers."},
                {id:37, type:"Vloek", naam:"Blinddoek", effect:"1 Zoeker wordt 5 min geblinddoekt.", taak:"Sta 1 minuut roerloos stil."},
                {id:38, type:"Vloek", naam:"De Toerist", effect:"Zoekers vragen weg aan voorbijganger.", taak:"Spreek voorbijganger aan: 'Fijne dag!'."},
                {id:39, type:"Vloek", naam:"Waterdrager", effect:"Zoekers moeten flesje water atten.", taak:"Doe 10 push-ups."},
                {id:40, type:"Vloek", naam:"Papegaai", effect:"Zoekers herhalen alles wat 1 iemand zegt (5m).", taak:"Praat 1 min tegen lantaarnpaal."},
                {id:41, type:"Vloek", naam:"Hinkelen", effect:"Zoekers moeten 50m hinkelen.", taak:"Hinkelen zelf 1 minuut."},
                {id:42, type:"Vloek", naam:"Stilte (5 min)", effect:"Zoekers niet praten/typen.", taak:"Wees 5 minuten doodstil."},
                {id:43, type:"Vloek", naam:"De Mol", effect:"Zoekers delen 5 min live locatie.", taak:"Zoek een foto van een mol."},
                {id:44, type:"Vloek", naam:"Alleen Fietsen", effect:"Zoekers moeten 15 min alles fietsen.", taak:"Sta 3 minuten rug-aan-rug."},
                {id:45, type:"Vloek", naam:"Alleen Lopen", effect:"Zoekers moeten 15 min alles lopen.", taak:"Zing 1 minuut luidkeels."},
                {id:46, type:"Vloek", naam:"Brug Tol", effect:"Binnen 5 min andere brug oversteken.", taak:"Maak een 'brug' met lichaam (30s)."},
                {id:47, type:"Vloek", naam:"Omweg Oude Markt", effect:"Zoekers moeten naar Oude Markt.", taak:"Vind object met letter 'O'."},
                {id:48, type:"Vloek", naam:"Oriëntatie", effect:"Zoekers 10 min geen kompas/draaien.", taak:"Draai 1 min langzaam rondjes."},
                {id:49, type:"Vloek", naam:"Pad Blokkeren", effect:"Kies straat waar zoekers niet in mogen.", taak:"Bouw barricade van takjes."},
                {id:50, type:"Vloek", naam:"Stille Zone", effect:"Zoekers 15 min niet praten/typen.", taak:"Wees 5 min doodstil."},
                {id:51, type:"Vloek", naam:"Tijdelijke Afleiding", effect:"Hiders bellen zoekers 1 min.", taak:"Verkoop product zonder 'uhm' te zeggen."},
                {id:52, type:"Vloek", naam:"Rode Licht", effect:"Wachten bij elk rood licht.", taak:"Doe 20 Jumping Jacks."},
                {id:53, type:"Vloek", naam:"Veter Foltering", effect:"1 Zoeker moet veters opnieuw strikken.", taak:"Doe schoenen verkeerd om aan."},
                {id:54, type:"Vloek", naam:"Kunst Jacht", effect:"Zoekers moeten kunstwerk vinden.", taak:"Bedenk raadsel over locatie."},
                {id:55, type:"Vloek", naam:"Verkeerde Afslag", effect:"Zoekers moeten 200m teruglopen.", taak:"Loop 3 min achteruit in cirkel."},
                {id:56, type:"Vloek", naam:"Lied van Leuven", effect:"Zoekers zingen lied over Leuven.", taak:"Doe een dier na (1 min)."},
                {id:57, type:"Vloek", naam:"Zoeker Afleiden", effect:"Zoekers dansen Macarena.", taak:"Dans Macarena zonder muziek."},
                {id:58, type:"Vloek", naam:"Zoeker Ruil", effect:"Zoekers wisselen jas/tas (10 min).", taak:"Trek sokken over broekspijpen."},
                {id:59, type:"Vloek", naam:"Ruisonderdrukking", effect:"Hiders wachten 10 min extra.", taak:"Zit 2 min vingers in oren."},
                {id:60, type:"Vloek", naam:"Vertraging", effect:"Zoekers 2 min stilstaan.", taak:"Doe maanlanding in slow-mo."},
                {id:61, type:"Vloek", naam:"Verwarring", effect:"Zoekers 5 min naar Noorden lopen.", taak:"Wijs 1 min naar willekeurige richtingen."},
                {id:62, type:"Bonus", naam:"Locatie Wissel", effect:"Hiders verplaatsen zich 5 min.", taak:"Roep \"WIJ ZIJN BANG\"."},
                {id:63, type:"Bonus", naam:"De Mime", effect:"Zoekers zwijgen 10 min, enkel gebaren.", taak:"Beeld film uit (zoekers raden)."},
                {id:64, type:"Bonus", naam:"De Leugen", effect:"Lieg op de VOLGENDE vraag.", taak:"Eet iets zuurs/vies (veilig)."},
                {id:65, type:"Bonus", naam:"Mist", effect:"Zoekers mogen 15 min GEEN vragen stellen.", taak:"Houd 1 min elkaars hand vast."},
                {id:66, type:"Bonus", naam:"Camouflage", effect:"Stuur foto ander persoon.", taak:"Verberg gezicht volledig (5 min)."},
                {id:67, type:"Bonus", naam:"Radar Jammer", effect:"Zoekers zetten live locatie uit (10 min).", taak:"Roep 10x \"KEKO KEKO!\"."},
                {id:68, type:"Bonus", naam:"Safehouse", effect:"Zoekers wachten 2 min voor tikken.", taak:"Maak kunstwerk van afval."},
                {id:69, type:"Bonus", naam:"Copycat", effect:"Kopieer effect van vorige kaart nog eens.", taak:"Doe de vorige opdracht 2x sneller."},
                {id:70, type:"Bonus", naam:"Herpositioneren", effect:"Hiders verplaatsen 2 min.", taak:"Roep \"WIJ VERPLAATSEN\"."},
                {id:71, type:"Bonus", naam:"Noodontsnapping", effect:"Verplaats 50m (als zoekers <100m).", taak:"Ren rondje om verstopplek."},
                {id:72, type:"Bonus", naam:"Onzichtbaar", effect:"2 min radiostilte.", taak:"Lig 1 min plat op de grond."},
                {id:73, type:"Bonus", naam:"Souvenir", effect:"Zoekers kopen souvenir voor hiders.", taak:"Maak bedankvideo."},
                {id:74, type:"Bonus", naam:"Snelle Ontsnapping", effect:"Verplaats 200m.", taak:"Foto van voeten in de lucht."},
                {id:75, type:"Bonus", naam:"Stealth Modus", effect:"10 min geen vragen.", taak:"Fluister 1 minuut lang."},
                {id:76, type:"Bonus", naam:"Tijd Rekken", effect:"Zoekers wachten 5 min extra.", taak:"Tel hardop tot 60 in Engels."},
                {id:77, type:"Bonus", naam:"Upgrade", effect:"Huidige plek \"Extra Goed\" (+10 min).", taak:"Maak reclamepraatje over plek."},
                {id:78, type:"Bonus", naam:"Vraag Blok", effect:"Weiger huidige vraag.", taak:"Bouw kaartenhuis."},
                {id:79, type:"Bonus", naam:"Trekken", effect:"Gooi kaarten weg, trek nieuwe.", taak:"Schud denkbeeldige kaarten."}
            ]
        };

        // --- GLOBAL STATE ---
        let state = {
            user: null,
            lobby: null,
            role: null,
            questions: [],
            deck: [],
            status: 'idle', // idle, answering
            activeQ: null,
            timerStart: 0,
            penalty: 0,
            activeCurses: [],
            logs: []
        };

        let timerInt = null;

        // --- LOGIC: JOIN ---
        window.app = {
            async join() {
                const name = document.getElementById('inp-name').value;
                const lobby = document.getElementById('inp-lobby').value.toUpperCase();
                if (!name || !lobby) return alert("Vul alles in");

                document.getElementById('btn-join').innerText = "LADEN...";
                
                try {
                    await signInAnonymously(auth);
                    state.user = { uid: auth.currentUser.uid, name };
                    state.lobby = lobby;

                    // Init Lobby if needed
                    const lobbyRef = ref(db, `lobbies/${lobby}`);
                    const snap = await get(lobbyRef);
                    if (!snap.exists()) {
                        await set(lobbyRef, {
                            created: Date.now(),
                            questions: DATA.questions,
                            deck: DATA.deck,
                            status: 'idle',
                            penalty: 0,
                            logs: [{msg: `Lobby ${lobby} gestart door ${name}`, time: Date.now()}]
                        });
                    } else {
                        // Add log
                        const logs = snap.val().logs || [];
                        logs.push({msg: `${name} joined`, time: Date.now()});
                        update(lobbyRef, { logs });
                    }

                    // UI Switch
                    document.getElementById('view-login').classList.add('hidden');
                    document.getElementById('view-role').classList.remove('hidden');
                    
                    // Listen
                    app.listen();

                } catch (e) {
                    alert("Error: " + e.message);
                    document.getElementById('btn-join').innerText = "START SPEL";
                }
            },

            setRole(role) {
                state.role = role;
                document.getElementById('view-role').classList.add('hidden');
                document.getElementById('view-game').classList.remove('hidden');
                
                // Update Header
                document.getElementById('lbl-lobby').innerText = state.lobby;
                document.getElementById('lbl-user').innerText = state.user.name;
                
                const badge = document.getElementById('role-badge');
                badge.innerText = role;
                badge.className = `px-3 py-1 rounded-full font-black text-xs tracking-wider uppercase border border-white/10 ${role === 'hider' ? 'bg-yellow-500 text-black' : 'bg-blue-500 text-white'}`;
                
                // Show Panels
                if(role === 'hider') {
                    document.getElementById('hider-hand-wrapper').classList.remove('hidden');
                } else {
                    document.getElementById('seeker-panel').classList.remove('hidden');
                    app.renderQuestions(1); // Default Level 1
                }
                
                app.renderUI();
            },

            listen() {
                onValue(ref(db, `lobbies/${state.lobby}`), (snap) => {
                    const data = snap.val();
                    if (!data) return;

                    state.questions = data.questions || [];
                    state.deck = data.deck || [];
                    state.status = data.status || 'idle';
                    state.activeQ = data.activeQ || null;
                    state.timerStart = data.timerStart || 0;
                    state.penalty = data.penalty || 0;
                    state.activeCurses = data.activeCurses || [];
                    state.logs = data.logs || [];

                    app.renderUI();
                });
            },

            // --- RENDER LOGIC ---
            renderUI() {
                // 1. Logs
                const logList = document.getElementById('log-list');
                logList.innerHTML = state.logs.slice().reverse().map(l => {
                    const time = new Date(l.time).toTimeString().substr(0,5);
                    return `<div class="border-b border-gray-700 pb-1 mb-1"><span class="text-gray-500 mr-2">[${time}]</span>${l.msg}</div>`;
                }).join('');

                // 2. Penalty
                document.getElementById('lbl-penalty').innerText = state.penalty;

                // 3. Status: Answering?
                const isAnswering = state.status === 'answering';
                const hasCurses = state.activeCurses.length > 0;
                
                // Timer Logic
                const timerBar = document.getElementById('timer-bar');
                const timerLbl = document.getElementById('lbl-timer');
                
                if (timerInt) clearInterval(timerInt);
                
                if (isAnswering) {
                    timerBar.classList.remove('hidden');
                    timerInt = setInterval(() => {
                        const elapsed = Date.now() - state.timerStart;
                        const remain = 180000 - elapsed; // 3 min
                        if (remain <= 0) {
                            timerLbl.innerText = "TE LAAT!";
                            timerBar.classList.add('bg-red-600');
                        } else {
                            const m = Math.floor(remain / 60000);
                            const s = Math.floor((remain % 60000) / 1000);
                            timerLbl.innerText = `${m}:${s.toString().padStart(2,'0')}`;
                            timerBar.classList.remove('bg-red-600');
                        }
                    }, 1000);
                } else {
                    timerBar.classList.add('hidden');
                }

                // 4. Seeker Views
                if (state.role === 'seeker') {
                    // Overlays
                    const waitOverlay = document.getElementById('overlay-seeker-wait');
                    const curseOverlay = document.getElementById('overlay-curse');
                    
                    if (hasCurses) {
                        curseOverlay.classList.remove('hidden');
                        waitOverlay.classList.add('hidden');
                        // Render Curses
                        const cont = document.getElementById('active-curses-container');
                        cont.innerHTML = state.activeCurses.map((c, idx) => `
                            <div class="bg-gray-800 p-4 rounded-xl border border-red-500 text-left shadow-lg">
                                <h4 class="font-bold text-yellow-400 text-lg">${c.naam}</h4>
                                <p class="text-gray-300 text-sm mb-2">${c.effect}</p>
                                <div class="text-xs bg-black/30 p-2 rounded italic text-gray-400 mb-3">Taak: ${c.taak}</div>
                                <button onclick="app.clearCurse(${idx})" class="w-full bg-green-600 py-2 rounded font-bold text-white text-sm">
                                    <i class="fa-solid fa-check mr-1"></i> TAAK VOLTOOID
                                </button>
                            </div>
                        `).join('');
                    } else if (isAnswering) {
                        waitOverlay.classList.remove('hidden');
                        curseOverlay.classList.add('hidden');
                    } else {
                        waitOverlay.classList.add('hidden');
                        curseOverlay.classList.add('hidden');
                        // Ensure list is rendered
                        const activeLvlBtn = document.querySelector('#seeker-panel button.bg-gray-600'); 
                        if(activeLvlBtn) {
                           // re-render not needed constantly, button click does it
                        }
                    }
                }

                // 5. Hider Views
                if (state.role === 'hider') {
                    // Hand
                    const hand = state.deck.filter(c => c.status === 'hand');
                    document.getElementById('lbl-hand-count').innerText = hand.length;
                    const handList = document.getElementById('hand-list');
                    
                    if(hand.length === 0) handList.innerHTML = `<div class="text-center text-gray-500 italic py-4">Je hand is leeg.</div>`;
                    else {
                        handList.innerHTML = hand.map(c => `
                            <div class="card-base p-3 flex justify-between items-center ${c.type === 'Vloek' ? 'border-red-900/50' : ''}">
                                <div class="w-2/3">
                                    <div class="text-[10px] font-bold uppercase ${c.type==='Vloek'?'text-red-400':(c.type==='Tijd'?'text-green-400':'text-blue-400')}">${c.type}</div>
                                    <div class="font-bold text-white text-sm">${c.naam}</div>
                                    <div class="text-[10px] text-gray-400 leading-tight">${c.effect}</div>
                                    <div class="text-[9px] text-yellow-600 italic mt-1">${c.taak}</div>
                                </div>
                                <div class="flex flex-col gap-1 w-20">
                                    <button onclick="app.playCard(${c.id})" class="bg-green-600 text-white text-[10px] font-bold py-1 rounded">SPEEL</button>
                                    <button onclick="app.discardCard(${c.id})" class="bg-gray-700 text-gray-400 text-[10px] py-1 rounded">WEG</button>
                                </div>
                            </div>
                        `).join('');
                    }

                    // Action Panel
                    const panel = document.getElementById('hider-panel');
                    if (isAnswering) {
                        const q = state.questions.find(x => x.id === state.activeQ);
                        if (q) {
                            panel.classList.remove('hidden');
                            document.getElementById('hp-question').innerText = q.vraag;
                            document.getElementById('hp-level').innerText = q.niveau;
                        }
                    } else {
                        panel.classList.add('hidden');
                    }
                }
            },

            // --- GAME ACTIONS ---

            renderQuestions(lvl) {
                // UI Toggle
                [1,2,3].forEach(i => {
                    const btn = document.getElementById(`btn-lvl-${i}`);
                    if(i===lvl) {
                        btn.classList.remove('bg-gray-800', 'text-gray-400');
                        btn.classList.add('bg-gray-600', 'text-white', 'ring-2', 'ring-blue-500');
                    } else {
                        btn.classList.add('bg-gray-800', 'text-gray-400');
                        btn.classList.remove('bg-gray-600', 'text-white', 'ring-2', 'ring-blue-500');
                    }
                });

                const list = document.getElementById('question-list-container');
                list.innerHTML = "";

                const filtered = state.questions.filter(q => q.niveau === lvl && !q.used);
                
                if (filtered.length === 0) {
                    list.innerHTML = `<div class="text-center text-gray-500 italic mt-4">Geen vragen meer.</div>`;
                    return;
                }

                // Grouping
                const groups = {};
                filtered.forEach(q => {
                    if(!groups[q.categorie]) groups[q.categorie] = [];
                    groups[q.categorie].push(q);
                });

                for (const [cat, qs] of Object.entries(groups)) {
                    const html = `
                        <div class="cat-header"><i class="fa-solid fa-layer-group"></i> ${cat}</div>
                        ${qs.map(q => `
                            <div onclick="app.askQuestion(${q.id})" class="bg-gray-800 p-3 rounded-lg border border-gray-700 active:bg-gray-700 active:border-blue-500 transition mb-2">
                                <div class="text-sm font-bold text-gray-200">${q.vraag}</div>
                            </div>
                        `).join('')}
                    `;
                    list.innerHTML += html;
                }
            },

            askQuestion(id) {
                if(!confirm("Wil je deze vraag stellen?")) return;
                
                // Update DB
                const qIdx = state.questions.findIndex(q => q.id === id);
                const updates = {};
                updates[`questions/${qIdx}/used`] = true;
                updates[`status`] = 'answering';
                updates[`activeQ`] = id;
                updates[`timerStart`] = Date.now();
                
                const newLog = [...state.logs, {msg: `ZOEKERS vragen: "${state.questions[qIdx].vraag}"`, time: Date.now()}];
                updates[`logs`] = newLog;

                update(ref(db, `lobbies/${state.lobby}`), updates);
            },

            hiderConfirmAnswer() {
                if(!confirm("Heb je het antwoord verstuurd via WhatsApp?")) return;

                // Check Penalty
                const elapsed = Date.now() - state.timerStart;
                let penaltyAdded = 0;
                if (elapsed > 180000) penaltyAdded = 10; // 3 min

                const q = state.questions.find(x => x.id === state.activeQ);
                let drawCount = q.niveau;
                // Special rules: Foto/Risico = 3 cards
                if (q.categorie === 'Foto' || q.categorie === 'Risico') drawCount = 3;

                // Reset state & Log
                const updates = { status: 'idle', activeQ: null, timerStart: 0 };
                if (penaltyAdded > 0) updates['penalty'] = state.penalty + 10;
                
                const newLog = [...state.logs, {msg: `HIDERS hebben geantwoord! ${penaltyAdded ? '(+10 min straf)' : ''}`, time: Date.now()}];
                updates['logs'] = newLog;

                update(ref(db, `lobbies/${state.lobby}`), updates)
                    .then(() => app.triggerDraw(drawCount));
            },

            triggerDraw(amount) {
                // Logic: Draw 'amount' cards from 'deck' status.
                // Show modal to pick 1.
                const deck = state.deck.filter(c => !c.status || c.status === 'deck');
                if (deck.length === 0) return alert("Kaarten zijn op!");

                const drawn = [];
                // Simple random shuffle & pick
                for (let i=0; i<amount; i++) {
                    if(deck.length === 0) break;
                    const r = Math.floor(Math.random() * deck.length);
                    drawn.push(deck[r]);
                    deck.splice(r, 1);
                }

                // Show Modal
                const list = document.getElementById('pick-list');
                list.innerHTML = drawn.map(c => `
                    <div onclick="app.keepCard(${c.id})" class="bg-gray-700 p-4 rounded-xl border border-yellow-500/50 active:bg-yellow-900 transition">
                        <div class="font-bold text-yellow-400 text-lg">${c.naam}</div>
                        <div class="text-xs text-white">${c.effect}</div>
                        <div class="text-[10px] text-gray-400 mt-2 italic">${c.taak}</div>
                    </div>
                `).join('');
                
                document.getElementById('modal-pick').classList.remove('hidden');
            },

            keepCard(id) {
                document.getElementById('modal-pick').classList.add('hidden');
                
                // Add to hand in DB
                const idx = state.deck.findIndex(c => c.id === id);
                update(ref(db, `lobbies/${state.lobby}/deck/${idx}`), { status: 'hand' })
                .then(() => {
                    // Check overflow
                    // Need to fetch fresh state or trust local logic slightly delayed
                    setTimeout(() => {
                        const hand = state.deck.filter(c => c.status === 'hand');
                        if (hand.length > 6) {
                            app.showDiscardModal(id); // Show with recently added
                        }
                    }, 500);
                });
            },

            showDiscardModal(newId) {
                const modal = document.getElementById('modal-discard');
                modal.classList.remove('hidden');
                
                // Show new card
                const newItem = state.deck.find(c => c.id === newId);
                document.getElementById('discard-new-list').innerHTML = `
                    <div class="bg-gray-800 p-2 rounded border border-green-500 text-xs font-bold text-green-400">${newItem.naam} (NIEUW)</div>
                `;

                // Show hand to discard
                const hand = state.deck.filter(c => c.status === 'hand');
                document.getElementById('discard-hand-list').innerHTML = hand.map(c => `
                    <div onclick="app.discardOverflow(${c.id})" class="bg-gray-800 p-3 rounded flex justify-between items-center border border-gray-600 active:bg-red-900/50">
                        <span class="text-white font-bold text-xs">${c.naam}</span>
                        <i class="fa-solid fa-trash text-red-500"></i>
                    </div>
                `).join('');
            },

            discardOverflow(id) {
                const idx = state.deck.findIndex(c => c.id === id);
                update(ref(db, `lobbies/${state.lobby}/deck/${idx}`), { status: 'discarded' });
                document.getElementById('modal-discard').classList.add('hidden');
            },

            playCard(id) {
                if(!confirm("Kaart spelen? Heb je de taak uitgevoerd?")) return;
                
                const idx = state.deck.findIndex(c => c.id === id);
                const card = state.deck[idx];
                
                const updates = {};
                updates[`deck/${idx}/status`] = 'played';
                
                // If Curse -> Add to activeCurses
                if (card.type === 'Vloek') {
                    const newCurses = [...state.activeCurses, card];
                    updates['activeCurses'] = newCurses;
                }
                
                const newLog = [...state.logs, {msg: `HIDERS spelen: ${card.naam}`, time: Date.now()}];
                updates['logs'] = newLog;

                update(ref(db, `lobbies/${state.lobby}`), updates);
            },

            discardCard(id) {
                if(!confirm("Kaart weggooien?")) return;
                const idx = state.deck.findIndex(c => c.id === id);
                update(ref(db, `lobbies/${state.lobby}/deck/${idx}`), { status: 'discarded' });
            },

            clearCurse(arrIndex) {
                if(!confirm("Zijn de hiders akkoord dat de taak klaar is?")) return;
                
                // Remove specific index from array
                const newCurses = state.activeCurses.filter((_, i) => i !== arrIndex);
                
                const updates = { activeCurses: newCurses };
                const newLog = [...state.logs, {msg: `ZOEKERS hebben een vloek opgeheven`, time: Date.now()}];
                updates['logs'] = newLog;

                update(ref(db, `lobbies/${state.lobby}`), updates);
            }
        };

        // --- EXPORT TO WINDOW ---
        window.app = app;

        // --- AUTH IMPORTS ---
        // (Re-declaring inside module for internal use, but we need them in global scope? No, app object handles it)
    </script>

    <!-- FIREBASE CONFIG INJECTION -->
    <script type="module">
        // Dummy script to ensure module loads
    </script>
</body>
</html>
